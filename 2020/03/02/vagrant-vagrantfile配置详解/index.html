<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>vagrantfile配置详解 | WangYangYang</title><meta name="description" content="vagrantfile配置详解"><meta name="keywords" content="vagrant"><meta name="author" content="Wang YangYang"><meta name="copyright" content="Wang YangYang"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="vagrantfile配置详解"><meta name="twitter:description" content="vagrantfile配置详解"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/vagrant/f8aa204e5d67627eb9bb812ae761cb8f.jpg"><meta property="og:type" content="article"><meta property="og:title" content="vagrantfile配置详解"><meta property="og:url" content="http://wangyangyangisme.github.io/2020/03/02/vagrant-vagrantfile%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"><meta property="og:site_name" content="WangYangYang"><meta property="og:description" content="vagrantfile配置详解"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/vagrant/f8aa204e5d67627eb9bb812ae761cb8f.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://wangyangyangisme.github.io/2020/03/02/vagrant-vagrantfile%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"><link rel="prev" title="Drone+Gitea自动化部署" href="http://wangyangyangisme.github.io/2020/03/12/CICD-Drone+Gitea%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"><link rel="next" title="Vagrant搭建虚拟环境" href="http://wangyangyangisme.github.io/2020/03/02/vagrant-Vagrant%E6%90%AD%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"C4QN4OTLJM","apiKey":"c2c026ba64eeb77abd2164975fa41f34","indexName":"wyy","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://wangyangyangisme.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">194</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">39</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#vagrantfile配置详解"><span class="toc-text">vagrantfile配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、简介"><span class="toc-text">1、简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、Vagrantfile文件"><span class="toc-text">2、Vagrantfile文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、-配置详解"><span class="toc-text">3、 配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1、box设置"><span class="toc-text">3.1、box设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2、hostname设置"><span class="toc-text">3.2、hostname设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3、虚拟机网络设置"><span class="toc-text">3.3、虚拟机网络设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4、同步目录设置"><span class="toc-text">3.4、同步目录设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5、端口转发设置"><span class="toc-text">3.5、端口转发设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6、定义vm的configure配置节点"><span class="toc-text">3.6、定义vm的configure配置节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7、通用数据-设置一些基础数据，供配置信息中调用。"><span class="toc-text">3.7、通用数据 设置一些基础数据，供配置信息中调用。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8、配置信息"><span class="toc-text">3.8、配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9、vm提供者配置"><span class="toc-text">3.9、vm提供者配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-10、一组相同配置的vm"><span class="toc-text">3.10、一组相同配置的vm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11、provision任务"><span class="toc-text">3.11、provision任务</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/vagrant/f8aa204e5d67627eb9bb812ae761cb8f.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">WangYangYang</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">vagrantfile配置详解</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-02<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-03-02</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/vagrant/">vagrant</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">2.9k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 10 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/03/02/vagrant-vagrantfile%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/03/02/vagrant-vagrantfile%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="vagrantfile配置详解"><a href="#vagrantfile配置详解" class="headerlink" title="vagrantfile配置详解"></a>vagrantfile配置详解</h1><h2 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h2><p>在我们的工作目录下有一个Vagrantfile文件，里面包含有大量的配置信息，通过它可以定义虚拟机的各种配置，如网络、内存、主机名等，主要包括三个方面的配置，虚拟机的配置、SSH配置、Vagrant的一些基础配置。Vagrant是使用Ruby开发的，所以它的配置语法也是Ruby的，每个项目都需要有一个Vagrantfile，在执行vagrant init的目录下可以找到该文件</p>
<h2 id="2、Vagrantfile文件"><a href="#2、Vagrantfile文件" class="headerlink" title="2、Vagrantfile文件"></a>2、Vagrantfile文件</h2><p>Vagrantfile中有两行配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure("2") do |config|</span><br><span class="line">config.vm.box = "centos7"</span><br></pre></td></tr></table></figure>
<p>这两行就是我们在vagrant init中后面所指定的参数。由此可以看出，vagrant init只是帮我们生成了配置文件而已，换句话说，如果我们写好了Vagrantfile，就不需要vagrant init，只需将准备好的配置文件放入到所需目录中，然后直接执行vagrant up即可。</p>
<p>还有很多注释掉的配置，那些都是一些常用的配置，包括网卡设置、IP地址、绑定目录，甚至可以指定内存大小、CPU个数、是否启动界面等等。如果需要，可以根据注释文本进行配置。</p>
<h2 id="3、-配置详解"><a href="#3、-配置详解" class="headerlink" title="3、 配置详解"></a>3、 配置详解</h2><p>下面是一些常用的配置：</p>
<ul>
<li><strong>config.vm.hostname</strong>：配置虚拟机主机名</li>
<li><strong>config.vm.network</strong>：这是配置虚拟机网络</li>
<li><strong>config.vm.synced_folder</strong>：除了默认的目录绑定外，还可以手动指定绑定</li>
<li><strong>config.ssh.username</strong>：默认的用户是vagrant，从官方下载的box往往使用的是这个用户名。如果是自定制的box，所使用的用户名可能会有所不同，通过这个配置设定所用的用户名。</li>
<li><strong>config.vm.provision</strong>：我们可以通过这个配置在虚拟机第一次启动的时候进行一些安装配置</li>
</ul>
<p>需要注意的是，Vagrantfile文件只会在第一次执行vagrant up时调用执行，之后如果不使用<code>vagrant reload</code>进行重新加载，则不会被强制重新加载。</p>
<h3 id="3-1、box设置"><a href="#3-1、box设置" class="headerlink" title="3.1、box设置"></a>3.1、box设置</h3><p><strong>config.vm.box</strong> = “centos7”</p>
<p>该名称是再使用 vagrant init 中后面跟的名字。</p>
<h3 id="3-2、hostname设置"><a href="#3-2、hostname设置" class="headerlink" title="3.2、hostname设置"></a>3.2、hostname设置</h3><p><strong>config.vm.hostname</strong> = “node1”<br>设置hostname非常重要，因为当我们有很多台虚拟服务器的时候，都是依靠hostname來做识别的。比如，我安装了centos1,centos2 两台虚拟机，再启动时，我可以通过vagrant up centos1来指定只启动哪一台。</p>
<h3 id="3-3、虚拟机网络设置"><a href="#3-3、虚拟机网络设置" class="headerlink" title="3.3、虚拟机网络设置"></a>3.3、虚拟机网络设置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Host-only模式</span></span><br><span class="line">config.vm.network "private_network", ip: "192.168.10.11"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Bridge模式</span></span><br><span class="line">config.vm.network "public_network", ip: "10.1.2.61"</span><br></pre></td></tr></table></figure>
<p>Vagrant的网络连接方式有三种：</p>
<ul>
<li><p><strong>NAT</strong> : 缺省创建，用于让vm可以通过host转发访问局域网甚至互联网。</p>
</li>
<li><p><strong>host-only</strong> : 只有主机可以访问vm，其他机器无法访问它。</p>
</li>
<li><p><strong>bridge</strong> : 此模式下vm就像局域网中的一台独立的机器，可以被其他机器访问。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置当前vm的host-only网络的IP地址为192.168.33.10</span></span><br><span class="line">config.vm.network :private_network, ip: "192.168.33.10"</span><br></pre></td></tr></table></figure>

<p>host-only 模式的IP可以不指定，而是采用dhcp自动生成的方式，如 :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建一个bridge桥接网络，指定IP</span></span><br><span class="line">config.vm.network "private_network", type: "dhcp”</span><br><span class="line"><span class="meta">#</span><span class="bash">config.vm.network <span class="string">"public_network"</span>, ip: <span class="string">"192.168.0.17"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">创建一个bridge桥接网络，指定桥接适配器</span></span><br><span class="line"><span class="meta">#</span><span class="bash">config.vm.network <span class="string">"public_network"</span>, bridge: <span class="string">"en1: Wi-Fi (AirPort)"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">创建一个bridge桥接网络，不指定桥接适配器</span></span><br><span class="line">config.vm.network "public_network"</span><br></pre></td></tr></table></figure>

<h3 id="3-4、同步目录设置"><a href="#3-4、同步目录设置" class="headerlink" title="3.4、同步目录设置"></a>3.4、同步目录设置</h3><p><strong>config.vm.synced_folder</strong>  “D:/xxx/code”, “/home/www/“<br>前面的路径(D:/xxx/code)是本机代码的地址，后面的地址就是虚拟机的目录。虚拟机的/vagrant目录默认挂载宿主机的开发目录(可以在进入虚拟机机后，使用df -h 查看)，这是在虚拟机启动时自动挂载的。我们还可以设置额外的共享目录，上面这个设定，第一个参数是宿主机的目录，第二个参数是虚拟机挂载的目录。</p>
<h3 id="3-5、端口转发设置"><a href="#3-5、端口转发设置" class="headerlink" title="3.5、端口转发设置"></a>3.5、端口转发设置</h3><p><strong>config.vm.network</strong>  :forwarded_port, guest: 80, host: 8080<br>上面的配置把宿主机上的8080端口映射到客户虚拟机的80端口，例如你在虚拟机上使用nginx跑了一个Go应用，那么你在host上的浏览器中打开<a href="http://localhost:8080时，Vagrant就会把这个请求转发到虚拟机里跑在80端口的nginx服务上。不建议使用该方法，因为涉及端口占用问题，常常导致应用之间不能正常通信，建议使用Host-only和Bridge方式进行设置。">http://localhost:8080时，Vagrant就会把这个请求转发到虚拟机里跑在80端口的nginx服务上。不建议使用该方法，因为涉及端口占用问题，常常导致应用之间不能正常通信，建议使用Host-only和Bridge方式进行设置。</a></p>
<p>guest和host是必须的，还有几个可选属性：</p>
<ul>
<li>guest_ip：字符串，vm指定绑定的Ip，缺省为0.0.0.0</li>
<li>host_ip：字符串，host指定绑定的Ip，缺省为0.0.0.0</li>
<li>protocol：字符串，可选TCP或UDP，缺省为TCP</li>
</ul>
<h3 id="3-6、定义vm的configure配置节点"><a href="#3-6、定义vm的configure配置节点" class="headerlink" title="3.6、定义vm的configure配置节点"></a>3.6、定义vm的configure配置节点</h3><p>一个节点就是一个虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config.vm.define :mysql do |mysql_config|</span><br><span class="line">	...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>表示在config配置中，定义一个名为mysql的vm配置，该节点下的配置信息命名为mysql_config； 如果该Vagrantfile配置文件只定义了一个vm，这个配置节点层次可忽略。</p>
<p>还可以在一个Vagrantfile文件里建立多个虚拟机，一般情况下，你可以用多主机功能完成以下任务：</p>
<ul>
<li>分布式的服务，例如网站服务器和数据库服务器</li>
<li>分发系统</li>
<li>测试接口</li>
<li>灾难测试</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure("2") do |config|  </span><br><span class="line">  config.vm.define "web" do |web|</span><br><span class="line">    web.vm.box = "apache"</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  config.vm.define "db" do |db|</span><br><span class="line">    db.vm.box = "mysql"</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>当定义了多主机之后，在使用vagrant命令的时候，就需要加上主机名，例如vagrant ssh web；也有一些命令，如果你不指定特定的主机，那么将会对所有的主机起作用，比如vagrant up；你也可以使用表达式指定特定的主机名，例如vagrant up /follower[0-9]/。</p>
<h3 id="3-7、通用数据-设置一些基础数据，供配置信息中调用。"><a href="#3-7、通用数据-设置一些基础数据，供配置信息中调用。" class="headerlink" title="3.7、通用数据 设置一些基础数据，供配置信息中调用。"></a>3.7、通用数据 设置一些基础数据，供配置信息中调用。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app_servers = &#123;</span><br><span class="line">	:service1 =&gt; '192.168.33.20',</span><br><span class="line">	:service2 =&gt; '192.168.33.21'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是定义一个hashmap，以key-value方式来存储vm主机名和ip地址。</p>
<h3 id="3-8、配置信息"><a href="#3-8、配置信息" class="headerlink" title="3.8、配置信息"></a>3.8、配置信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ENV["LC_ALL"] = "en_US.UTF-8"</span><br><span class="line"><span class="meta">#</span><span class="bash">指定vm的语言环境，缺省地，会继承host的locale配置</span></span><br><span class="line">Vagrant.configure("2") do |config|</span><br><span class="line">    # ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>参数2，表示的是当前配置文件使用的vagrant configure版本号为Vagrant 1.1+,如果取值为1，表示为Vagrant 1.0.x Vagrantfiles，旧版本暂不考虑，记住就写2即可。</p>
<p>do … end 为配置的开始结束符，所有配置信息都写在这两段代码之间。 config是为当前配置命名，你可以指定任意名称，如myvmconfig，在后面引用的时候，改为自己的名字即可。</p>
<h3 id="3-9、vm提供者配置"><a href="#3-9、vm提供者配置" class="headerlink" title="3.9、vm提供者配置"></a>3.9、vm提供者配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config.vm.provider :virtualbox do |vb|</span><br><span class="line">     # ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p><strong>vm provider通用配置</strong></p>
<p>虚机容器提供者配置，对于不同的provider，特有的一些配置，此处配置信息是针对virtualbox定义一个提供者，命名为vb，跟前面一样，这个名字随意取，只要节点内部调用一致即可。<br>配置信息又分为通用配置和个性化配置，通用配置对于不同provider是通用的，常用的通用配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">指定vm-name，也就是virtualbox管理控制台中的虚机名称。如果不指会生成一个随机的名字，不容易区分。</span></span><br><span class="line">vb.name = "centos7"</span><br><span class="line"><span class="meta">#</span><span class="bash"> vagrant up启动时，是否自动打开virtual box的窗口，缺省为<span class="literal">false</span></span></span><br><span class="line">vb.gui = true</span><br><span class="line"><span class="meta">#</span><span class="bash">指定vm内存，单位为MB</span></span><br><span class="line">vb.memory = "1024"</span><br><span class="line"><span class="meta">#</span><span class="bash">设置CPU个数</span></span><br><span class="line">vb.cpus = 2</span><br></pre></td></tr></table></figure>

<p><strong>vm provider个性化配置(virtualbox)</strong></p>
<p>上面的provider配置是通用的配置，针对不同的虚拟机，还有一些的个性的配置，通过vb.customize配置来定制。</p>
<p>对virtual box的个性化配置，可以参考：VBoxManage modifyvm 命令的使用方法。详细的功能接口和使用说明，可以参考virtualbox官方文档。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">修改vb.name的值</span></span><br><span class="line">v.customize ["modifyvm", :id, "--name", "mfsmaster2"]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">如修改显存，缺省为8M，如果启动桌面，至少需要10M，如下修改为16M：</span></span><br><span class="line">vb.customize ["modifyvm", :id, "--vram", "16"]</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">调整虚拟机的内存</span></span><br><span class="line">vb.customize ["modifyvm", :id, "--memory", "1024"]</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">指定虚拟CPU个数</span></span><br><span class="line">vb.customize ["modifyvm", :id, "--cpus", "2"]</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash">增加光驱：</span></span><br><span class="line">vb.customize ["storageattach",:id,"--storagectl", "IDE Controller","--port","0","--device","0","--type","dvddrive","--medium","/Applications/VirtualBox.app/Contents/MacOS/VBoxGuestAdditions.iso"]</span><br><span class="line"><span class="meta">#</span><span class="bash">注：meduim参数不可以为空，如果只挂载驱动器不挂在iso，指定为“emptydrive”。如果要卸载光驱，medium传入none即可。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">从这个指令可以看出，customize方法传入一个json数组，按照顺序传入参数即可。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">json数组传入多个参数</span></span><br><span class="line">v.customize ["modifyvm", :id, "--name", “mfsserver3", "--memory", “2048"]</span><br></pre></td></tr></table></figure>
<h3 id="3-10、一组相同配置的vm"><a href="#3-10、一组相同配置的vm" class="headerlink" title="3.10、一组相同配置的vm"></a>3.10、一组相同配置的vm</h3><p>前面配置了一组vm的hash map，定义一组vm时，使用如下节点遍历。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">遍历app_servers map，将key和value分别赋值给app_server_name和app_server_ip</span></span><br><span class="line">app_servers.each do |app_server_name, app_server_ip|</span><br><span class="line">     #针对每一个app_server_name，来配置config.vm.define配置节点，命名为app_config</span><br><span class="line">     config.vm.define app_server_name do |app_config|</span><br><span class="line">          # 此处配置，参考config.vm.define</span><br><span class="line">     end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>如果不想定义app_servers，下面也是一种方案:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(1..3).each do |i|</span><br><span class="line">           config.vm.define "app-#&#123;i&#125;" do |node|</span><br><span class="line">           app_config.vm.hostname = "app-#&#123;i&#125;.vagrant.internal"</span><br><span class="line">           app_config.vm.provider "virtualbox" do |vb|</span><br><span class="line">               vb.name = app-#&#123;i&#125;</span><br><span class="line">           end</span><br><span class="line">     end</span><br><span class="line">   end</span><br></pre></td></tr></table></figure>

<h3 id="3-11、provision任务"><a href="#3-11、provision任务" class="headerlink" title="3.11、provision任务"></a>3.11、provision任务</h3><p>你可以编写一些命令，让vagrant在启动虚拟机的时候自动执行，这样你就可以省去手动配置环境的时间了。<br><strong>脚本何时会被执行</strong></p>
<ul>
<li>第一次执行vagrant up命令</li>
<li>执行vagrant provision命令</li>
<li>执行vagrant reload –provision或者vagrant up –provision命令</li>
<li>你也可以在启动虚拟机的时候添加–no-provision参数以阻止脚本被执行</li>
</ul>
<p><strong>provision任务是什么？</strong></p>
<p>provision任务是预先设置的一些操作指令，格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config.vm.provision 命令字 json格式参数</span><br><span class="line"> </span><br><span class="line">config.vm.provion 命令字 do |s|</span><br><span class="line">    s.参数名 = 参数值</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>每一个 config.vm.provision 命令字 代码段，我们称之为一个provisioner。</p>
<p>根据任务操作的对象，provisioner可以分为：</p>
<ul>
<li>Shell</li>
<li>File</li>
<li>Ansible</li>
<li>CFEngine</li>
<li>Chef</li>
<li>Docker</li>
<li>Puppet</li>
<li>Salt</li>
</ul>
<p>根据vagrantfile的层次，分为：</p>
<p>configure级：它定义在 Vagrant.configure(“2”) 的下一层次，形如： config.vm.provision …</p>
<p>vm级：它定义在 config.vm.define “web” do |web| 的下一层次，web.vm.provision …</p>
<p>执行的顺序是先执行configure级任务，再执行vm级任务，即便configure级任务在vm定义的下面才定义。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure("2") do |config|</span><br><span class="line">  config.vm.provision "shell", inline: "echo 1"</span><br><span class="line"> </span><br><span class="line">  config.vm.define "web" do |web|</span><br><span class="line">    web.vm.provision "shell", inline: "echo 2"</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  config.vm.provision "shell", inline: "echo 3"</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">==&gt; default: "1"</span><br><span class="line">==&gt; default: "2"</span><br><span class="line">==&gt; default: "3"</span><br></pre></td></tr></table></figure>
<p><strong>如何使用</strong></p>
<p>● 单行脚本</p>
<p>helloword只是一个开始，对于inline模式，命令只能在写在一行中。</p>
<p>单行脚本使用的基本格式：</p>
<p><strong>config.vm.provision</strong>  “shell”, inline: “echo fendo”</p>
<p>shell命令的参数还可以写入do … end代码块中，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config.vm.provision "shell" do |s|</span><br><span class="line">	s.inline = "echo hello provision."</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>● 内联脚本</p>
<p>如果要执行脚本较多，可以在Vagrantfile中指定内联脚本，在Vagrant.configure节点外面，写入命名内联脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">script = &lt;&lt;SCRIPT</span></span><br><span class="line">echo I am provisioning...</span><br><span class="line">echo hello provision.</span><br><span class="line">SCRIPT</span><br></pre></td></tr></table></figure>

<p>然后，inline调用如下：</p>
<p><strong>config.vm.provision</strong>  “shell”, inline: $script</p>
<p>● 外部脚本</p>
<p>也可以把代码写入代码文件，并保存在一个shell里，进行调用：</p>
<p><strong>config.vm.provision</strong>  “shell”, path: “script.sh”</p>
<p>script.sh的内容：</p>
<p>echo hello provision.</p>
<p>注意:</p>
<p>如果使用provision来安装程序，如yum install lrzsz会出现如下错误:</p>
<p>使用<code>yum install -y</code>就行了。</p>
<p>修改完Vagrantfile的配置后，记得要重启虚拟机，才能使用虚拟机更新后的配置。</p>
<p><strong>vagrant reload</strong></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:null">Wang YangYang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://wangyangyangisme.github.io/2020/03/02/vagrant-vagrantfile%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/">http://wangyangyangisme.github.io/2020/03/02/vagrant-vagrantfile%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://wangyangyangisme.github.io" target="_blank">WangYangYang</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/vagrant/">vagrant</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/76bc52296bcf2e0b7a1d628106ffcd52.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/fab2285fdcd13ead0a8b4a853c659d03.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/12/CICD-Drone+Gitea%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/drone/0c17ee771b083873e8aedf01b923a898.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Drone+Gitea自动化部署</div></div></a></div><div class="next-post pull_right"><a href="/2020/03/02/vagrant-Vagrant%E6%90%AD%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/vagrant/a286a21acfb591253aae81fc2cd12205.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Vagrant搭建虚拟环境</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/02/vagrant-Vagrant搭建虚拟环境/" title="Vagrant搭建虚拟环境"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/vagrant/a286a21acfb591253aae81fc2cd12205.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-02</div><div class="relatedPosts_title">Vagrant搭建虚拟环境</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: true,
  verify: false,
  appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
  appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
  placeholder: '请留下你的脚印',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-cn',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Wang YangYang</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyangyangisme.github.io/">blog</a>!</div><div class="icp"><a><img class="icp-icon" src="/img/icp.png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/click_heart.js"></script><script src="/js/search/algolia.js"></script></body></html>