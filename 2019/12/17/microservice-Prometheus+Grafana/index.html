<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Prometheus + Grafana监控 | WangYangYang</title><meta name="description" content="Prometheus + Grafana监控"><meta name="author" content="Wang YangYang"><meta name="copyright" content="Wang YangYang"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Prometheus + Grafana监控"><meta name="twitter:description" content="Prometheus + Grafana监控"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/791c1e6fcd278681840f1a9a88278d35.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Prometheus + Grafana监控"><meta property="og:url" content="http://wangyangyangisme.github.io/2019/12/17/microservice-Prometheus+Grafana/"><meta property="og:site_name" content="WangYangYang"><meta property="og:description" content="Prometheus + Grafana监控"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/791c1e6fcd278681840f1a9a88278d35.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://wangyangyangisme.github.io/2019/12/17/microservice-Prometheus+Grafana/"><link rel="prev" title="Sass中文教程" href="http://wangyangyangisme.github.io/2019/12/18/frontend-Sass%E4%B8%AD%E6%96%87%E6%95%99%E7%A8%8B/"><link rel="next" title="docker管理工具" href="http://wangyangyangisme.github.io/2019/12/17/docker-docker%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"C4QN4OTLJM","apiKey":"c2c026ba64eeb77abd2164975fa41f34","indexName":"wyy","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://wangyangyangisme.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">187</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">36</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-概述"><span class="toc-text">Prometheus 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-是什么"><span class="toc-text">Prometheus 是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-特点"><span class="toc-text">Prometheus 特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-组成与架构"><span class="toc-text">Prometheus 组成与架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据模型"><span class="toc-text">数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#指标类型"><span class="toc-text">指标类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作业和实例"><span class="toc-text">作业和实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-部署"><span class="toc-text">Prometheus 部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全局配置文件介绍"><span class="toc-text">全局配置文件介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#全局配置文件"><span class="toc-text">全局配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scrape-configs"><span class="toc-text">scrape_configs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#relabel-configs"><span class="toc-text">relabel_configs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#添加标签"><span class="toc-text">添加标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#标签重命名"><span class="toc-text">标签重命名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#action-重新打标签动作"><span class="toc-text">action 重新打标签动作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除标签"><span class="toc-text">删除标签</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于文件的服务发现"><span class="toc-text">基于文件的服务发现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#监控例子"><span class="toc-text">监控例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#监控-linux-服务器"><span class="toc-text">监控 linux 服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-PromSQL"><span class="toc-text">使用 PromSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查询-CPU-使用率"><span class="toc-text">查询 CPU 使用率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询内存使用率"><span class="toc-text">查询内存使用率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询硬盘使用率"><span class="toc-text">查询硬盘使用率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询系统服务运行状态"><span class="toc-text">查询系统服务运行状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-grafana"><span class="toc-text">部署 grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#监控-docker"><span class="toc-text">监控 docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#监控-mysql"><span class="toc-text">监控 mysql</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alertmanager"><span class="toc-text">alertmanager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-alertmanager"><span class="toc-text">部署 alertmanager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置告警规则并邮件通知"><span class="toc-text">配置告警规则并邮件通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#告警状态"><span class="toc-text">告警状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#告警的分配"><span class="toc-text">告警的分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#告警收敛"><span class="toc-text">告警收敛</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分组"><span class="toc-text">分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#抑制"><span class="toc-text">抑制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#静默"><span class="toc-text">静默</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写告警规则例子"><span class="toc-text">编写告警规则例子</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/791c1e6fcd278681840f1a9a88278d35.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">WangYangYang</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Prometheus + Grafana监控</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-12-17<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-12-17</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/microservice/">microservice</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">10.6k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 37 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2019/12/17/microservice-Prometheus+Grafana/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/12/17/microservice-Prometheus+Grafana/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><blockquote>
<p>转载：<a href="https://blog.rj-bai.com/post/158.html" target="_blank" rel="noopener">https://blog.rj-bai.com/post/158.html</a></p>
</blockquote>
<p>本文包括 <code>Prometheus</code> 概述、部署、配置、监控、告警、之前我做监控用的都是 <code>zabbix</code>，<code>zabbix</code> 也算是一个全面型的监控系统，但是他不太适合容器监控，他对容器监控集成欠缺很多，他比较偏向于非容器监控。</p>
<p><code>Prometheus</code> 算是一个全能型选手，原生支持容器监控，当然监控传统应用也不是吃干饭的，所以就是容器和非容器他都支持，所有的监控系统都具备这个流程，数据采集→数据处理→数据存储→数据展示→告警，本文就是针对 <code>Prometheus</code> 展开的，所以先看看 <code>Prometheus</code> 概述</p>
<h2 id="Prometheus-概述"><a href="#Prometheus-概述" class="headerlink" title="Prometheus 概述"></a>Prometheus 概述</h2><h3 id="Prometheus-是什么"><a href="#Prometheus-是什么" class="headerlink" title="Prometheus 是什么"></a>Prometheus 是什么</h3><p>中文名普罗米修斯，最初在 <code>SoundCloud</code> 上构建的监控系统，自 <code>2012</code> 年成为社区开源项目，用户非常活跃的开发人员和用户社区，2016 年加入 <code>CNCF</code>，成为继 <code>kubernetes</code> 之后的第二个托管项目，<a href="https://prometheus.io/" target="_blank" rel="noopener">官方网站</a></p>
<h3 id="Prometheus-特点"><a href="#Prometheus-特点" class="headerlink" title="Prometheus 特点"></a>Prometheus 特点</h3><ul>
<li>多维数据模型：由度量名称和键值对标识的时间序列数据</li>
<li>PromSQL: — 种灵活的查询语言，可以利用多维数据完成复杂的查询</li>
<li>不依赖分布式存储，单个服务器节点可直接工作</li>
<li>基于 HTTP 的 pull 方式釆集时间序列数据</li>
<li>推送时间序列数据通过 PushGateway 组件支持</li>
<li>通过服务发现或静态配罝发现目标</li>
<li>多种图形模式及仪表盘支持 (grafana)</li>
</ul>
<h3 id="Prometheus-组成与架构"><a href="#Prometheus-组成与架构" class="headerlink" title="Prometheus 组成与架构"></a>Prometheus 组成与架构</h3><p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus1.png"></p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Prometheus Server</td>
<td>收集指标和存储时间序列数据，并提供查询接口</td>
</tr>
<tr>
<td>Push Gateway</td>
<td>短期存储指标数据，主要用于临时性任务</td>
</tr>
<tr>
<td>Exporters</td>
<td>采集已有的三方服务监控指标并暴露 metrics</td>
</tr>
<tr>
<td>Alertmanager</td>
<td>告警</td>
</tr>
<tr>
<td>Web UI</td>
<td>简单的 WEB 控制台</td>
</tr>
</tbody></table>
<p>集成了数据的采集，处理，存储，展示，告警一系列流程都已经具备了</p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p><code>Prometheus</code> 将所有数据存储为时间序列，具有相同度量名称以及标签属于同个指标，也就是说 <code>Prometheus</code> 从数据源拿到数据之后都会存到内置的 <code>TSDB</code> 中，这里存储的就是时间序列数据，它存储的数据会有一个度量名称，譬如你现在监控一个 <code>nginx</code>，首先你要给他起个名字，这个名称也就是度量名，还会有 <code>N</code> 个标签，你可以理解名称为表名，标签为字段，所以，每个时间序列都由度量标准名称和一组键值对 (也称为标签) 唯一标识。</p>
<p>时间序列的格式是这样的，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;metrice name&gt; &#123;&lt;label name&gt;=&lt;label value&gt;,...&#125;</span><br></pre></td></tr></table></figure>

<p><code>metrice name</code> 指的就是度量标准名称，<code>label name</code> 也就是标签名，这个标签可以有多个，栗子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx_http_access&#123;method=&quot;GET&quot;,uri=&quot;/index.html&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>这个度量名称为 <code>nginx_http_access</code>，后面是两个标签，和他们各对应的值，当然你还可以继续指定标签，你指定的标签越多查询的维度就越多。</p>
<h3 id="指标类型"><a href="#指标类型" class="headerlink" title="指标类型"></a>指标类型</h3><p>看表格吧</p>
<table>
<thead>
<tr>
<th>类型名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Counter</td>
<td>递增计数器，适合收集接口请求次数</td>
</tr>
<tr>
<td>Guage</td>
<td>可以任意变化的数值，适用 CPU 使用率</td>
</tr>
<tr>
<td>Histogram</td>
<td>对一段时间内数据进行采集，并对有所数值求和于统计数量</td>
</tr>
<tr>
<td>Summary</td>
<td>与 Histogram 类型类似</td>
</tr>
</tbody></table>
<h3 id="作业和实例"><a href="#作业和实例" class="headerlink" title="作业和实例"></a>作业和实例</h3><p>实例指的就是你可以抓取的目标，这个会在 <code>Prometheus</code>配置文件中提现，作业是具有相同目标的实例集合称为作业，你可以理解为是一个组，一会写配置文件的时候会详细解析，下面开始安装 <code>Prometheus</code>。</p>
<h2 id="Prometheus-部署"><a href="#Prometheus-部署" class="headerlink" title="Prometheus 部署"></a>Prometheus 部署</h2><p>先通过二进制来部署 <code>Prometheus</code> 吧，<a href="https://prometheus.io/download/" target="_blank" rel="noopener">下载地址</a>，我们要下载服务端，也就是这个包</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus2.png"></p>
<p>我在服务器上直接下载了，下载完后解压移动到别的目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai ~]<span class="comment"># wget https://github.com/prometheus/prometheus/releases/download/v2.10.0/prometheus-2.10.0.linux-amd64.tar.gz</span></span><br><span class="line">[root@rj-bai ~]<span class="comment"># tar zxf prometheus-2.10.0.linux-amd64.tar.gz </span></span><br><span class="line">[root@rj-bai ~]<span class="comment"># mv prometheus-2.10.0.linux-amd64 /usr/local/prometheus</span></span><br><span class="line">[root@rj-bai ~]<span class="comment"># cd /usr/local/prometheus/ &amp;&amp; ls</span></span><br><span class="line">console_libraries  consoles  LICENSE  NOTICE  prometheus  prometheus.yml  promtool</span><br></pre></td></tr></table></figure>

<p>先配置一下监控本机吧，它默认的配置文件是 <code>prometheus.yml</code>，已经配置好了，也就是这一段，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line">  <span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br></pre></td></tr></table></figure>

<p><code>targets</code> 就是一个作业，也就是被监控端，监控本机的 <code>9090</code> 端口，启动选项也有很多，了解一下，主要是关注两点，分别如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--storage.tsdb.path=&quot;data/&quot;   ##存储数据的目录，默认/data</span><br><span class="line">--storage.tsdb.retention.time ##数据存储时间，默认15天</span><br></pre></td></tr></table></figure>

<p>这里提一下存储的问题，<code>TSDB</code> 不太适合长期去存储数据，数据量大了支持并不是很好，官方声明也是不会对这一块存储进行改善，给你的建议是使用外部存储，譬如使用 <code>InfluxDB</code>，这里暂时就不改他的默认存储了，把他进入系统服务吧，写一个 <code>systemd</code> 的配置文件，直接启动了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai /usr/<span class="built_in">local</span>/prometheus]<span class="comment"># cat &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt;OEF </span></span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=prometheus server daemon</span><br><span class="line">&gt; </span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; ExecStart=/usr/<span class="built_in">local</span>/prometheus/prometheus --config.file=/usr/<span class="built_in">local</span>/prometheus/prometheus.yml</span><br><span class="line">&gt; </span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; OEF</span><br><span class="line">[root@rj-bai /usr/<span class="built_in">local</span>/prometheus]<span class="comment"># systemctl daemon-reload &amp;&amp; systemctl start prometheus.service</span></span><br></pre></td></tr></table></figure>

<p>这样就启动了撒，去访问 <code>9090</code> 端口就可以看到页面了，这个页面能看到的东西很多，自己点点看吧，能看到这个页面就表示莫得问题。</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus3.png"></p>
<p>目前使用二进制部署主要是因为方便改配置文件，下面开始看配置文件。</p>
<h2 id="全局配置文件介绍"><a href="#全局配置文件介绍" class="headerlink" title="全局配置文件介绍"></a>全局配置文件介绍</h2><p><code>prometheus</code> 已经安装起来了，下面看一下配置文件与核心功能，很多功能都是通过配置文件去实现的，比较多，所以先熟悉一下他的配置文件。</p>
<h3 id="全局配置文件"><a href="#全局配置文件" class="headerlink" title="全局配置文件"></a>全局配置文件</h3><p>也就是 <code>prometheus.yml</code>，官方说明<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="noopener">地址</a>，大概分为这几块，我把注释去掉了，全局配置选项</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> <span class="string">]</span>      <span class="comment">##采集间隔</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">10s</span> <span class="string">]</span>      <span class="comment">##采集超时时间</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> <span class="string">]</span>  <span class="comment">##告警评估周期</span></span><br><span class="line">  <span class="attr">external_labels:</span>                                    <span class="comment">##外部标签             </span></span><br><span class="line">    <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>指定告警规则</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>配置被监控端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;scrape_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>配置告警方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;alertmanager_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>指定远程存储</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;remote_write&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;remote_read&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>这就是一个整体的配置文件，现在再看默认的配置文件就能看懂某一段是干啥的了，现在开始配置 <code>scrape_configs</code></p>
<h3 id="scrape-configs"><a href="#scrape-configs" class="headerlink" title="scrape_configs"></a>scrape_configs</h3><p>这块就是来配置我们要监控的东西，在这一块中配置的东西又有很多了，看一下官方的，一堆，我还是去掉注释分段贴出来吧。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job_name:</span> <span class="string">&lt;job_name&gt;</span>  <span class="comment">##指定job名字</span></span><br><span class="line"><span class="string">[</span> <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_interval&gt;</span> <span class="string">]</span></span><br><span class="line"><span class="string">[</span> <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_timeout&gt;</span> <span class="string">]</span>  <span class="comment">##这两段指定采集时间，默认继承全局</span></span><br><span class="line"><span class="string">[</span> <span class="attr">metrics_path:</span> <span class="string">&lt;path&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">/metrics</span> <span class="string">]</span>  <span class="comment">##metrics路径，默认metrics</span></span><br><span class="line"><span class="string">[</span> <span class="attr">honor_labels:</span> <span class="string">&lt;boolean&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span> <span class="string">]</span>  <span class="comment">##默认附加的标签，默认不覆盖</span></span><br></pre></td></tr></table></figure>

<p>它默认暴露监控数据的接口就是 <code>ip:9090/metrics</code>，你可以去指定这个名称，访问一下这里看看，  </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus50.png"></p>
<p>在 <code>ip:9090/targets</code> 能看到当前监控的主机，现在只有本机一个，标签显示也在这里。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus4.png"></p>
<p>在看下一段，这里定义的是要如何去访问采集目标</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[</span> <span class="attr">scheme:</span> <span class="string">&lt;scheme&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">http</span> <span class="string">]</span>  <span class="comment">## 默认使用http方式去访问</span></span><br><span class="line"><span class="attr">params:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;string&gt;:</span> <span class="string">[&lt;string&gt;,</span> <span class="string">...]</span> <span class="string">]</span>        <span class="comment">## 配置访问时携带的参数</span></span><br><span class="line"><span class="attr">basic_auth:</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">username:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">password:</span> <span class="string">&lt;secret&gt;</span> <span class="string">]</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">password_file:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span>          <span class="comment">## 配置访问接口的用户名密码</span></span><br><span class="line"><span class="string">[</span> <span class="attr">bearer_token:</span> <span class="string">&lt;secret&gt;</span> <span class="string">]</span></span><br><span class="line"><span class="string">[</span> <span class="attr">bearer_token_file:</span> <span class="string">/path/to/bearer/token/file</span> <span class="string">]</span>  <span class="comment">##指定认证token</span></span><br><span class="line"><span class="attr">tls_config:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;tls_config&gt;</span> <span class="string">]</span>                     <span class="comment">## 指定CA证书</span></span><br><span class="line"><span class="string">[</span> <span class="attr">proxy_url:</span> <span class="string">&lt;string&gt;</span> <span class="string">]</span>                <span class="comment">## 使用代理模式访问目标</span></span><br></pre></td></tr></table></figure>

<p>下一段，服务发现配置，贴了几个，不是完整的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">consul_sd_configs:</span>                   <span class="comment">##通过consul去发现</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;consul_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">dns_sd_configs:</span>                      <span class="comment">##通过DNS去发现</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;dns_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">file_sd_configs:</span>                   <span class="comment">##通过文件去发现</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;file_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">kubernetes_sd_configs:</span>               <span class="comment">##通过kubernetes去发现</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;kubernetes_sd_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>静态配置被监控端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;static_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>刚刚监控本机的就是静态配置去监控的，也是就这一段，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br></pre></td></tr></table></figure>

<p>最后标签配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> <span class="string">]</span>          <span class="comment">##在数据采集前对标签进行重新标记</span></span><br><span class="line"><span class="attr">metric_relabel_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> <span class="string">]</span>          <span class="comment">##在数据采集之后对标签进行重新标记</span></span><br><span class="line"><span class="string">[</span> <span class="attr">sample_limit:</span> <span class="string">&lt;int&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="number">0</span> <span class="string">]</span> <span class="comment">##采集样本数量，默认0</span></span><br></pre></td></tr></table></figure>

<p>下面看一下 <code>relabel_configs</code></p>
<h3 id="relabel-configs"><a href="#relabel-configs" class="headerlink" title="relabel_configs"></a>relabel_configs</h3><p>就是用来重新打标记的，对于 <code>prometheus</code> 数据模型最关键点就是一个指标名称和一组标签来组成一个多维度的数据模型，你想完成一个复杂的查询就需要你有很多维度，<code>relabel_configs</code> 就是对标签进行处理的，他能帮你在数据采集之前对任何目标的标签进行修改，重打标签的意义就是如果标签有重复的可以帮你重命名，看一哈现在的，上面铁锅</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus5.png"></p>
<p>现在 <code>instance</code> 是他默认给我加的标签，想改的话就需要 <code>relabel_configs</code> 去帮你重打标签，他也可以删除标签，如果某个标签用不到了也可以删掉，再就是过滤标签，再看一下 <code>relabel_configs</code> 的配置有哪些，也就是这一段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">relabel_configs:</span> </span><br><span class="line">  <span class="string">[</span> <span class="attr">source_labels:</span> <span class="string">'['</span> <span class="string">&lt;labelname&gt;</span> <span class="string">[,</span> <span class="string">...]</span> <span class="string">']'</span> <span class="string">]</span>   <span class="comment">##源标签，指定对哪个现有标签进行操作</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">separator:</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">;</span> <span class="string">]</span>            <span class="comment">##多个源标签时连接的分隔符</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">target_label:</span> <span class="string">&lt;labelname&gt;</span> <span class="string">]</span>                    <span class="comment">##要将源标签换成什么名字</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">regex:</span> <span class="string">&lt;regex&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">(.*)</span> <span class="string">]</span>              <span class="comment">##怎么来匹配源标签，默认匹配所有</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">modulus:</span> <span class="string">&lt;uint64&gt;</span> <span class="string">]</span>                            <span class="comment">##不怎么会用到</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">replacement:</span> <span class="string">&lt;string&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">$1</span> <span class="string">]</span>         <span class="comment">##替换正则表达式匹配到的分组，分组引用$1,$2,$3</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">action:</span> <span class="string">&lt;relabel_action&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">replace</span> <span class="string">]</span> <span class="comment">##基于正则表达式匹配执行的操作，默认替换</span></span><br></pre></td></tr></table></figure>

<p>这东西到底怎么用，做个演示，根据两台服务器聚合查看 <code>CPU</code> 使用率，说白了就是同时去查看这两台服务器的 <code>CPU</code> 利用率，用这个标签就可以实现了。</p>
<h4 id="添加标签"><a href="#添加标签" class="headerlink" title="添加标签"></a>添加标签</h4><p>去 <code>WEB</code> 界面看一下当前被监控端 <code>CPU</code> 使用率，用 <code>sql</code> 去查，也就是这个值。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus6.png"></p>
<p>可以看到一个度量名称和两个默认附加的标签，我现在想统计两台服务器的 <code>CPU</code> 使用率，就需要加一个标签了，说白了就是添加一个维度去获取这两台服务器 <code>CPU</code> 使用率，接下来去改配置文件吧，给他加个标签，如下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">local</span></span><br></pre></td></tr></table></figure>

<p>热更新一下，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai /usr/<span class="built_in">local</span>/prometheus]<span class="comment"># ps aux | grep prometheus.yml  | grep -v grep  | awk &#123;'print $2'&#125; | xargs kill -hup</span></span><br></pre></td></tr></table></figure>

<p>看一下有没有生效，刷新一下页面就能看到了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus7.png"></p>
<p>然后可以根据这个标签去查了，语法是这样的，内置函数，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(process_cpu_seconds_total&#123;server=&quot;local&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus8.png"></p>
<p>所以就算你有 <code>N</code> 个被监控的服务器打上这个标签之后在这里就可以看到总数了，添加标签很简单，下面看一下重命名标签，就是将现有的标签进行重命名。</p>
<h4 id="标签重命名"><a href="#标签重命名" class="headerlink" title="标签重命名"></a>标签重命名</h4><p>就是将一个已有的标签重命名一个新的标签，实际操作一下，之前的标签去掉了，现在要把 <code>job_name</code> 改个名字，也就是这一块的配置，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br></pre></td></tr></table></figure>

<p>目前 <code>job_name</code> 为 <code>prometheus</code>，当前这个虚拟机是跑在 <code>IP</code> 地址为 <code>21</code> 的物理机上，所以现在把他的 <code>job_name</code> 改成 <code>server21</code>，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">'server21'</span></span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [<span class="string">'localhost:9090'</span>]</span><br></pre></td></tr></table></figure>

<p>重启一下，刷新页面就可以看到了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus9.png"></p>
<p>我现在要将 <code>job</code> 这个标签标记为 <code>local</code>，也就是将 <code>job=&quot;server21</code> 改为 <code>local=&quot;server21</code>，下面开始用 <code>relabel</code> 进行重命名，改完之后的配置是这样的，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'server21'</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">source_labels:</span> <span class="string">['job']</span>  <span class="comment">##源标签</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">(.*)</span>             <span class="comment">##正则，会匹配到job值，也就是server21</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">$1</span>         <span class="comment">##引用正则匹配到的内容，也就是server21</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">local</span>     <span class="comment">##赋予新的标签，名为local</span></span><br></pre></td></tr></table></figure>

<p>这样就可以了撒，重新加载一下，看页面，</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus10.png"></p>
<p>新的数据已经有了，之前的标签还会保留，因为没有配置删除他，这样就可以了，现在就可以聚合了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus11.png"></p>
<p>这样他就会将所有实例使用率相加求和。</p>
<h4 id="action-重新打标签动作"><a href="#action-重新打标签动作" class="headerlink" title="action 重新打标签动作"></a>action 重新打标签动作</h4><p>如表所示，上面就是用了一个默认的。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>replace</td>
<td>默认，通过正则匹配 source_label 的值，使用 replacement 来引用表达式匹配的分组</td>
</tr>
<tr>
<td>keep</td>
<td>删除 regex 于链接不匹配的目标 source_labels</td>
</tr>
<tr>
<td>drop</td>
<td>删除 regex 与连接匹配的目标 source_labels</td>
</tr>
<tr>
<td>labeldrop</td>
<td>匹配 Regex 所有标签名称</td>
</tr>
<tr>
<td>labelkeep</td>
<td>匹配 regex 所有标签名称</td>
</tr>
<tr>
<td>hashmod</td>
<td>设置 target_label 为 modulus 连接的哈希值 source_lanels</td>
</tr>
<tr>
<td>labelmap</td>
<td>匹配 regex 所有标签名称，复制匹配标签的值分组，replacement 分组引用 (${1},${2}) 替代</td>
</tr>
</tbody></table>
<p>比如说我现在不想采集本机的数据了，就可以用上面的标签进行操作了，加点东西就行了，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'server21'</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line">    <span class="attr">relabel_configs:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">source_labels:</span> <span class="string">['job']</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">      <span class="attr">source_labels:</span> <span class="string">["job"]</span></span><br></pre></td></tr></table></figure>

<p>删除标签为 <code>job</code> 的节点，目前只有一个节点，所以这个跑了之后就看不到数据了，如果真的要用这个给不需要监控的节点打一个标签，然后在这里匹配就行了，所以现在重新载入的话就没数据了，</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus12.png"></p>
<p>最后看一下删除标签。</p>
<h4 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a>删除标签</h4><p>刚刚我新打了一个标签，也就是 <code>local</code> 标签，所以之前的 <code>job</code> 标签可以不要了，下面直接给他删了吧，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'server21'</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line">    <span class="attr">relabel_configs:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">source_labels:</span> <span class="string">['job']</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labeldrop</span> </span><br><span class="line">      <span class="attr">regex:</span> <span class="string">job</span></span><br></pre></td></tr></table></figure>

<p>重载一下就看到 <code>job</code> 的标签了。</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus15.png"></p>
<p>这样就可以了撒，下面看看基于文件的服务发现功能</p>
<h3 id="基于文件的服务发现"><a href="#基于文件的服务发现" class="headerlink" title="基于文件的服务发现"></a>基于文件的服务发现</h3><p>下面会涉及到基于文件的服务发现，还有就是基于 <code>kubernetes</code> 的服务发现，这个到监控 <code>k8s</code> 集群的时候再说吧，先看基于文件的吧，现在还没准备别的服务器，还是发现本身吧，先把配置文件改成这样，重载之后就看不到本机了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@rj-bai</span> <span class="string">/usr/local/prometheus]#</span> <span class="string">cat</span> <span class="string">prometheus.yml</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> </span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus16.png"></p>
<p>然后就可以去改配置文件了，通过服务发现将自身加入进去，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@rj-bai</span> <span class="string">/usr/local/prometheus]#</span> <span class="string">cat</span> <span class="string">prometheus.yml</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> </span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span> <span class="string">['/usr/local/prometheus/files_sd_configs/*.yaml']</span>  <span class="comment">##指定服务发现文件位置</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">5s</span>                                      <span class="comment">##刷新间隔改为5秒</span></span><br></pre></td></tr></table></figure>

<p>重载服务，然后去写服务发现的 <code>YAML</code> 文件吧，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@rj-bai</span> <span class="string">/usr/local/prometheus/files_sd_configs]#</span> <span class="string">cat</span> <span class="string">configs.yml</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span> </span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">server21</span></span><br></pre></td></tr></table></figure>

<p>这样就可以了，文件保存五秒后就能看到发现的主机了，查数据也没问题</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus17.png"></p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus18.png"></p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus19.png"></p>
<p>就是这种原理，下面开始监控 <code>linux</code> 和一些服务吧</p>
<h2 id="监控例子"><a href="#监控例子" class="headerlink" title="监控例子"></a>监控例子</h2><h3 id="监控-linux-服务器"><a href="#监控-linux-服务器" class="headerlink" title="监控 linux 服务器"></a>监控 linux 服务器</h3><p>在被监控端需要装一个名为 <code>node_exporter</code> 的导出器，他会帮你收集系统指标和一些软件运行的指标，把指标暴露出去，这样 <code>prometheus</code> 就可以去采集了，具体 <code>node_exporter</code> 能采集哪些东西，看官方的 <a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener"><code>github</code></a>吧，还是蛮多的，现在随便找个服务器下载一下 <code>node_exporter</code> 运行起来就行了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kubeadm-node ~]<span class="comment"># wget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz</span></span><br><span class="line">[root@kubeadm-node ~]<span class="comment"># tar zxf node_exporter-0.18.1.linux-amd64.tar.gz </span></span><br><span class="line">[root@kubeadm-node ~]<span class="comment"># mv node_exporter-0.18.1.linux-amd64 /usr/local/node_exporter</span></span><br><span class="line">[root@kubeadm-node ~]<span class="comment"># cd /usr/local/node_exporter</span></span><br></pre></td></tr></table></figure>

<p>在启动之前看一下他的启动参数，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kubeadm-node /usr/<span class="built_in">local</span>/node_exporter]<span class="comment"># ./node_exporter --help</span></span><br></pre></td></tr></table></figure>

<p>可以看到一堆，她就是一个收集器，配置你要收集或不收集哪些信息，看 <code>default</code> 就能看出来撒，加到系统服务中吧，用 <code>systemctl</code> 去管理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@kubeadm-node /usr/<span class="built_in">local</span>/node_exporter]<span class="comment"># cat &gt; /usr/lib/systemd/system/node_exporter.service &lt;&lt;OEF </span></span><br><span class="line">&gt; [Unit]</span><br><span class="line">&gt; Description=node_exporter</span><br><span class="line">&gt; </span><br><span class="line">&gt; [Service]</span><br><span class="line">&gt; Restart=on-failure</span><br><span class="line">&gt; ExecStart=/usr/<span class="built_in">local</span>/node_exporter/node_exporter</span><br><span class="line">&gt; </span><br><span class="line">&gt; [Install]</span><br><span class="line">&gt; WantedBy=multi-user.target</span><br><span class="line">&gt; OEF</span><br><span class="line">[root@kubeadm-node /usr/<span class="built_in">local</span>/node_exporter]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@kubeadm-node /usr/<span class="built_in">local</span>/node_exporter]<span class="comment"># systemctl start node_exporter.service</span></span><br><span class="line">[root@kubeadm-node /usr/<span class="built_in">local</span>/node_exporter]<span class="comment"># curl -s 127.0.0.1:9100/metrics | head</span></span><br></pre></td></tr></table></figure>

<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus20.png"></p>
<p>正常启动了，现在要配置 <code>prometheus</code> 来监控这个主机了，之前配置过动态发现了，现在再加一个，把服务端和被监控端分开，所以新加了这个。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai /usr/<span class="built_in">local</span>/prometheus]<span class="comment"># cat prometheus.yml</span></span><br><span class="line">  - job_name: <span class="string">'nodes'</span></span><br><span class="line">    file_sd_configs: </span><br><span class="line">      - files: [<span class="string">'/usr/local/prometheus/nodes_sd_configs/*.yml'</span>]</span><br><span class="line">        refresh_interval: 5s </span><br><span class="line">[root@rj-bai /usr/<span class="built_in">local</span>/prometheus]<span class="comment"># mkdir nodes_sd_configs &amp;&amp; cd nodes_sd_configs</span></span><br><span class="line">[root@rj-bai /usr/<span class="built_in">local</span>/prometheus]<span class="comment"># ps aux | grep prometheus.yml  | grep -v grep  | awk &#123;'print $2'&#125; | xargs kill -hup</span></span><br><span class="line">[root@rj-bai /usr/<span class="built_in">local</span>/prometheus/nodes_sd_configs]<span class="comment"># cat nodes.yml</span></span><br><span class="line">- targets: [<span class="string">'192.168.1.248:9100'</span>] </span><br><span class="line">  labels:</span><br><span class="line">    name: server20</span><br></pre></td></tr></table></figure>

<p>直接去看页面吧，应该已经添加进去了，顺便查一下数据</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus21.png"></p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus22.png"></p>
<p>这样就可以了，莫得问题，下面用 <code>PromSQL</code> 获取 <code>CPU&amp;</code> 内存硬盘使用率</p>
<h3 id="使用-PromSQL"><a href="#使用-PromSQL" class="headerlink" title="使用 PromSQL"></a>使用 PromSQL</h3><p>想查数据就需要写 <code>PromSQL</code> 去查询了，</p>
<h4 id="查询-CPU-使用率"><a href="#查询-CPU-使用率" class="headerlink" title="查询 CPU 使用率"></a>查询 CPU 使用率</h4><p>比如果我想查看刚刚加进来的 <code>nodes CPU</code> 利用率，以 <code>node</code> 开头的 <code>sql</code> 都是 <code>node_expores</code> 采集的指标，度量很多，看 <code>CPU</code> 使用率看着一个指标就够了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus23.png"></p>
<p>总 <code>CPU</code> 使用情况，会列出你处理器多少核，每个核的使用情况，这个 CPU 是干什么使用的，用户态还是内核态还是操作 <code>IO</code> 等待的时间，还有优先级调度使用的 <code>CPU</code>，他会通过一个名为 <code>mode</code> 的标签去区分这些，一般不会这么去统计，现在统计一下刚刚加进去的那个 <code>nodes</code> 五分钟之内 <code>CPU</code> 平均使用率是多少，还是得写 <code>PromSQL</code>，大概是这样，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 - irate(node_cpu_seconds_total&#123;mode="idle"&#125;[5m])*100</span><br></pre></td></tr></table></figure>

<p><code>node_cpu_seconds_total{mode=&quot;idle&quot;}[5m]</code> 这一段是统计出了服务器最近 5 分钟 <code>CPU</code> 的空闲率，执行之后是这种效果，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus24.png"></p>
<p>这是五分钟之内所有值，然后使用了 <code>irate</code> 函数来统计它的平均值，转化成了百分比，乘了一百，所以执行结果如下。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus25.png"></p>
<p>这就是所有 <code>CPU</code> 的空闲率了，我要取的是所有 CPU 的使用率，所以又一百减去了空闲率的值就是使用率了，所以上面第一条 <code>sql</code> 执行发回的结果如下。</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus26.png"></p>
<p>这就是五分钟之内总的 <code>CPU</code> 的平均使用率了，我的那个节点就是四核 <code>CPU</code>，每个都被列出来了，真鸡儿麻烦，再看一下内存使用率，和上面其实一样，值都有了，求出他的百分比就行了，</p>
<h4 id="查询内存使用率"><a href="#查询内存使用率" class="headerlink" title="查询内存使用率"></a>查询内存使用率</h4><p><code>linux</code> 内核有一个内存缓存机制，所以 <code>buff/cache</code> 的占用不算是已被使用的物理内存，所以计算方式就是将这三个值加到一起就是剩余内存了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus27.png"></p>
<p><code>sql</code> 的话这样写，直接查一下，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes</span><br></pre></td></tr></table></figure>

<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus28.png"></p>
<p>这就是总共剩余的内存，单位是 <code>bite</code>，现在我要计算使用内存百分比，和上面看 <code>CPU</code> 使用率的方法一致，<code>sql</code> 如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 - (node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes) / node_memory_MemTotal_bytes *100</span><br></pre></td></tr></table></figure>

<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus29.png"></p>
<p>下面看看硬盘使用率</p>
<h4 id="查询硬盘使用率"><a href="#查询硬盘使用率" class="headerlink" title="查询硬盘使用率"></a>查询硬盘使用率</h4><p>你的磁盘和挂载点可能不止一个，先看一下目前收集到的信息，</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus30.png"></p>
<p>所以就要指定分区进行计算了，所以匹配这里写了一个正则去匹配你挂载的磁盘，如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100- (node_filesystem_free_bytes&#123;mountpoint="/",fstype=~"ext4|xfs"&#125; / node_filesystem_size_bytes&#123;mountpoint="/",fstype=~"ext4|xfs"&#125; *100)</span><br></pre></td></tr></table></figure>

<p><code>node_filesystem_size_bytes</code> 查的是 <code>/</code> 总大小，<code>node_filesystem_free_bytes</code> 查的是剩余大小，只匹配 <code>ext4&amp;xfs</code> 类型的，像是什么 <code>tmpfs&amp;shm</code> 类型的都不匹配，还是算出了剩余的百分比，所以执行后的结果是这样，</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus31.png"></p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus32.png"></p>
<p>计算方式大概就是这样，现在还没涉及到图形展示这一块，下面看一下获取系统服务运行状态。</p>
<h4 id="查询系统服务运行状态"><a href="#查询系统服务运行状态" class="headerlink" title="查询系统服务运行状态"></a>查询系统服务运行状态</h4><p>就是监控系统服务运行状态，说白了就是监控以 <code>systemctl</code> 启动的服务，现在监控一下这个，<code>node_exports</code> 就支持对这种服务进行监控，目前还没有启用这个功能，现在启动一下撒，直接去改 <code>node_exports</code> 的启动文件，加两条参数即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kubeadm-node ~]# cat /usr/lib/systemd/system/node_exporter.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Restart=on-failure</span><br><span class="line">ExecStart=/usr/local/node_exporter/node_exporter --collector.systemd --collector.systemd.unit-whitelist=(docker|sshd).service</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>第二段就是制定我要监控哪些系统服务，我写了 <code>docker&amp;sshd</code>，重启后可以去查询了，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kubeadm-node ~]<span class="comment"># systemctl daemon-reload         </span></span><br><span class="line">[root@kubeadm-node ~]<span class="comment"># systemctl restart node_exporter.service</span></span><br></pre></td></tr></table></figure>

<p>我查一下当前 <code>docker&amp;sshd</code> 的运行状态是什么，可以直接这样写了，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_systemd_unit_state&#123;exported_name=~"(docker|sshd).service"&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus33.png"></p>
<p>目前 <code>state=active</code> 的值为 <code>0</code>，说明正常运行，所以之后写告警规则的时候就去判断这个值是不是 <code>1</code>，如果不是就要进行某些操作了，下面装一下 <code>grafana</code> 吧</p>
<h3 id="部署-grafana"><a href="#部署-grafana" class="headerlink" title="部署 grafana"></a>部署 grafana</h3><p><code>grafana</code> 就是一个图形展示系统，他主要是对度量指标进行分析可视化，他本身不会存储任何数据，他只会展示数据库里面的数据，支持很多类型的数据库，<a href="https://grafana.com/" target="_blank" rel="noopener">官网</a>，刚好我装有 <code>docker</code>，其实目前在操作的这两台服务是一个 <code>k8s</code> 集群，用 <code>kubeadm</code> 启动的，所以我直接用 <code>docker</code> 启动了，还是写个 <code>deployment</code>，算了直接用 <code>docker</code> 命令启吧，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@kubeadm-node ~]<span class="comment"># docker run \</span></span><br><span class="line">&gt; -u 0 \</span><br><span class="line">&gt; -d \</span><br><span class="line">&gt; -p 3000:3000  \</span><br><span class="line">&gt; --name=grafana   \</span><br><span class="line">&gt; -v /var/lib/grafana:/var/lib/grafana \</span><br><span class="line">&gt; grafana/grafana</span><br></pre></td></tr></table></figure>

<p>这样就行了，直接访问 <code>3000</code> 端口就好了，用户名密码默认 <code>admin/admin</code>，初次登陆会让你修改密码，就可以看到主页了，然后直接添加数据源，把 <code>prometheus</code> 加进去，保存就行了，</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/grafana1.png"></p>
<p>然后直接导入一个仪表盘进来吧，<code>ID</code> 是 <code>9276</code>，大概是这种效果，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/grafana2.png"></p>
<p>然后网络带宽那里没数据，我看了一下他的 <code>sql</code>，只需要将 <code>$nic</code> 改为你的网卡名就有数据了，所以现在监控 <code>linux</code> 服务器是没问题了，下面试试监控 <code>docker</code>。</p>
<h3 id="监控-docker"><a href="#监控-docker" class="headerlink" title="监控 docker"></a>监控 docker</h3><p>想要监控 <code>docker</code> 需要用到名为 <code>cadvisor</code> 的工具，是谷歌开源的，它用于收集正在运行的容器资源使用和性能信息，<a href="https://github.com/google/cadvisor" target="_blank" rel="noopener">github</a> 地址，你需要在要监控的服务器上部署 <code>cadvisor</code>，直接用 <code>docker</code> 去启动就完了，命令如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  --volume=/:/rootfs:ro \</span><br><span class="line">  --volume=/var/run:/var/run:ro \</span><br><span class="line">  --volume=/sys:/sys:ro \</span><br><span class="line">  --volume=/var/lib/docker/:/var/lib/docker:ro \</span><br><span class="line">  --volume=/dev/disk/:/dev/disk:ro \</span><br><span class="line">  --publish=8080:8080 \</span><br><span class="line">  --detach=<span class="literal">true</span> \</span><br><span class="line">  --name=cadvisor \</span><br><span class="line">  google/cadvisor:latest</span><br></pre></td></tr></table></figure>

<p>容器启动后也是会暴露一个指标接口，默认是 <code>8080/metrics</code>，这里就不访问了，下一步就是加入到普罗米修斯中进行监控了，去改他的配置文件，静态配置一个吧，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'docker'</span></span><br><span class="line">  <span class="attr">static_configs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['192.168.1.248:8080']</span></span><br></pre></td></tr></table></figure>

<p>加完直接重载，页面直接导入一个图表吧，<code>ID</code> 是 <code>193</code>，效果是这样的，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/grafana3.png"></p>
<p>主要就是监控容器的 <code>CPU</code> 内存网络流量的，都可看到，目前我 <code>248</code> 就运行了六个容器，就是这样，下面在看看监控 <code>mysql</code></p>
<h3 id="监控-mysql"><a href="#监控-mysql" class="headerlink" title="监控 mysql"></a>监控 mysql</h3><p>监控 <code>mysql</code> 就会用到 <code>mysql_exporter</code>，这个也能在官网下到，也就是<a href="https://prometheus.io/download/#mysqld_exporter" target="_blank" rel="noopener">这里</a>，这个东西需要你安装到运行 <code>mysql</code> 的实例上，本地的 <code>mysql</code> 比较多，我随便找了一个扔了上去，先去 <code>mysql</code> 创建一个用户吧，这个程序需要连接明月三千里才能获取到指标。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE USER 'exporter'@'localhost' IDENTIFIED BY 'exporter';</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'localhost';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select user,host from mysql.user;</span><br></pre></td></tr></table></figure>

<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/grafana4.png"></p>
<p>用户创建好了去解压包吧，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql ~]# tar zxf mysqld_exporter-0.11.0.linux-amd64.tar.gz -C /usr/local/ &amp;&amp; cd /usr/local/</span><br><span class="line">[root@mysql local]# mv mysqld_exporter-0.11.0.linux-amd64/ mysqld_exporter &amp;&amp; cd mysqld_exporter</span><br></pre></td></tr></table></figure>

<p>需要写一个文件，<code>mysqld_exporter</code> 直接读这个文件就可以连接 <code>mysql</code> 了，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql mysqld_exporter]# cat .my.cnd</span><br><span class="line">[client]</span><br><span class="line">user=exporter</span><br><span class="line">password=exporter</span><br></pre></td></tr></table></figure>

<p>文件有了，在启动的时候指定一下读取这个文件，直接启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql mysqld_exporter]# ./mysqld_exporter --config.my-cnf=.my.cnf</span><br></pre></td></tr></table></figure>

<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/grafana5.png"></p>
<p>现在把这个加到普罗米修斯中，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'mysql'</span></span><br><span class="line">  <span class="attr">static_configs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['192.168.1.126:9104']</span></span><br></pre></td></tr></table></figure>

<p>然后导入一个仪表盘，<code>ID</code> 为 <code>7362</code>，看页面，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/grafana6.png"></p>
<p>还是有些空值，而且官方也说了 <code>5.6</code> 版本有些不支持，我看了一下 <code>Buffer Pool Size of Total RAM</code> 的 <code>sql</code>，是这样写的，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(mysql_global_variables_innodb_buffer_pool_size&#123;instance="$host"&#125; * 100) / on (instance) node_memory_MemTotal_bytes&#123;instance="$host"&#125;</span><br></pre></td></tr></table></figure>

<p>现在应该能看的差不多了，他去查了 <code>mysql</code> 节点的总内存，但是我明月三千里节点并没有装 <code>node_exports</code>，所以就没数据了，总之支持采集的数据和仪表盘模板很多，自行琢磨吧，上面只是最简单的几个例子，下面来看看告警这一块的东西。</p>
<h2 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h2><p>普罗米修斯本身是不支持告警的，告警是由 <code>alertmanager</code> 这个组件完成的，普罗米修斯将告警收集起来会推送给 <code>alertmanager</code>，<code>alertmanager</code> 接收到告警后决定怎么去处理这些告警，应该发给谁，下面先部署一下 <code>alertmanager</code> 吧，我直接下载了，在普罗米修斯服务器上，</p>
<h3 id="部署-alertmanager"><a href="#部署-alertmanager" class="headerlink" title="部署 alertmanager"></a>部署 alertmanager</h3><p><code>alertmanager</code> 没必要和普罗米修斯放在一个服务器上，他们之间能通讯就可以了，我目前资源紧张就扔到一起了，直接 <code>wget</code> 了，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai ~]<span class="comment"># wget https://github.com/prometheus/alertmanager/releases/download/v0.18.0/alertmanager-0.18.0.linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>让他先下着，聊一下普罗米修斯和 <code>alertmanager</code> 是怎么通讯的，首先你需要在 <code>prometheus</code> 中定义你的监控规则，说白了就是写一个触发器，某个值超过了我设置的阈值我就要告警了，触发告警之后 <code>prometheus</code> 会推送当前的告警规则到 <code>alertmanager</code>，<code>alertmanager</code> 收到了会进行一系列的流程处理，然后发送到接收人手里，他的处理规则也是很复杂的，后面会说，现在也下载完了，解压</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai ~]# tar zxf alertmanager-0.18.0.linux-amd64.tar.gz </span><br><span class="line">[root@rj-bai ~]# mv alertmanager-0.18.0.linux-amd64 /usr/local/alertmanager &amp;&amp; cd /usr/local/alertmanager &amp;&amp; ls</span><br><span class="line">alertmanager  alertmanager.yml  amtool  LICENSE  NOTICE</span><br></pre></td></tr></table></figure>

<p>有两个二进制文件，分别是启动程序和一个工具，还有一个主配置文件，先来了解一下他的主配置文件，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br></pre></td></tr></table></figure>

<p>全局配置，设置解析超时时间，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">  group_by: [&apos;alertname&apos;]      ##alertmanager中的分组，选哪个标签作为分组的依据</span><br><span class="line">  group_wait: 10s              ##分组等待时间，拿到第一条告警后等待10s，如果有其他的一起发送出去</span><br><span class="line">  group_interval: 10s          ##各个分组之前发搜告警的间隔时间</span><br><span class="line">  repeat_interval: 1h          ##重复告警时间，默认1小时</span><br><span class="line">  receiver: &apos;web.hook&apos;         ##接收者</span><br></pre></td></tr></table></figure>

<p>这里是配置告警的，配置告警怎么发送，怎么来分配，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">receivers:</span><br><span class="line">- name: &apos;web.hook&apos;</span><br><span class="line">  webhook_configs:</span><br><span class="line">  - url: &apos;http://127.0.0.1:5001/&apos;</span><br></pre></td></tr></table></figure>

<p>这里是配置告警的接收者，我要发送给谁，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: &apos;critical&apos;</span><br><span class="line">    target_match:</span><br><span class="line">      severity: &apos;warning&apos;</span><br><span class="line">    equal: [&apos;alertname&apos;, &apos;dev&apos;, &apos;instance&apos;]</span><br></pre></td></tr></table></figure>

<p>这里用于配置告警收敛的，主要就是减少发送告警，来发送一些关键的，所以先把这段注释了吧，暂时用不到，之后会用到，所以基于这个配置文件改改，暂时先发送 <code>email</code> 吧，所以改完的配置文件如下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@rj-bai</span> <span class="string">/usr/local/alertmanager]#</span> <span class="string">cat</span> <span class="string">alertmanager.yml</span> </span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">resolve_timeout:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">'smtp.163.com:25'</span>         <span class="comment">#smtp服务地址</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">'xxx@163.com'</span>                  <span class="comment">#发送邮箱</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">'xxx@163.com'</span>         <span class="comment">#认证用户名</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">'xxxx'</span>                <span class="comment">#认证密码</span></span><br><span class="line">  <span class="attr">smtp_require_tls:</span> <span class="literal">false</span>                   <span class="comment">#禁用tls</span></span><br><span class="line"></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">['alertname']</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1m</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">'email'</span>                      <span class="comment">#定义接受告警组名</span></span><br><span class="line"><span class="attr">receivers:</span>                                  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'email'</span>                          <span class="comment">#定义组名</span></span><br><span class="line">  <span class="attr">email_configs:</span>                         <span class="comment">#配置邮件</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xx@xxx.com'</span>                     <span class="comment">#收件人</span></span><br></pre></td></tr></table></figure>

<p>保存后检查一下这个文件有没有问题，命令如下，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai /usr/local/alertmanager]# ./amtool check-config alertmanager.yml </span><br><span class="line">Checking 'alertmanager.yml'  SUCCESS</span><br></pre></td></tr></table></figure>

<p>然后去启动吧，还是加到系统服务中吧，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@rj-bai /usr/local/alertmanager]# cat &gt; /usr/lib/systemd/system/alertmanager.service &lt;&lt;OEF </span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> [Unit]</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Description=alertmanager</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> [Service]</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Restart=on-failure</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ExecStart=/usr/<span class="built_in">local</span>/alertmanager/alertmanager --config.file=/usr/<span class="built_in">local</span>/alertmanager/alertmanager.yml</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> [Install]</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> WantedBy=multi-user.target</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> OEF</span></span><br><span class="line">[root@rj-bai /usr/local/alertmanager]# systemctl start alertmanager</span><br></pre></td></tr></table></figure>

<p>现在 <code>alertmanager</code> 是装完了，需要和 <code>prometheus</code> 融合一下，需要配置两部分，分别如下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9093</span>   <span class="comment">##配置alertmanager地址，我的在本机</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"rules/*.yml"</span>         <span class="comment">##配置告警规则的文件</span></span><br></pre></td></tr></table></figure>

<p>配置这两项就够了，保存之后创建 <code>rules</code> 目录，接下来就可以配置告警规则了。</p>
<h3 id="配置告警规则并邮件通知"><a href="#配置告警规则并邮件通知" class="headerlink" title="配置告警规则并邮件通知"></a>配置告警规则并邮件通知</h3><p>我直接在官方复制过来了一个例子顺便改了改，如下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@rj-bai</span> <span class="string">/usr/local/prometheus/rules]#</span> <span class="string">cat</span> <span class="string">example.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">exports.rules</span>     <span class="comment">##定义这组告警的组名，同性质的，都是监控实例exports是否开启的模板</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">采集器凉了</span>     <span class="comment">## 告警名称</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span>        <span class="comment">## 告警表达式，监控up指标，如果等于0就进行下面的操作</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span>              <span class="comment">## 持续一分钟为0进行告警</span></span><br><span class="line">    <span class="attr">labels:</span>              <span class="comment">## 定义告警级别</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">ERROR</span></span><br><span class="line">    <span class="attr">annotations:</span>         <span class="comment">## 定义了告警通知怎么写，默认调用了&#123;$labels.instance&amp;$labels.job&#125;的值</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">"实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 采集器凉了撒"</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">"实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> job 名为 <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> 的采集器凉了有一分钟了撒"</span></span><br></pre></td></tr></table></figure>

<p>每个实例都会有一个 <code>up</code> 的指标，上面的标签名 <code>job</code> 都能看到，用 <code>sql</code> 去查一下，</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus34.png"></p>
<p>采集器在开启状态下返回值就是 <code>1</code>，如果采集器出现问题没启动或是什么别的异常都会返回 <code>0</code>，<code>0</code> 就是代表异常了，所以说白了就是那条规则就是监控所有实例的 <code>up</code> 指标，如果指标值为 <code>0</code> 且持续时间超过一分钟我就要告警了，保存吧，直接重启 <code>prometheus</code> 吧，重启之后可以在 <code>web</code> 控制台看到你配置的规则了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus35.png"></p>
<p>既然配置完了，验证一下吧，随便关掉一个采集器，等邮件就行了，我把明月三千里的关掉了，然后发现有一条告警处于 <code>PENDING</code> 状态，他已经准备去通知 <code>alertmanager</code> 了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus36.png"></p>
<p>一分钟之后我收到邮件了，长这样，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus37.png"></p>
<p>如果问题没解决他每分钟都会给你发一封邮件，刚刚配置了，发送邮件的等待时间一会会细说一下，我再停一个，我再把 <code>docker</code> 停了，看看他发出的邮件是什么样的，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus38.png"></p>
<p>这里两条告警被合并到一个邮件里发出来了，这就是做了分组，如果你有同类告警的，也就是根据 <code>alertname</code>去区分的，都会给你合并，<code>mysql&amp;docker</code> 被合并到一起了，再看一下他还是支持哪些方式来告警，看<a href="https://prometheus.io/docs/alerting/configuration/" target="_blank" rel="noopener">这里</a>吧，拉到最下面可以看到支持微信，钉钉目前是不支持的，有第三方的，我将来会对接企业微信的，暂时现用邮件吧，下面看看 <code>alertmanager</code> 的告警状态吧。</p>
<h3 id="告警状态"><a href="#告警状态" class="headerlink" title="告警状态"></a>告警状态</h3><p>目前 <code>alertmanager</code> 告警状态分为三种，如下</p>
<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Inactive</td>
<td>什么都没有发生</td>
</tr>
<tr>
<td>Pending</td>
<td>已触发阈值，但未满足告警持续时间，for 时间</td>
</tr>
<tr>
<td>Firing</td>
<td>已触发阈值且满足告警持续时间，通知 alertmanager 你可以发送告警了</td>
</tr>
</tbody></table>
<p>在这个阶段是有个时间的，并不是出现问题告警会马上发出去，这个时间包含了数据采集时间、告警评估时间，这两个时间是在 <code>prometheus</code> 中配置的，也就是这里，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> </span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br></pre></td></tr></table></figure>

<p>目前是十五秒采集一次数据，评估告警规则时间也是十五秒，这个评估告警规则的时间就是我每隔多长时间要进行一次评估是否到达的阈值了，说白了这东西的目的就是为了减少告警的次数，更加精确的判断当前的状态是不是 <code>ok</code> 的，下面在看看告警的分配</p>
<h3 id="告警的分配"><a href="#告警的分配" class="headerlink" title="告警的分配"></a>告警的分配</h3><p>具体告警要怎么去分配，也是在 <code>alertmanager</code> 中配置的，也就是这一段，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">['alertname']</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1m</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">'email'</span></span><br></pre></td></tr></table></figure>

<p>这就是设置告警的分发策略了，这个 <code>route</code> 可以拆分成多个子路由，目前所有的告警都会发送到名为 <code>email</code> 的接收器里面，<code>email</code> 接收器的规则也是在配置文件中指定的，也就是这一段，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'email'</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xx@xxx.com'</span></span><br></pre></td></tr></table></figure>

<p>接收器目前只有一个名为 <code>email</code> 的，也可以有多个，如果你有什么特殊需求，需要将不同类型的告警发送给不同的人，就需要配置多个接收器去区分了，如下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">resolve_timeout:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">'smtp.163.com:25'</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">'xxx@163.com'</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">'xxx@163.com'</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">'xxx'</span></span><br><span class="line">  <span class="attr">smtp_require_tls:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">'default-receiver'</span>                  <span class="comment">##定义默认接收器名，如果其他的匹配不到走这个</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">4h</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">[cluster,</span> <span class="string">alertname]</span>                <span class="comment">##分组设置</span></span><br><span class="line">  <span class="attr">routes:</span>                                       <span class="comment">##子路由</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">'database-pager'</span>                  <span class="comment">##定义接收器名字          </span></span><br><span class="line">    <span class="attr">group_wait:</span> <span class="string">10s</span>                             <span class="comment">##分组设置</span></span><br><span class="line">    <span class="attr">match_re:</span>                                   <span class="comment">##正则匹配</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">mysql|cassandra</span>                  <span class="comment">##他会接收标签service值为mysql&amp;&amp;cassandra的告警</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">'frontend-pager'</span>                  <span class="comment">##接收器名</span></span><br><span class="line">    <span class="attr">group_by:</span> <span class="string">[product,</span> <span class="string">environment]</span>            <span class="comment">##分组设置</span></span><br><span class="line">    <span class="attr">match:</span>                                      <span class="comment">##直接匹配</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span>                            <span class="comment">##匹配标签team值为frontend的告警</span></span><br><span class="line"><span class="attr">receivers:</span>                                      <span class="comment">##定义接收器</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'default-receiver'</span>                      <span class="comment">##接收器名字</span></span><br><span class="line">  <span class="attr">email_configs:</span>                                <span class="comment">##邮件接口</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xxx.xx.com'</span>                            <span class="comment">##接收人，下面以此类推</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'database-pager'</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xxx.xx.com'</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'frontend-pager'</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xxx@.xx.com'</span></span><br></pre></td></tr></table></figure>

<p>我就不掩饰了，配置其实很简单，演示很麻烦撒，算了算了，过，下面看一哈告警收敛</p>
<h3 id="告警收敛"><a href="#告警收敛" class="headerlink" title="告警收敛"></a>告警收敛</h3><p>收敛就是尽量压缩告警邮件的数量，太多了谁都会懵逼，可能有些关键的被淹没了，<code>alertmanager</code> 中有很多收敛机制，最主要的就是分组抑制静默，<code>alertmanager</code> 收到告警之后他会先进行分组，然后进入通知队列，这个队列会对通知的邮件进行抑制静默，再根据 <code>router</code> 将告警路由到不同的接收器，这就是 <code>alertmanager</code> 收到一个告警后经历的阶段，只是一个大概的情况，下面深入了解一下这几个阶段到底是什么原理怎么去配置，先来简单看一下他们的定义</p>
<table>
<thead>
<tr>
<th>机制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>分组 (group)</td>
<td>将类似性质的告警合并为单个进行通知</td>
</tr>
<tr>
<td>抑制 (Inhibition)</td>
<td>当告警发生后，停止重复发送由此告警引发的其他告警</td>
</tr>
<tr>
<td>静默 (Silences)</td>
<td>是一种简单的特定时间静音提醒的机制</td>
</tr>
</tbody></table>
<h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><p>举个例子，比如说我在阿里云有 <code>10</code> 台服务器，但是我忘续费了，结果服务器到期都被停掉了 (真实发生过)，这时候 <code>node_exports</code> 肯定也无法访问了，服务器都停了，这时候普罗米修斯发现这 <code>10</code> 个服务器都凉了，我要准备通知 <code>alertmanager</code> 告警了，在不做分组的情况下你的告警媒介会有十条信息发出来，这种情况下我们可以他这些信息合并到一起撒，一条信息列出哪些服务器凉了。</p>
<p>其实分组设置最开始的时候我就做了，这一段就是设置分组的，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">['alertname']</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1m</span></span><br></pre></td></tr></table></figure>

<p>这里配置了分组的依据，默认就是 <code>alertname</code>，这个名字可以随便写的，做了分组之后他会去匹配你告警时的名字，告警的名字是在这里配置的，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">采集器凉了</span></span><br></pre></td></tr></table></figure>

<p>如果是相同名字的告警在一定时间内出现多条，这个一定时间指的就是 <code>group_wait</code> 的时间，那么多条就会合并成一条告警信息发出来，这个之前就配置了，所以在我停掉 <code>mysql&amp;docker</code> 采集器之后他就把这两条告警合并成一条信息发了出来，也就是这张图，上面贴过了。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus39.png"></p>
<p>这两条的告警名字都是采集器凉了撒，而且在十秒钟之内出现了两条，所以就被合并成一条发出来了，分组的目的就是为了减少告警信息的数量，同类告警聚合，所以现在总结一下配置分组的参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">group_by:</span> <span class="string">['alertname']</span>  <span class="comment">#根据标签进行alert分组，可以写多个</span></span><br><span class="line"><span class="attr">group_wait:</span> <span class="string">10s</span>          <span class="comment">#发送告警等待时间，</span></span><br><span class="line"><span class="attr">group_interval:</span> <span class="string">10s</span>      <span class="comment">#分组告警信息间隔时间，譬如两组，第一组发送后等待十秒发送第二组</span></span><br><span class="line"><span class="attr">repeat_interval:</span> <span class="string">1m</span>      <span class="comment">#重复发送告警时间，时间不要太短，也不要太长</span></span><br></pre></td></tr></table></figure>



<h4 id="抑制"><a href="#抑制" class="headerlink" title="抑制"></a>抑制</h4><p>他的主要作用就是消除冗余告警，我们会受到一个关键的告警信息，这个也是在 <code>alertmanager</code> 中配置的，我标签只留了一个，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span>          </span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'critical'</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'warning'</span></span><br><span class="line">    <span class="attr">equal:</span> <span class="string">['instance']</span></span><br></pre></td></tr></table></figure>

<p>这段配置意思就是当我收到一个告警级别为 <code>critical</code> 时，他就会抑制掉 <code>warning</code> 这个级别的告警，这个告警等级是在你编写规则的时候定义的，最后一行就是要对哪些告警做抑制，通过标签匹配的，我这里只留了一个 <code>instance</code>，举个最简单的例子，当现在 <code>alertmanager</code> 先收到一条 <code>critical</code>、又收到一条 <code>warning</code> 且 <code>instance</code> 值一致的两条告警他的处理逻辑是怎样的。</p>
<p>我现在监控 <code>nginx</code>，<code>nginx</code> 宕掉的告警级别为 <code>warning</code>，宿主机宕掉的告警级别为 <code>critical</code>，譬如说现在我跑 <code>nginx</code> 的服务器凉了，这时候 <code>nginx</code> 肯定也凉了，普罗米修斯发现后通知 <code>alertmanager</code>，普罗米修斯发过来的是两条告警信息，一条是宿主机凉了的，一条是 <code>nginx</code> 凉了的，<code>alertmanager</code> 收到之后，发现告警级别一条是 <code>critical</code>，一条是 <code>warning</code>，而且 <code>instance</code> 标签值一致，也就是说这是在一台机器上发生的，所以他就会只发一条 <code>critical</code> 的告警出来，<code>warning</code> 的就被抑制掉了，我们收到的就是服务器凉了的通知，大概就是这样，暂时不演示了。</p>
<h4 id="静默"><a href="#静默" class="headerlink" title="静默"></a>静默</h4><p>就是一个简单的特定时间静音提醒的机制，主要是使用标签匹配这一批不发送告警，譬如说我某天要对服务器进行维护，可能会涉及到服务器重启，在这期间肯定会有 <code>N</code> 多告警发出来，所以你可以子啊这期间配置一个静默，这类的告警就不要发了，我知道发生了啥子事情，配置静默就很简单了，直接在 <code>web</code> 页面配置就行了，<code>9093</code> 端口，</p>
<p>​    </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus40.png"></p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus41.png"></p>
<p>选择开始时间结束时间，通过标签匹配去做，我匹配了 <code>job=docker</code> 的机器，创建，所以我先在把容器采集器停掉也不会有告警出来了，我就不停了，就是这样配置，比较简单，扯了一堆，是时候自己写一个告警规则了，结合上面一切的东西。</p>
<h2 id="编写告警规则例子"><a href="#编写告警规则例子" class="headerlink" title="编写告警规则例子"></a>编写告警规则例子</h2><p>来监控内存吧，内存使用率超过 <code>80</code> 我就要告警了，还是先需要写 <code>sql</code>，把我想要的值查出来，所以要查当前内存使用率大于百分之八十的 <code>sql</code> 如下，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_MemTotal_bytes - node_memory_MemFree_bytes - node_memory_Buffers_bytes - node_memory_Cached_bytes) / (node_memory_MemTotal_bytes )* 100 &gt; 80</span><br></pre></td></tr></table></figure>

<p>下面就是要写规则了，我写的规则如下，顺便把之前的规则也改了一下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@rj-bai</span> <span class="string">/usr/local/prometheus/rules]#</span> <span class="string">cat</span> <span class="string">memory.yml</span> </span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">memeory_rules</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">内存炸了</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">(node_memory_MemTotal_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_MemFree_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_Buffers_bytes</span> <span class="bullet">-</span> <span class="string">node_memory_Cached_bytes)</span> <span class="string">/</span> <span class="string">(node_memory_MemTotal_bytes</span> <span class="string">)*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 内存炸了"</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 内存炸了，当前使用率为 <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<p>这样就可以了，我又把明月三千里加入到监控，也就是安装了 <code>node_exports</code>，现在也能正常获取到使用率了，下面试试上面提到的那个告警分配，我要把明月三千里的告警信息发送到我另一个邮箱，<code>job</code> 名字 <code>mysql</code>，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'mysql'</span></span><br><span class="line">  <span class="attr">static_configs:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['192.168.1.126:9104']</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['192.168.1.126:9100']</span></span><br></pre></td></tr></table></figure>

<p>重启一下撒，能看到这些，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus42.png"></p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus43.png"></p>
<p>然后去配置一下告警的分配，我要把关于明月三千里的告警发送到另一个邮箱，所以这里改了一哈，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">['alertname']</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">'default-receiver'</span></span><br><span class="line">  <span class="attr">routes:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group_by:</span> <span class="string">['mysql']</span></span><br><span class="line">      <span class="attr">group_wait:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">group_interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">repeat_interval:</span> <span class="string">5m</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">'mysql-pager'</span></span><br><span class="line">      <span class="attr">match_re:</span></span><br><span class="line">        <span class="attr">job:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'default-receiver'</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xxx@xx.com'</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'mysql-pager'</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xxx@xx.cn'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span>          </span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'critical'</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'warning'</span></span><br><span class="line">    <span class="attr">equal:</span> <span class="string">['instance']</span></span><br></pre></td></tr></table></figure>

<p>所以一会收到明月三千里的邮件是我 <code>cn</code> 的邮箱，这样就可以了撒，重启 <code>alertmanager</code>，为了让他发出告警邮件，我调一下阈值，改为百分之 <code>20</code>，所以我 <code>com</code> 收到的邮件如下，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus44.png"></p>
<p><code>cn</code> 收到的邮件如下</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus45.png"></p>
<p>然后再试一下抑制，我再加一个监控项，我要监控 <code>TCP</code> 连接数，状态是 <code>ESTABLISHED</code> 的，超过 <code>300</code> 我就要告警了，定义告警级别为 <code>critical</code>，所以 <code>rule</code> 文件如下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@rj-bai</span> <span class="string">/usr/local/prometheus/rules]#</span> <span class="string">cat</span> <span class="string">tcp-established.yml</span> </span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-established_rules</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">TCP连接数过高</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">node_sockstat_TCP_alloc</span> <span class="string">&gt;</span> <span class="number">300</span> </span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> TCP连接数过高"</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> TCP连接数过高，当前连接数 <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<p>重启后看页面，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus46.png"></p>
<p>有三条告警已经进入 <code>Pending</code> 状态了，没意外的话 <code>cn</code> 邮箱只有一条告诉你连接数过高的告警信息发出来了，内存使用率过高的就会被抑制，看一下，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus47.png"></p>
<p>所以这条已经被抑制了，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus48.png"></p>
<p><code>248</code> 服务器不受影响，<code>com</code> 邮箱还是会收到内存炸了的告警，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/prometheus49.png"></p>
<p>就是这样，你想编写其他的告警规则流程和上面是一样的，告警的分配和抑制不是必需的，自行琢磨吧，下一篇准备重写 <code>K8S</code> 监控方面的东西，了解这些东西之后之后就应该很简单了撒，本篇就这样，过。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Wang YangYang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://wangyangyangisme.github.io/2019/12/17/microservice-Prometheus+Grafana/">http://wangyangyangisme.github.io/2019/12/17/microservice-Prometheus+Grafana/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://wangyangyangisme.github.io" target="_blank">WangYangYang</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/76bc52296bcf2e0b7a1d628106ffcd52.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/fab2285fdcd13ead0a8b4a853c659d03.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/12/18/frontend-Sass%E4%B8%AD%E6%96%87%E6%95%99%E7%A8%8B/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/frontend/f3c25ef166567f187404b8d4f2357d99.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Sass中文教程</div></div></a></div><div class="next-post pull_right"><a href="/2019/12/17/docker-docker%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/docker/4d51cecf7d26dfa720682ee0425872d5.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">docker管理工具</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: true,
  verify: false,
  appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
  appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
  placeholder: '请留下你的脚印',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-cn',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Wang YangYang</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyangyangisme.github.io/">blog</a>!</div><div class="icp"><a><img class="icp-icon" src="/img/icp.png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/click_heart.js"></script><script src="/js/search/algolia.js"></script></body></html>