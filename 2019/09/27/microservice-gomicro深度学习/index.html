<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>gomicro深度学习 | WangYangYang</title><meta name="description" content="gomicro深度学习"><meta name="author" content="Wang YangYang"><meta name="copyright" content="Wang YangYang"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="gomicro深度学习"><meta name="twitter:description" content="gomicro深度学习"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/958a3c375861938b04a84b0f4fe8a4ad.jpg"><meta property="og:type" content="article"><meta property="og:title" content="gomicro深度学习"><meta property="og:url" content="http://wangyangyangisme.github.io/2019/09/27/microservice-gomicro%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><meta property="og:site_name" content="WangYangYang"><meta property="og:description" content="gomicro深度学习"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/958a3c375861938b04a84b0f4fe8a4ad.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://wangyangyangisme.github.io/2019/09/27/microservice-gomicro%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><link rel="prev" title="go微服务库" href="http://wangyangyangisme.github.io/2019/09/27/microservice-go%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%93/"><link rel="next" title="etcd集群配置" href="http://wangyangyangisme.github.io/2019/09/27/microservice-etcd%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"C4QN4OTLJM","apiKey":"c2c026ba64eeb77abd2164975fa41f34","indexName":"wyy","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://wangyangyangisme.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">194</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">39</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#gomicro深度学习"><span class="toc-text">gomicro深度学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-整体架构介绍"><span class="toc-text">1.整体架构介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1通信流程"><span class="toc-text">1.1通信流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2Transort"><span class="toc-text">1.2Transort</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3Codec"><span class="toc-text">1.3Codec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4Registry"><span class="toc-text">1.4Registry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5Selector"><span class="toc-text">1.5Selector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6Broker"><span class="toc-text">1.6Broker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7Client"><span class="toc-text">1.7Client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8Server"><span class="toc-text">1.8Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9Service"><span class="toc-text">1.9Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-入门例子"><span class="toc-text">2.入门例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装所需要的环境"><span class="toc-text">安装所需要的环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例子1"><span class="toc-text">例子1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例子2"><span class="toc-text">例子2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Registry服务的注册和发现"><span class="toc-text">3.Registry服务的注册和发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go-micro-服务端注册服务"><span class="toc-text">go-micro 服务端注册服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端发现服务"><span class="toc-text">客户端发现服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-rpc方法调用过程详解"><span class="toc-text">4.rpc方法调用过程详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务的启动"><span class="toc-text">服务的启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端调用服务方法"><span class="toc-text">客户端调用服务方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端处理请求"><span class="toc-text">服务端处理请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-stream-调用过程详解"><span class="toc-text">5.stream 调用过程详解</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/958a3c375861938b04a84b0f4fe8a4ad.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">WangYangYang</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">gomicro深度学习</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-09-27<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-11-06</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/microservice/">microservice</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">11k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 49 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2019/09/27/microservice-gomicro%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/09/27/microservice-gomicro%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="gomicro深度学习"><a href="#gomicro深度学习" class="headerlink" title="gomicro深度学习"></a>gomicro深度学习</h1><h2 id="1-整体架构介绍"><a href="#1-整体架构介绍" class="headerlink" title="1.整体架构介绍"></a>1.整体架构介绍</h2><p>产品嘴里的一个小项目，从立项到开发上线，随着时间和需求的不断激增，会越来越复杂，变成一个大项目，如果前期项目架构没设计的不好，代码会越来越臃肿，难以维护，后期的每次产品迭代上线都会牵一发而动全身。项目微服务化，松耦合模块间的关系，是一个很好的选择，随然增加了维护成本，但是还是很值得的。 </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-1.png"></p>
<p>微服务化项目除了稳定性我个人还比较关心的几个问题：</p>
<ul>
<li><p>一: 服务间数据传输的效率和安全性。</p>
</li>
<li><p>二: 服务的动态扩充，也就是服务的注册和发现，服务集群化。</p>
</li>
<li><p>三: 微服务功能的可订制化，因为并不是所有的功能都会很符合你的需求，难免需要根据自己的需要二次开发一些功能。</p>
</li>
</ul>
<p>go-micro是go语言下的一个很好的<code>rpc</code>微服务框架，功能很完善，而且我关心的几个问题也解决的很好：</p>
<ul>
<li><p>一：服务间传输格式为<code>protobuf</code>，效率上没的说，非常的快，也很安全。</p>
</li>
<li><p>二：go-micro的服务注册和发现是多种多样的。我个人比较喜欢<code>etcdv3</code>的服务服务发现和注册。</p>
</li>
<li><p>三：主要的功能都有相应的接口，只要实现相应的接口，就可以根据自己的需要订制插件。</p>
</li>
</ul>
<h3 id="1-1通信流程"><a href="#1-1通信流程" class="headerlink" title="1.1通信流程"></a>1.1通信流程</h3><p>go-micro的通信流程大至如下</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-2.png"></p>
<p>Server监听客户端的调用，和<code>Brocker</code>推送过来的信息进行处理。并且Server端需要向<code>Register</code>注册自己的存在或消亡，这样Client才能知道自己的状态。</p>
<p>Register服务的注册的发现。</p>
<p>Client端从Register中得到Server的信息，然后每次调用都根据算法选择一个的Server进行通信，当然通信是要经过编码/解码，选择传输协议等一系列过程的。</p>
<p>如果有需要通知所有的Server端可以使用<code>Brocker</code>进行信息的推送。</p>
<p><code>Brocker</code>信息队列进行信息的接收和发布。</p>
<p>go-micro之所以可以高度订制和他的框架结构是分不开的，go-micro由8个关键的interface组成，每一个interface都可以根据自己的需求重新实现，这8个主要的<code>inteface</code>也构成了go-micro的框架结构。 </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-3.png"></p>
<p>这些接口go-micro都有他自己默认的实现方式，还有一个<code>go-plugins</code>是对这些接口实现的可替换项。你也可以根据需求实现自己的插件。  </p>
<h3 id="1-2Transort"><a href="#1-2Transort" class="headerlink" title="1.2Transort"></a>1.2Transort</h3><p>服务之间通信的接口。也就是服务发送和接收的最终实现方式，是由这些接口定制的。</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Transport <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) error</span><br><span class="line">	Options() Options</span><br><span class="line">	Dial(addr <span class="keyword">string</span>, opts ...DialOption) (Client, error)</span><br><span class="line">	Listen(addr <span class="keyword">string</span>, opts ...ListenOption) (Listener, error)</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Socket <span class="keyword">interface</span> &#123;</span><br><span class="line">	Recv(*Message) error</span><br><span class="line">	Send(*Message) error</span><br><span class="line">	Close() error</span><br><span class="line">	Local() <span class="keyword">string</span></span><br><span class="line">	Remote() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">interface</span> &#123;</span><br><span class="line">	Socket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Listener <span class="keyword">interface</span> &#123;</span><br><span class="line">	Addr() <span class="keyword">string</span></span><br><span class="line">	Close() error</span><br><span class="line">	Accept(<span class="function"><span class="keyword">func</span><span class="params">(Socket)</span>) <span class="title">error</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Transport 的Listen方法是一般是Server端进行调用的，他监听一个端口，等待客户端调用。</p>
<p>Transport 的Dial就是客户端进行连接服务的方法。他返回一个Client接口，这个接口返回一个Client接口，这个Client嵌入了Socket接口，这个接口的方法就是具体发送和接收通信的信息。</p>
<p>http传输是go-micro默认的同步通信机制。当然还有很多其他的插件：grpc,nats,tcp,udp,rabbitmq,nats，都是目前已经实现了的方式。在go-plugins里你都可以找到。</p>
<h3 id="1-3Codec"><a href="#1-3Codec" class="headerlink" title="1.3Codec"></a>1.3Codec</h3><p>有了传输方式，下面要解决的就是传输编码和解码问题，go-micro有很多种编码解码方式，默认的实现方式是protobuf,当然也有其他的实现方式，json、protobuf、jsonrpc、mercury等等。</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Codec <span class="keyword">interface</span> &#123;</span><br><span class="line">	Reader</span><br><span class="line">	Writer</span><br><span class="line">	Close() error</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">	ReadHeader(*Message, MessageType) error</span><br><span class="line">	ReadBody(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Write(*Message, <span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Marshaler is a simple encoding interface used for the broker/transport</span></span><br><span class="line"><span class="comment">// where headers are not supported by the underlying implementation.</span></span><br><span class="line"><span class="keyword">type</span> Marshaler <span class="keyword">interface</span> &#123;</span><br><span class="line">	Marshal(<span class="keyword">interface</span>&#123;&#125;) ([]<span class="keyword">byte</span>, error)</span><br><span class="line">	Unmarshal([]<span class="keyword">byte</span>, <span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Message represents detailed information about</span></span><br><span class="line"><span class="comment">// the communication, likely followed by the body.</span></span><br><span class="line"><span class="comment">// In the case of an error, body may be nil.</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id       <span class="keyword">string</span></span><br><span class="line">	Type     MessageType</span><br><span class="line">	Target   <span class="keyword">string</span></span><br><span class="line">	Method   <span class="keyword">string</span></span><br><span class="line">	Endpoint <span class="keyword">string</span></span><br><span class="line">	Error    <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The values read from the socket</span></span><br><span class="line">	Header <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">	Body   []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Codec接口的Write方法就是编码过程，两个Read是解码过程。</p>
<h3 id="1-4Registry"><a href="#1-4Registry" class="headerlink" title="1.4Registry"></a>1.4Registry</h3><p>服务的注册和发现，目前实现的consul,mdns, etcd,etcdv3,zookeeper,kubernetes.等等，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The registry provides an interface for service discovery</span></span><br><span class="line"><span class="comment">// and an abstraction over varying implementations</span></span><br><span class="line"><span class="comment">// &#123;consul, etcd, zookeeper, ...&#125;</span></span><br><span class="line"><span class="keyword">type</span> Registry <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) error</span><br><span class="line">	Options() Options</span><br><span class="line">	Register(*Service, ...RegisterOption) error</span><br><span class="line">	Deregister(*Service) error</span><br><span class="line">	GetService(<span class="keyword">string</span>) ([]*Service, error)</span><br><span class="line">	ListServices() ([]*Service, error)</span><br><span class="line">	Watch(...WatchOption) (Watcher, error)</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说，就是Service 进行Register，来进行注册，Client 使用watch方法进行监控，当有服务加入或者删除时这个方法会被触发，以提醒客户端更新Service信息。</p>
<p>默认的是服务注册和发现是mdns</p>
<p>consul.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configure</span><span class="params">(c *consulRegistry, opts ...registry.Option)</span></span> &#123;</span><br><span class="line">	<span class="comment">// set opts</span></span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		o(&amp;c.opts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use default config</span></span><br><span class="line">	config := consul.DefaultConfig()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.opts.Context != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Use the consul config passed in the options, if available</span></span><br><span class="line">		<span class="keyword">if</span> co, ok := c.opts.Context.Value(<span class="string">"consul_config"</span>).(*consul.Config); ok &#123;</span><br><span class="line">			config = co</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> cn, ok := c.opts.Context.Value(<span class="string">"consul_connect"</span>).(<span class="keyword">bool</span>); ok &#123;</span><br><span class="line">			c.connect = cn</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Use the consul query options passed in the options, if available</span></span><br><span class="line">		<span class="keyword">if</span> qo, ok := c.opts.Context.Value(<span class="string">"consul_query_options"</span>).(*consul.QueryOptions); ok &amp;&amp; qo != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.queryOptions = qo</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> as, ok := c.opts.Context.Value(<span class="string">"consul_allow_stale"</span>).(<span class="keyword">bool</span>); ok &#123;</span><br><span class="line">			c.queryOptions.AllowStale = as</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check if there are any addrs</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(c.opts.Addrs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		addr, port, err := net.SplitHostPort(c.opts.Addrs[<span class="number">0</span>])</span><br><span class="line">		<span class="keyword">if</span> ae, ok := err.(*net.AddrError); ok &amp;&amp; ae.Err == <span class="string">"missing port in address"</span> &#123;</span><br><span class="line">			port = <span class="string">"8500"</span></span><br><span class="line">			addr = c.opts.Addrs[<span class="number">0</span>]</span><br><span class="line">			config.Address = fmt.Sprintf(<span class="string">"%s:%s"</span>, addr, port)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			config.Address = fmt.Sprintf(<span class="string">"%s:%s"</span>, addr, port)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> config.HttpClient == <span class="literal">nil</span> &#123;</span><br><span class="line">		config.HttpClient = <span class="built_in">new</span>(http.Client)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// requires secure connection?</span></span><br><span class="line">	<span class="keyword">if</span> c.opts.Secure || c.opts.TLSConfig != <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">		config.Scheme = <span class="string">"https"</span></span><br><span class="line">		<span class="comment">// We're going to support InsecureSkipVerify</span></span><br><span class="line">		config.HttpClient.Transport = newTransport(c.opts.TLSConfig)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set timeout</span></span><br><span class="line">	<span class="keyword">if</span> c.opts.Timeout &gt; <span class="number">0</span> &#123;</span><br><span class="line">		config.HttpClient.Timeout = c.opts.Timeout</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create the client</span></span><br><span class="line">	client, _ := consul.NewClient(config)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set address/client</span></span><br><span class="line">	c.Address = config.Address</span><br><span class="line">	c.Client = client</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我个人比较喜欢etcdv3集群。大家可以根据自己的喜好选择。</p>
<h3 id="1-5Selector"><a href="#1-5Selector" class="headerlink" title="1.5Selector"></a>1.5Selector</h3><p>以Registry为基础，Selector 是客户端级别的负载均衡，当有客户端向服务发送请求时，  selector根据不同的算法从Registery中的主机列表，得到可用的Service节点，进行通信。目前实现的有循环算法和随机算法，默认的是随机算法。</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Selector builds on the registry as a mechanism to pick nodes</span></span><br><span class="line"><span class="comment">// and mark their status. This allows host pools and other things</span></span><br><span class="line"><span class="comment">// to be built using various algorithms.</span></span><br><span class="line"><span class="keyword">type</span> Selector <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(opts ...Option) error</span><br><span class="line">	Options() Options</span><br><span class="line">	<span class="comment">// Select returns a function which should return the next node</span></span><br><span class="line">	Select(service <span class="keyword">string</span>, opts ...SelectOption) (Next, error)</span><br><span class="line">	<span class="comment">// Mark sets the success/error against a node</span></span><br><span class="line">	Mark(service <span class="keyword">string</span>, node *registry.Node, err error)</span><br><span class="line">	<span class="comment">// Reset returns state back to zero for a service</span></span><br><span class="line">	Reset(service <span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// Close renders the selector unusable</span></span><br><span class="line">	Close() error</span><br><span class="line">	<span class="comment">// Name of the selector</span></span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认的是实现是本地缓存，当前实现的有blacklist,label,named等方式。</p>
<h3 id="1-6Broker"><a href="#1-6Broker" class="headerlink" title="1.6Broker"></a>1.6Broker</h3><p>Broker是消息发布和订阅的接口。很简单的一个例子，因为服务的节点是不固定的，如果有需要修改所有服务行为的需求，可以使服务订阅某个主题，当有信息发布时，所有的监听服务都会收到信息，根据你的需要做相应的行为。</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Broker is an interface used for asynchronous messaging.</span></span><br><span class="line"><span class="keyword">type</span> Broker <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) error</span><br><span class="line">	Options() Options</span><br><span class="line">	Address() <span class="keyword">string</span></span><br><span class="line">	Connect() error</span><br><span class="line">	Disconnect() error</span><br><span class="line">	Publish(topic <span class="keyword">string</span>, m *Message, opts ...PublishOption) error</span><br><span class="line">	Subscribe(topic <span class="keyword">string</span>, h Handler, opts ...SubscribeOption) (Subscriber, error)</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Broker默认的实现方式是http方式，但是这种方式不要在生产环境用。go-plugins里有很多成熟的消息队列实现方式，有kafka、nsq、rabbitmq、redis，等等。</p>
<h3 id="1-7Client"><a href="#1-7Client" class="headerlink" title="1.7Client"></a>1.7Client</h3><p>Client是请求服务的接口，他封装Transport和Codec进行rpc调用，也封装了Brocker进行信息的发布。</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">interface</span> &#123;</span><br><span class="line">    Init(...Option) error</span><br><span class="line">    Options() Options</span><br><span class="line">    NewMessage(topic <span class="keyword">string</span>, msg <span class="keyword">interface</span>&#123;&#125;, opts ...MessageOption) Message</span><br><span class="line">    NewRequest(service, method <span class="keyword">string</span>, req <span class="keyword">interface</span>&#123;&#125;, reqOpts ...RequestOption) Request</span><br><span class="line">    Call(ctx context.Context, req Request, rsp <span class="keyword">interface</span>&#123;&#125;, opts ...CallOption) error</span><br><span class="line">    Stream(ctx context.Context, req Request, opts ...CallOption) (Stream, error)</span><br><span class="line">    Publish(ctx context.Context, msg Message, opts ...PublishOption) error</span><br><span class="line">    String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然他也支持双工通信 Stream 这些具体的实现方式和使用方式，以后会详细解说。</p>
<p>默认的是rpc实现方式，他还有grpc和http方式，在go-plugins里可以找到</p>
<h3 id="1-8Server"><a href="#1-8Server" class="headerlink" title="1.8Server"></a>1.8Server</h3><p>Server看名字大家也知道是做什么的了。监听等待rpc请求。监听broker的订阅信息，等待信息队列的推送等。</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server is a simple micro server abstraction</span></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">interface</span> &#123;</span><br><span class="line">	Options() Options</span><br><span class="line">	Init(...Option) error</span><br><span class="line">	Handle(Handler) error</span><br><span class="line">	NewHandler(<span class="keyword">interface</span>&#123;&#125;, ...HandlerOption) Handler</span><br><span class="line">	NewSubscriber(<span class="keyword">string</span>, <span class="keyword">interface</span>&#123;&#125;, ...SubscriberOption) Subscriber</span><br><span class="line">	Subscribe(Subscriber) error</span><br><span class="line">	Start() error</span><br><span class="line">	Stop() error</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Router handle serving messages</span></span><br><span class="line"><span class="keyword">type</span> Router <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// ServeRequest processes a request to completion</span></span><br><span class="line">	ServeRequest(context.Context, Request, Response) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Message is an async message interface</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">interface</span> &#123;</span><br><span class="line">	Topic() <span class="keyword">string</span></span><br><span class="line">	Payload() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	ContentType() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Request is a synchronous request interface</span></span><br><span class="line"><span class="keyword">type</span> Request <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Service name requested</span></span><br><span class="line">	Service() <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// The action requested</span></span><br><span class="line">	Method() <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Endpoint name requested</span></span><br><span class="line">	Endpoint() <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Content type provided</span></span><br><span class="line">	ContentType() <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Header of the request</span></span><br><span class="line">	Header() <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Body is the initial decoded value</span></span><br><span class="line">	Body() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="comment">// Read the undecoded request body</span></span><br><span class="line">	Read() ([]<span class="keyword">byte</span>, error)</span><br><span class="line">	<span class="comment">// The encoded message stream</span></span><br><span class="line">	Codec() codec.Reader</span><br><span class="line">	<span class="comment">// Indicates whether its a stream</span></span><br><span class="line">	Stream() <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Response is the response writer for unencoded messages</span></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Encoded writer</span></span><br><span class="line">	Codec() codec.Writer</span><br><span class="line">	<span class="comment">// Write the header</span></span><br><span class="line">	WriteHeader(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// write a response directly to the client</span></span><br><span class="line">	Write([]<span class="keyword">byte</span>) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stream represents a stream established with a client.</span></span><br><span class="line"><span class="comment">// A stream can be bidirectional which is indicated by the request.</span></span><br><span class="line"><span class="comment">// The last error will be left in Error().</span></span><br><span class="line"><span class="comment">// EOF indicates end of the stream.</span></span><br><span class="line"><span class="keyword">type</span> Stream <span class="keyword">interface</span> &#123;</span><br><span class="line">	Context() context.Context</span><br><span class="line">	Request() Request</span><br><span class="line">	Send(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	Recv(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	Error() error</span><br><span class="line">	Close() error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handler interface represents a request handler. It's generated</span></span><br><span class="line"><span class="comment">// by passing any type of public concrete object with endpoints into server.NewHandler.</span></span><br><span class="line"><span class="comment">// Most will pass in a struct.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Example:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      type Greeter struct &#123;&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      func (g *Greeter) Hello(context, request, response) error &#123;</span></span><br><span class="line"><span class="comment">//              return nil</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	Name() <span class="keyword">string</span></span><br><span class="line">	Handler() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	Endpoints() []*registry.Endpoint</span><br><span class="line">	Options() HandlerOptions</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Subscriber interface represents a subscription to a given topic using</span></span><br><span class="line"><span class="comment">// a specific subscriber function or object with endpoints.</span></span><br><span class="line"><span class="keyword">type</span> Subscriber <span class="keyword">interface</span> &#123;</span><br><span class="line">	Topic() <span class="keyword">string</span></span><br><span class="line">	Subscriber() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	Endpoints() []*registry.Endpoint</span><br><span class="line">	Options() SubscriberOptions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认的是rpc实现方式，他还有grpc和http方式，在go-plugins里可以找到</p>
<h3 id="1-9Service"><a href="#1-9Service" class="headerlink" title="1.9Service"></a>1.9Service</h3><p>Service是Client和Server的封装，他包含了一系列的方法使用初始值去初始化Service和Client，使我们可以很简单的创建一个rpc服务。</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service is an interface that wraps the lower level libraries</span></span><br><span class="line"><span class="comment">// within go-micro. Its a convenience method for building</span></span><br><span class="line"><span class="comment">// and initialising services.</span></span><br><span class="line"><span class="keyword">type</span> Service <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option)</span><br><span class="line">	Options() Options</span><br><span class="line">	Client() client.Client</span><br><span class="line">	Server() server.Server</span><br><span class="line">	Run() error</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-入门例子"><a href="#2-入门例子" class="headerlink" title="2.入门例子"></a>2.入门例子</h2><p>上一篇帖子简单介绍了go-micro的整体框架结构，这一篇主要写go-micro使用方式的例子，中间会穿插一些go-micro的源码，和调用流程图，帮大家更好的理解go-micro的底层。更详细更具体的调用流程和细节，会在以后的帖子里详细讲解。</p>
<blockquote>
<p>例子的github地址： <a href="https://github.com/lpxxn/gomicrorpc" target="_blank" rel="noopener">gomicrorpc</a>   跑一遍例子，也就会明白个大概。</p>
</blockquote>
<h3 id="安装所需要的环境"><a href="#安装所需要的环境" class="headerlink" title="安装所需要的环境"></a>安装所需要的环境</h3><p>go-micro服务发现默认使用的是<a href="https://www.consul.io/downloads.html" target="_blank" rel="noopener">consul</a>，(2019年源码修改了默认使用mdns)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install consul</span><br><span class="line">consul agent -dev</span><br></pre></td></tr></table></figure>

<p>者直接使用使用docker跑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8300:8300 -p 8301:8301 -p 8301:8301/udp -p 8302:8302/udp -p 8302:8302 -p 8400:8400 -p 8500:8500 -p 53:53/udp consul</span><br></pre></td></tr></table></figure>

<p>我个人更喜欢<a href="https://github.com/etcd-io/etcd/tree/v3.2.17" target="_blank" rel="noopener">etcdv3</a>原因我上一篇也有提到过，gomicro服务发现不支持consul集群，我之前也写过<a href="https://www.cnblogs.com/li-peng/p/9259793.html" target="_blank" rel="noopener">etcdv3 集群的搭建和使用</a>帖子，有时间大家可以看一下</p>
<p>安装go-micro框架</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/micro/go-micro</span><br></pre></td></tr></table></figure>

<p>安装protobuf和依赖 prtobuf的基础知识我这里就不讲了，如果不了解的可以看一下<a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">官方文档</a>，就是一个跨平台，跨语言的数据序列化库，简单易学。</p>
<p>是go-micro用于帮助我们生成服务接口和一系列的调用代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install protobuf</span><br><span class="line">go get -u -v github.com/golang/protobuf/&#123;proto,protoc-gen-go&#125;</span><br><span class="line">go get -u -v github.com/micro/protoc-gen-micro</span><br></pre></td></tr></table></figure>

<p>protobuf也可以直接从源码安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protobuf-all-3.6.1.tar.gz</span><br><span class="line">tar zxvf protobuf-all-3.6.1.tar.gz</span><br><span class="line">cd protobuf-3.6.1/</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line"> make</span><br><span class="line">make install</span><br><span class="line">protoc -h</span><br></pre></td></tr></table></figure>

<p>安装micro工具包，这个安装是可选项，micro提供了一系列的工具来帮助我们更好的使用go-micro。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/micro/micro</span><br></pre></td></tr></table></figure>

<h3 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h3><p>创建proto文件common.proto，这个文件包含了传入和返回的参数，参数包含了常用的基础类型、数组、map等。还有一个Say 服务，这个服务里有一个rpc方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> model;</span><br><span class="line"></span><br><span class="line">message SayParam &#123;</span><br><span class="line">    <span class="keyword">string</span> msg = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Pair &#123;</span><br><span class="line">    <span class="keyword">int32</span> key = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">string</span> values = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message SayResponse &#123;</span><br><span class="line">    <span class="keyword">string</span> msg = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 数组</span></span><br><span class="line">    repeated <span class="keyword">string</span> values = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// map</span></span><br><span class="line">    <span class="keyword">map</span>&lt;<span class="keyword">string</span>, Pair&gt; header = <span class="number">3</span>;</span><br><span class="line">    RespType <span class="keyword">type</span> = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enum RespType &#123;</span><br><span class="line">    NONE = <span class="number">0</span>;</span><br><span class="line">    ASCEND = <span class="number">1</span>;</span><br><span class="line">    DESCEND = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务接口</span></span><br><span class="line">service Say &#123;</span><br><span class="line">    rpc Hello(SayParam) returns (SayResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在根目录下运行，生成两个模板文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --proto_path&#x3D;$GOPATH&#x2F;src:. --micro_out&#x3D;. --go_out&#x3D;. example1&#x2F;proto&#x2F;*.proto</span><br></pre></td></tr></table></figure>

<p>一个文件是proto的go 结构文件，还有一个go-micro rpc的接口文件。</p>
<p>server 端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Say <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Say)</span> <span class="title">Hello</span><span class="params">(ctx context.Context, req *model.SayParam, rsp *model.SayResponse)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"received"</span>, req.Msg)</span><br><span class="line">    rsp.Header = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*model.Pair)</span><br><span class="line">    rsp.Header[<span class="string">"name"</span>] = &amp;model.Pair&#123;Key: <span class="number">1</span>, Values: <span class="string">"abc"</span>&#125;</span><br><span class="line"></span><br><span class="line">    rsp.Msg = <span class="string">"hello world"</span></span><br><span class="line">    rsp.Values = <span class="built_in">append</span>(rsp.Values, <span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">    rsp.Type = model.RespType_DESCEND</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 我这里用的etcd 做为服务发现，如果使用consul可以去掉</span></span><br><span class="line">    reg := etcdv3.NewRegistry(<span class="function"><span class="keyword">func</span><span class="params">(op *registry.Options)</span></span>&#123;</span><br><span class="line">        op.Addrs = []<span class="keyword">string</span>&#123;</span><br><span class="line">            <span class="string">"http://192.168.3.34:2379"</span>, <span class="string">"http://192.168.3.18:2379"</span>, <span class="string">"http://192.168.3.110:2379"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务</span></span><br><span class="line">    service := micro.NewService(</span><br><span class="line">        micro.Name(<span class="string">"lp.srv.eg1"</span>),</span><br><span class="line">        micro.Registry(reg),</span><br><span class="line">    )</span><br><span class="line">    service.Init()</span><br><span class="line">    <span class="comment">// 注册 Handler</span></span><br><span class="line">    model.RegisterSayHandler(service.Server(), <span class="built_in">new</span>(Say))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run server</span></span><br><span class="line">    <span class="keyword">if</span> err := service.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务发现我使用的是etcdv3 替换了默认的consul</p>
<p>micro.NewService 初始化服务，然后返回一个Service接口的实例，newService()方法的大概流程如下，</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-15.png"></p>
<p>先是给各个接口初始化默认值，再使用传入的值替换默认值，这也是go-micro可替换插件的地方。</p>
<p>service有一个Init()可选方法，这是一个单例方法，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init initialises options. Additionally it calls cmd.Init</span></span><br><span class="line"><span class="comment">// which parses command line flags. cmd.Init is only called</span></span><br><span class="line"><span class="comment">// on first Init.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span> <span class="title">Init</span><span class="params">(opts ...Option)</span></span> &#123;</span><br><span class="line">	<span class="comment">// process options</span></span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		o(&amp;s.opts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// Initialise the command flags, overriding new service</span></span><br><span class="line">		_ = s.opts.Cmd.Init(</span><br><span class="line">			cmd.Broker(&amp;s.opts.Broker),</span><br><span class="line">			cmd.Registry(&amp;s.opts.Registry),</span><br><span class="line">			cmd.Transport(&amp;s.opts.Transport),</span><br><span class="line">			cmd.Client(&amp;s.opts.Client),</span><br><span class="line">			cmd.Server(&amp;s.opts.Server),</span><br><span class="line">		)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用于始化cmd的一些信息</p>
<p>service.Run()方法 调用流程</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-5.png"></p>
<p>因为在初始化的时候没有指定端口，系统会自动分配一个端口号分给Server，并把这个server的信息注册到Register。</p>
<p>BeferStart和AfterStart也都是可以自定义的</p>
<p>client 端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 我这里用的etcd 做为服务发现，如果使用consul可以去掉</span></span><br><span class="line">    reg := etcdv3.NewRegistry(<span class="function"><span class="keyword">func</span><span class="params">(op *registry.Options)</span></span>&#123;</span><br><span class="line">        op.Addrs = []<span class="keyword">string</span>&#123;</span><br><span class="line">            <span class="string">"http://192.168.3.34:2379"</span>, <span class="string">"http://192.168.3.18:2379"</span>, <span class="string">"http://192.168.3.110:2379"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务</span></span><br><span class="line">    service := micro.NewService(</span><br><span class="line">        micro.Registry(reg),</span><br><span class="line">    )</span><br><span class="line">    service.Init()</span><br><span class="line">    sayClent := model.NewSayService(<span class="string">"lp.srv.eg1"</span>, service.Client())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rsp, err := sayClent.Hello(context.Background(), &amp;model.SayParam&#123;Msg: <span class="string">"hello server"</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(rsp)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面根据proto文件的生成的两个文件中有一个是rpc的接口文件，接口文件已经帮我们把调用方法的整个流程封装好了。</p>
<p>只需要给出服务名称和licent就可以。然后调用Hello方法</p>
<p>源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *sayService)</span> <span class="title">Hello</span><span class="params">(ctx context.Context, in *SayParam, opts ...client.CallOption)</span> <span class="params">(*SayResponse, error)</span></span> &#123;</span><br><span class="line">    req := c.c.NewRequest(c.name, <span class="string">"Say.Hello"</span>, in)</span><br><span class="line">    out := <span class="built_in">new</span>(SayResponse)</span><br><span class="line">    err := c.c.Call(ctx, req, out, opts...)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 主要的流程里都在c.c.Call方法里。简单来说流程如下</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-6.png"></p>
<p>就是得到节点信息address，根据address去查询  pool里是否有连接，如果有则取出来，如果没有则创建，然后进行数据传输，传输完成后把client放回到pool内。pool的大小也是可以控制的，这部分的代码读起来特别爽，具体的细节和处理流程会在以后的帖子里详细讲解</p>
<h3 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h3><p>例子1，做了一个简单的服务，已经不能再简单了，只是为了能让大家熟悉一下go-micro。看完例子1后应该会有更多的想法，想使用更多的go-micro的功能，比如protobuf生成的类都在一起，如果想model和api分开怎么处理，怎么使用go-micro的双向流，怎么使用消息推送，等等。所以我就双做了一个小例子，这个例子里包含了一些东西。</p>
<p>这个例子我就只说一下组织结构，也没有多少代码，大家有时间看一下就ok了。</p>
<p>proto下的两个文件夹，一个model一个rpcapi，是把数据和api分开，api引用了model</p>
<p>看一下rpcapi</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> rpcapi;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"github.com/lpxxn/gomicrorpc/example2/proto/model/common.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务接口</span></span><br><span class="line">service Say &#123;</span><br><span class="line">    rpc Hello(model.SayParam) returns (model.SayResponse) &#123;&#125;</span><br><span class="line">    rpc Stream(model.SRequest) returns (stream model.SResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    import了model里的common.proto</p>
<p>在生成的时候一个只要go_out另一个只要micro_out就好了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc --proto_path=$GOPATH/src:. --go_out=. example2/proto/model/*.proto </span><br><span class="line">protoc --proto_path=$GOPATH/src:. --micro_out=. example2/proto/rpcapi/*.proto</span><br></pre></td></tr></table></figure>

<p>订阅一个信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register Subscribers</span></span><br><span class="line"><span class="keyword">if</span> err := server.Subscribe(server.NewSubscriber(common.Topic1, subscriber.Handler)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当有信息发送时，所有订阅了lp.srv.eg2.topic1这个信息的服务都会收到信息</p>
<p>客户端发送信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p := micro.NewPublisher(common.Topic1, service.Client())</span><br><span class="line">p.Publish(context.TODO(), &amp;model.SayParam&#123;Msg: lib.RandomStr(lib.Random(<span class="number">3</span>, <span class="number">10</span>))&#125;)</span><br></pre></td></tr></table></figure>

<p>如果是生产环境一定不要用go-micro默认的信息发布和订阅处理方式，micro的插件plugin里是有很多成熟的插件。</p>
<p>使用双向流的小功能</p>
<p>这个方法只是每次向客户端发送一些数据，每次只发送一部分。比如我们给客户端推送的数据很大时，一次性全都推过去，是不太正确的做法，分批推送还是比较好的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Say)</span> <span class="title">Stream</span><span class="params">(ctx context.Context, req *model.SRequest, stream rpcapi.Say_StreamStream)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(req.Count); i++ &#123;</span><br><span class="line">        rsp := &amp;model.SResponse&#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> j := lib.Random(<span class="number">3</span>, <span class="number">5</span>); j &lt; <span class="number">10</span>; j++ &#123;</span><br><span class="line">            rsp.Value = <span class="built_in">append</span>(rsp.Value, lib.RandomStr(lib.Random(<span class="number">3</span>, <span class="number">10</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err := stream.Send(rsp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 模拟处理过程</span></span><br><span class="line">        time.Sleep(time.Microsecond * <span class="number">50</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3-Registry服务的注册和发现"><a href="#3-Registry服务的注册和发现" class="headerlink" title="3.Registry服务的注册和发现"></a>3.Registry服务的注册和发现</h2><p>服务的注册与发现是微服务必不可少的功能，这样系统才能有更高的性能，更高的可用性。go-micro框架的服务发现有自己能用的接口Registry。只要实现这个接口就可以定制自己的服务注册和发现。</p>
<p>go-micro在客户端做的负载，典型的Balancing-aware Client模式。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-7.png"></p>
<p>服务端把服务的地址信息保存到Registry,  然后定时的心跳检查，或者定时的重新注册服务。客户端监听Registry，最好是把服务信息保存到本地，监听服务的变动，更新缓存。当调用服务端的接口是时，根据客户端的服务列表和负载算法选择服务端进行通信。</p>
<p> go-micro的能用Registry接口</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The registry provides an interface for service discovery</span></span><br><span class="line"><span class="comment">// and an abstraction over varying implementations</span></span><br><span class="line"><span class="comment">// &#123;consul, etcd, zookeeper, ...&#125;</span></span><br><span class="line"><span class="keyword">type</span> Registry <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) error</span><br><span class="line">	Options() Options</span><br><span class="line">	Register(*Service, ...RegisterOption) error</span><br><span class="line">	Deregister(*Service) error</span><br><span class="line">	GetService(<span class="keyword">string</span>) ([]*Service, error)</span><br><span class="line">	ListServices() ([]*Service, error)</span><br><span class="line">	Watch(...WatchOption) (Watcher, error)</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Watcher is an interface that returns updates</span></span><br><span class="line"><span class="comment">// about services within the registry.</span></span><br><span class="line"><span class="keyword">type</span> Watcher <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Next is a blocking call</span></span><br><span class="line">	Next() (*Result, error)</span><br><span class="line">	Stop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口还是很简单明了的，看方法也大概能猜到主要的作用</p>
<p>Register方法和Deregister是服务端用于注册服务的，Watcher接口是客户端用于监听服务信息变化的。</p>
<p>接下来我以go-micro的etcdv3为Registry的例给大家详细讲解一下go-micro的详细服务发现过程</p>
<h3 id="go-micro-服务端注册服务"><a href="#go-micro-服务端注册服务" class="headerlink" title="go-micro 服务端注册服务"></a>go-micro 服务端注册服务</h3><p>流程图</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-8.png"></p>
<p>服务端看上去流程还是比较简单的，当服务端调用Run()方法时，会调用service.Start()方法。这个除了监听端口，启动服务，还会把服务的ip端口号信息，和所有的公开接口的元数据信息保存到我们选择的Register服务器上去。</p>
<p>看上去没有问题，但是，如果我们的节点发生故障，也是需要告诉Register把我们的节点信息删除掉。</p>
<p>Run()方法中有个go s.run(ex)  方法的调用，这个方法就是根据我们设置interval去重新注册服务，当然比较保险的方式是我们把服务的ttl也设置上，这样当服务在未知的情况下崩溃，到了ttl的时间Register服务也会自动把信息删除掉。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span> <span class="title">run</span><span class="params">(exit <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s.opts.RegisterInterval &lt;= time.Duration(<span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	t := time.NewTicker(s.opts.RegisterInterval)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">			s.register()</span><br><span class="line">		<span class="keyword">case</span> &lt;-exit:</span><br><span class="line">			t.Stop()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置服务的ttl和 interval</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化服务</span></span><br><span class="line">service := micro.NewService(</span><br><span class="line">    micro.Name(common.ServiceName),</span><br><span class="line">    micro.RegisterTTL(time.Second*<span class="number">30</span>),</span><br><span class="line">    micro.RegisterInterval(time.Second*<span class="number">20</span>),</span><br><span class="line">    micro.Registry(reg),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p> ttl就是注册服务的过期时间，interval就是间隔多久再次注册服务。如果系统崩溃，过期时间也会把服务删除掉。客户端当然也会有相应的判断，下面会详细解说 </p>
<h3 id="客户端发现服务"><a href="#客户端发现服务" class="headerlink" title="客户端发现服务"></a>客户端发现服务</h3><p>客户端的服务发现要步骤多一些，但并不复杂，他涉及到服务选择Selector和服务发现Register两部分。</p>
<p>Selector是基于服务发现的，根据你选择的主机选择算法，返回主机的信息。默认的情况，go-micro是每次要得到服务器主机的信息都要去Register去获取。但是查看cmd.go的源码你会发现默认初始化的值，selector的默认flag是cache。DefaultSelectors里的cache对应的就是初始化cacheSelector方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">DefaultFlags = []cli.Flag&#123;</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"client"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_CLIENT"</span>,</span><br><span class="line">        Usage:  <span class="string">"Client for go-micro; rpc"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"client_request_timeout"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_CLIENT_REQUEST_TIMEOUT"</span>,</span><br><span class="line">        Usage:  <span class="string">"Sets the client request timeout. e.g 500ms, 5s, 1m. Default: 5s"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">"client_retries"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_CLIENT_RETRIES"</span>,</span><br><span class="line">        Value:  client.DefaultRetries,</span><br><span class="line">        Usage:  <span class="string">"Sets the client retries. Default: 1"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">"client_pool_size"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_CLIENT_POOL_SIZE"</span>,</span><br><span class="line">        Usage:  <span class="string">"Sets the client connection pool size. Default: 1"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"client_pool_ttl"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_CLIENT_POOL_TTL"</span>,</span><br><span class="line">        Usage:  <span class="string">"Sets the client connection pool ttl. e.g 500ms, 5s, 1m. Default: 1m"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">"register_ttl"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_REGISTER_TTL"</span>,</span><br><span class="line">        Usage:  <span class="string">"Register TTL in seconds"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">"register_interval"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_REGISTER_INTERVAL"</span>,</span><br><span class="line">        Usage:  <span class="string">"Register interval in seconds"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"server"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SERVER"</span>,</span><br><span class="line">        Usage:  <span class="string">"Server for go-micro; rpc"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"server_name"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SERVER_NAME"</span>,</span><br><span class="line">        Usage:  <span class="string">"Name of the server. go.micro.srv.example"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"server_version"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SERVER_VERSION"</span>,</span><br><span class="line">        Usage:  <span class="string">"Version of the server. 1.1.0"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"server_id"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SERVER_ID"</span>,</span><br><span class="line">        Usage:  <span class="string">"Id of the server. Auto-generated if not specified"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"server_address"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SERVER_ADDRESS"</span>,</span><br><span class="line">        Usage:  <span class="string">"Bind address for the server. 127.0.0.1:8080"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"server_advertise"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SERVER_ADVERTISE"</span>,</span><br><span class="line">        Usage:  <span class="string">"Used instead of the server_address when registering with discovery. 127.0.0.1:8080"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringSliceFlag&#123;</span><br><span class="line">        Name:   <span class="string">"server_metadata"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SERVER_METADATA"</span>,</span><br><span class="line">        Value:  &amp;cli.StringSlice&#123;&#125;,</span><br><span class="line">        Usage:  <span class="string">"A list of key-value pairs defining metadata. version=1.0.0"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"broker"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_BROKER"</span>,</span><br><span class="line">        Usage:  <span class="string">"Broker for pub/sub. http, nats, rabbitmq"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"broker_address"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_BROKER_ADDRESS"</span>,</span><br><span class="line">        Usage:  <span class="string">"Comma-separated list of broker addresses"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"registry"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_REGISTRY"</span>,</span><br><span class="line">        Usage:  <span class="string">"Registry for discovery. consul, mdns"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"registry_address"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_REGISTRY_ADDRESS"</span>,</span><br><span class="line">        Usage:  <span class="string">"Comma-separated list of registry addresses"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"selector"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_SELECTOR"</span>,</span><br><span class="line">        Usage:  <span class="string">"Selector used to pick nodes for querying"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"transport"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_TRANSPORT"</span>,</span><br><span class="line">        Usage:  <span class="string">"Transport mechanism used; http"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">"transport_address"</span>,</span><br><span class="line">        EnvVar: <span class="string">"MICRO_TRANSPORT_ADDRESS"</span>,</span><br><span class="line">        Usage:  <span class="string">"Comma-separated list of transport addresses"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultBrokers = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...broker.Option)</span> <span class="title">broker</span>.<span class="title">Broker</span></span>&#123;</span><br><span class="line">    <span class="string">"http"</span>:   http.NewBroker,</span><br><span class="line">    <span class="string">"memory"</span>: memory.NewBroker,</span><br><span class="line">    <span class="string">"nats"</span>:   nats.NewBroker,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultClients = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...client.Option)</span> <span class="title">client</span>.<span class="title">Client</span></span>&#123;</span><br><span class="line">    <span class="string">"rpc"</span>:  client.NewClient,</span><br><span class="line">    <span class="string">"mucp"</span>: cmucp.NewClient,</span><br><span class="line">    <span class="string">"grpc"</span>: cgrpc.NewClient,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultRegistries = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...registry.Option)</span> <span class="title">registry</span>.<span class="title">Registry</span></span>&#123;</span><br><span class="line">    <span class="string">"consul"</span>: consul.NewRegistry,</span><br><span class="line">    <span class="string">"gossip"</span>: gossip.NewRegistry,</span><br><span class="line">    <span class="string">"mdns"</span>:   mdns.NewRegistry,</span><br><span class="line">    <span class="string">"memory"</span>: rmem.NewRegistry,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultSelectors = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...selector.Option)</span> <span class="title">selector</span>.<span class="title">Selector</span></span>&#123;</span><br><span class="line">    <span class="string">"default"</span>: selector.NewSelector,</span><br><span class="line">    <span class="string">"dns"</span>:     dns.NewSelector,</span><br><span class="line">    <span class="string">"cache"</span>:   selector.NewSelector,</span><br><span class="line">    <span class="string">"router"</span>:  router.NewSelector,</span><br><span class="line">    <span class="string">"static"</span>:  static.NewSelector,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultServers = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...server.Option)</span> <span class="title">server</span>.<span class="title">Server</span></span>&#123;</span><br><span class="line">    <span class="string">"rpc"</span>:  server.NewServer,</span><br><span class="line">    <span class="string">"mucp"</span>: smucp.NewServer,</span><br><span class="line">    <span class="string">"grpc"</span>: sgrpc.NewServer,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultTransports = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...transport.Option)</span> <span class="title">transport</span>.<span class="title">Transport</span></span>&#123;</span><br><span class="line">    <span class="string">"memory"</span>: tmem.NewTransport,</span><br><span class="line">    <span class="string">"http"</span>:   thttp.NewTransport,</span><br><span class="line">    <span class="string">"grpc"</span>:   tgrpc.NewTransport,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// used for default selection as the fall back</span></span><br><span class="line">defaultClient    = <span class="string">"rpc"</span></span><br><span class="line">defaultServer    = <span class="string">"rpc"</span></span><br><span class="line">defaultBroker    = <span class="string">"http"</span></span><br><span class="line">defaultRegistry  = <span class="string">"mdns"</span></span><br><span class="line">defaultSelector  = <span class="string">"registry"</span></span><br><span class="line">defaultTransport = <span class="string">"http"</span></span><br></pre></td></tr></table></figure>

<p>但是当你在执行service.Init()方法时，go-micro会把默认的selector替换成cacheSelector,具体的实现是在cmd.go的Before方法里</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cmd)</span> <span class="title">Before</span><span class="params">(ctx *cli.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// If flags are set then use them otherwise do nothing</span></span><br><span class="line">	<span class="keyword">var</span> serverOpts []server.Option</span><br><span class="line">	<span class="keyword">var</span> clientOpts []client.Option</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the client</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">"client"</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// only change if we have the client and type differs</span></span><br><span class="line">		<span class="keyword">if</span> cl, ok := c.opts.Clients[name]; ok &amp;&amp; (*c.opts.Client).String() != name &#123;</span><br><span class="line">			*c.opts.Client = cl()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the server</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">"server"</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// only change if we have the server and type differs</span></span><br><span class="line">		<span class="keyword">if</span> s, ok := c.opts.Servers[name]; ok &amp;&amp; (*c.opts.Server).String() != name &#123;</span><br><span class="line">			*c.opts.Server = s()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the broker</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">"broker"</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Broker).String() != name &#123;</span><br><span class="line">		b, ok := c.opts.Brokers[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Broker %s not found"</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Broker = b()</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Broker(*c.opts.Broker))</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Broker(*c.opts.Broker))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the registry</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">"registry"</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Registry).String() != name &#123;</span><br><span class="line">		r, ok := c.opts.Registries[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Registry %s not found"</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Registry = r()</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Registry(*c.opts.Registry))</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Registry(*c.opts.Registry))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Selector).Init(selector.Registry(*c.opts.Registry)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"Error configuring registry: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Selector(*c.opts.Selector))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Broker).Init(broker.Registry(*c.opts.Registry)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"Error configuring broker: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the selector</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">"selector"</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Selector).String() != name &#123;</span><br><span class="line">		s, ok := c.opts.Selectors[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Selector %s not found"</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Selector = s(selector.Registry(*c.opts.Registry))</span><br><span class="line"></span><br><span class="line">		<span class="comment">// No server option here. Should there be?</span></span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Selector(*c.opts.Selector))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the transport</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">"transport"</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Transport).String() != name &#123;</span><br><span class="line">		t, ok := c.opts.Transports[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Transport %s not found"</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Transport = t()</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Transport(*c.opts.Transport))</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Transport(*c.opts.Transport))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Parse the server options</span></span><br><span class="line">	metadata := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">	<span class="keyword">for</span> _, d := <span class="keyword">range</span> ctx.StringSlice(<span class="string">"server_metadata"</span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> key, val <span class="keyword">string</span></span><br><span class="line">		parts := strings.Split(d, <span class="string">"="</span>)</span><br><span class="line">		key = parts[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt; <span class="number">1</span> &#123;</span><br><span class="line">			val = strings.Join(parts[<span class="number">1</span>:], <span class="string">"="</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		metadata[key] = val</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(metadata) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Metadata(metadata))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"broker_address"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Broker).Init(broker.Addrs(strings.Split(ctx.String(<span class="string">"broker_address"</span>), <span class="string">","</span>)...)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"Error configuring broker: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"registry_address"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Registry).Init(registry.Addrs(strings.Split(ctx.String(<span class="string">"registry_address"</span>), <span class="string">","</span>)...)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"Error configuring registry: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"transport_address"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Transport).Init(transport.Addrs(strings.Split(ctx.String(<span class="string">"transport_address"</span>), <span class="string">","</span>)...)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"Error configuring transport: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"server_name"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Name(ctx.String(<span class="string">"server_name"</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"server_version"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Version(ctx.String(<span class="string">"server_version"</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"server_id"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Id(ctx.String(<span class="string">"server_id"</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"server_address"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Address(ctx.String(<span class="string">"server_address"</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">"server_advertise"</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Advertise(ctx.String(<span class="string">"server_advertise"</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ttl := time.Duration(ctx.GlobalInt(<span class="string">"register_ttl"</span>)); ttl &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.RegisterTTL(ttl*time.Second))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> val := time.Duration(ctx.GlobalInt(<span class="string">"register_interval"</span>)); val &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.RegisterInterval(val*time.Second))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// client opts</span></span><br><span class="line">	<span class="keyword">if</span> r := ctx.Int(<span class="string">"client_retries"</span>); r &gt;= <span class="number">0</span> &#123;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Retries(r))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> t := ctx.String(<span class="string">"client_request_timeout"</span>); <span class="built_in">len</span>(t) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		d, err := time.ParseDuration(t)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to parse client_request_timeout: %v"</span>, t)</span><br><span class="line">		&#125;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.RequestTimeout(d))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> r := ctx.Int(<span class="string">"client_pool_size"</span>); r &gt; <span class="number">0</span> &#123;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.PoolSize(r))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> t := ctx.String(<span class="string">"client_pool_ttl"</span>); <span class="built_in">len</span>(t) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		d, err := time.ParseDuration(t)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to parse client_pool_ttl: %v"</span>, t)</span><br><span class="line">		&#125;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.PoolTTL(d))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We have some command line opts for the server.</span></span><br><span class="line">	<span class="comment">// Lets set it up</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(serverOpts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Server).Init(serverOpts...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"Error configuring server: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use an init option?</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(clientOpts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Client).Init(clientOpts...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"Error configuring client: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cacheSelector  会把从Register里获取的主机信息缓存起来。并设置超时时间，如果超时则重新获取。在获取主机信息的时候他会单独跑一个协程，去watch服务的注册，如果有新节点发现，则加到缓存中，如果有节点故障则删除缓存中的节点信息。当client还要根据selector选择的主机选择算法才能得到主机信息，目前只有两种算法，循环和随机法。为了增加执行效率，很client端也会设置缓存连接池，这个点，以后会详细说。</p>
<p>所以大概的客户端服务发现流程是下面这样</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-9.png"></p>
<p>主要的调用过程都在Call方法内</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rpcClient)</span> <span class="title">Call</span><span class="params">(ctx context.Context, request Request, response <span class="keyword">interface</span>&#123;&#125;, opts ...CallOption)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// make a copy of call opts</span></span><br><span class="line">	callOpts := r.opts.CallOptions</span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		opt(&amp;callOpts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	next, err := r.next(request, callOpts)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check if we already have a deadline</span></span><br><span class="line">	d, ok := ctx.Deadline()</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="comment">// no deadline so we create a new one</span></span><br><span class="line">		ctx, _ = context.WithTimeout(ctx, callOpts.RequestTimeout)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// got a deadline so no need to setup context</span></span><br><span class="line">		<span class="comment">// but we need to set the timeout we pass along</span></span><br><span class="line">		opt := WithRequestTimeout(d.Sub(time.Now()))</span><br><span class="line">		opt(&amp;callOpts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// should we noop right here?</span></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		<span class="keyword">return</span> errors.Timeout(<span class="string">"go.micro.client"</span>, fmt.Sprintf(<span class="string">"%v"</span>, ctx.Err()))</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// make copy of call method</span></span><br><span class="line">	rcall := r.call</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wrap the call in reverse</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(callOpts.CallWrappers); i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">		rcall = callOpts.CallWrappers[i<span class="number">-1</span>](rcall)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// return errors.New("go.micro.client", "request timeout", 408)</span></span><br><span class="line">	call := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">// call backoff first. Someone may want an initial start delay</span></span><br><span class="line">		t, err := callOpts.Backoff(ctx, request, i)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.InternalServerError(<span class="string">"go.micro.client"</span>, <span class="string">"backoff error: %v"</span>, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// only sleep if greater than 0</span></span><br><span class="line">		<span class="keyword">if</span> t.Seconds() &gt; <span class="number">0</span> &#123;</span><br><span class="line">			time.Sleep(t)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// select next node</span></span><br><span class="line">		node, err := next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err == selector.ErrNotFound &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.NotFound(<span class="string">"go.micro.client"</span>, <span class="string">"service %s: %v"</span>, request.Service(), err.Error())</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.InternalServerError(<span class="string">"go.micro.client"</span>, <span class="string">"error getting next %s node: %v"</span>, request.Service(), err.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// make the call</span></span><br><span class="line">		err = rcall(ctx, node, request, response, callOpts)</span><br><span class="line">		r.opts.Selector.Mark(request.Service(), node, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> error, callOpts.Retries+<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">var</span> gerr error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= callOpts.Retries; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			ch &lt;- call(i)</span><br><span class="line">		&#125;(i)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">return</span> errors.Timeout(<span class="string">"go.micro.client"</span>, fmt.Sprintf(<span class="string">"call timeout: %v"</span>, ctx.Err()))</span><br><span class="line">		<span class="keyword">case</span> err := &lt;-ch:</span><br><span class="line">			<span class="comment">// if the call succeeded lets bail early</span></span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			retry, rerr := callOpts.Retry(ctx, request, i, err)</span><br><span class="line">			<span class="keyword">if</span> rerr != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> rerr</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> !retry &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			gerr = err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> gerr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要的思路是</p>
<ol>
<li><p>从Selector里得到选择主机策略方法next。</p>
</li>
<li><p>根据Retory是否重试调用服务，调用服务的过程是，从next 方法内得到主机，连接并传输数据 ，如果失败则重试，重试时，会根据主机选择策略方法next重新得到一个新的主机进行操作。</p>
</li>
</ol>
<h2 id="4-rpc方法调用过程详解"><a href="#4-rpc方法调用过程详解" class="headerlink" title="4.rpc方法调用过程详解"></a>4.rpc方法调用过程详解</h2><p>上一篇帖子<a href="https://www.cnblogs.com/li-peng/p/9689786.html" target="_blank" rel="noopener">go微服务框架go-micro深度学习(三) Registry服务的注册和发现详</a>细解释了go-micro是如何做服务注册和发现在，服务端注册server信息，client获取server的地址信息，就可以和服务建立连接，然后就可以进行通信了。这篇帖子详细说一下，go-micro的通信协议、编码，和具体服务方法的调用过程是如何实现的，文中的代码还是我github上的例子： <a href="https://github.com/lpxxn/gomicrorpc" target="_blank" rel="noopener">gomicrorpc</a></p>
<p>go-micro  支持很多通信协议：http、tcp、grpc等，支持的编码方式也很多有json、protobuf、bytes、jsonrpc等。也可以根据自己的需要实现通信协议和编码方式。go-micro  默认的通信协议是http，默认的编码方式是protobuf，我就以默认的方式来分解他的具体实现。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-10.png"></p>
<h3 id="服务的启动"><a href="#服务的启动" class="headerlink" title="服务的启动"></a>服务的启动</h3><p>go-micro在启动的时候会选择默认通信协议http和protobuf编码方式，但他是如何路由到具体方法的？在go-micro服务端启动的时候我们需要注册Handler，也就是我们具体实现结构体  ，如例子中注册方法时，我们调用的RegisterSayHandler方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册 Handler</span></span><br><span class="line">rpcapi.RegisterSayHandler(service.Server(), <span class="built_in">new</span>(handler.Say))</span><br></pre></td></tr></table></figure>

<p>这个方法内部的体实现主要是利用了反射的力量，注册的对象是实现了rpc接口的方法，如我们的Say实现了SayHandler。go-micro默认的router会利用反射把Say对象的信息完全提取出来，解析出结构体内的方法及方法的参数，保存到一个map内-&gt;  <code>map[结构体名称][方法信息集合]</code></p>
<p>具体的实现在rpc_router.go里router的Handle(Handler)方法，组织完成后map的是下图这样，保存了很多反射信息，用以将来调用。 </p>
<p>下面是这个方法的主要代码，删除了一些，很希望大家读一下rpc_router.go里面的代码，prepareMethod方法是具体利用反射提取信息的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span> <span class="title">Handle</span><span class="params">(h Handler)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    router.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> router.mu.Unlock()</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    rcvr := h.Handler()</span><br><span class="line">    s := <span class="built_in">new</span>(service)</span><br><span class="line">    s.typ = reflect.TypeOf(rcvr)</span><br><span class="line">    s.rcvr = reflect.ValueOf(rcvr)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check name</span></span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    s.name = h.Name()</span><br><span class="line">    s.method = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*methodType)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install the methods</span></span><br><span class="line">    <span class="keyword">for</span> m := <span class="number">0</span>; m &lt; s.typ.NumMethod(); m++ &#123;</span><br><span class="line">        method := s.typ.Method(m)</span><br><span class="line">                <span class="comment">// prepareMethod会把所有解析的信息返回来</span></span><br><span class="line">        <span class="keyword">if</span> mt := prepareMethod(method); mt != <span class="literal">nil</span> &#123;</span><br><span class="line">            s.method[method.Name] = mt</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">// .....</span></span><br><span class="line">    <span class="comment">// save handler</span></span><br><span class="line">    router.serviceMap[s.name] = s</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serviceMap里保存的就是反射后的信息，下图是我用goland的debug得到的保存信息 </p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-14.png"></p>
<p>路由信息处理完后，主要的工作就已经完成了，然后注册服务并启动服务，启动的服务是一个http的服务，我们可以看一下http_transport.go里的代码 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *httpTransportListener)</span> <span class="title">Accept</span><span class="params">(fn <span class="keyword">func</span>(Socket)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// create handler mux</span></span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// register our transport handler</span></span><br><span class="line">	mux.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> buf *bufio.ReadWriter</span><br><span class="line">		<span class="keyword">var</span> con net.Conn</span><br><span class="line"></span><br><span class="line">		<span class="comment">// read a regular request</span></span><br><span class="line">		<span class="keyword">if</span> r.ProtoMajor == <span class="number">1</span> &#123;</span><br><span class="line">			b, err := ioutil.ReadAll(r.Body)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			r.Body = ioutil.NopCloser(bytes.NewReader(b))</span><br><span class="line">			<span class="comment">// hijack the conn</span></span><br><span class="line">			hj, ok := w.(http.Hijacker)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="comment">// we're screwed</span></span><br><span class="line">				http.Error(w, <span class="string">"cannot serve conn"</span>, http.StatusInternalServerError)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			conn, bufrw, err := hj.Hijack()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> conn.Close()</span><br><span class="line">			buf = bufrw</span><br><span class="line">			con = conn</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// save the request</span></span><br><span class="line">		ch := <span class="built_in">make</span>(<span class="keyword">chan</span> *http.Request, <span class="number">1</span>)</span><br><span class="line">		ch &lt;- r</span><br><span class="line"></span><br><span class="line">		fn(&amp;httpTransportSocket&#123;</span><br><span class="line">			ht:     h.ht,</span><br><span class="line">			w:      w,</span><br><span class="line">			r:      r,</span><br><span class="line">			rw:     buf,</span><br><span class="line">			ch:     ch,</span><br><span class="line">			conn:   con,</span><br><span class="line">			local:  h.Addr(),</span><br><span class="line">			remote: r.RemoteAddr,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// get optional handlers</span></span><br><span class="line">	<span class="keyword">if</span> h.ht.opts.Context != <span class="literal">nil</span> &#123;</span><br><span class="line">		handlers, ok := h.ht.opts.Context.Value(<span class="string">"http_handlers"</span>).(<span class="keyword">map</span>[<span class="keyword">string</span>]http.Handler)</span><br><span class="line">		<span class="keyword">if</span> ok &#123;</span><br><span class="line">			<span class="keyword">for</span> pattern, handler := <span class="keyword">range</span> handlers &#123;</span><br><span class="line">				mux.Handle(pattern, handler)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// default http2 server</span></span><br><span class="line">	srv := &amp;http.Server&#123;</span><br><span class="line">		Handler: mux,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// insecure connection use h2c</span></span><br><span class="line">	<span class="keyword">if</span> !(h.ht.opts.Secure || h.ht.opts.TLSConfig != <span class="literal">nil</span>) &#123;</span><br><span class="line">		srv.Handler = h2c.NewHandler(mux, &amp;http2.Server&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// begin serving</span></span><br><span class="line">	<span class="keyword">return</span> srv.Serve(h.listener)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务的简单流程图如下 ，选择通信协议和编码方式-&gt;注册服务方法-&gt;启动服务并注册服务信息</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-11.png"></p>
<h3 id="客户端调用服务方法"><a href="#客户端调用服务方法" class="headerlink" title="客户端调用服务方法"></a>客户端调用服务方法</h3><p>客户端在启动的时候也要选择默认的通信协议http，和protobuf编码。客户端在调用rpc方法的时候如： </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsp, err := client.Hello(context.Background(), &amp;model.SayParam&#123;Msg: <span class="string">"hello server"</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>go-micro为我们自动生成的rpcapi.micro.go里我们可以看一上Hello的具体实现，没有几行代码，但内部还是做了很多工作</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *sayService)</span> <span class="title">Hello</span><span class="params">(ctx context.Context, in *model.SayParam, opts ...client.CallOption)</span> <span class="params">(*model.SayResponse, error)</span></span> &#123;</span><br><span class="line">   req := c.c.NewRequest(c.name, <span class="string">"Say.Hello"</span>, in)</span><br><span class="line">   out := <span class="built_in">new</span>(model.SayResponse)</span><br><span class="line">   err := c.c.Call(ctx, req, out, opts...)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> out, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他的实现方式是封装request，然后调用服务方法。这个request 是非常重要的： </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRequest</span><span class="params">(service, endpoint <span class="keyword">string</span>, request <span class="keyword">interface</span>&#123;&#125;, contentType <span class="keyword">string</span>, reqOpts ...RequestOption)</span> <span class="title">Request</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> opts RequestOptions</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, o := <span class="keyword">range</span> reqOpts &#123;</span><br><span class="line">        o(&amp;opts)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the content-type specified</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(opts.ContentType) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        contentType = opts.ContentType</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;rpcRequest&#123;</span><br><span class="line">        service:     service,</span><br><span class="line">        method:      endpoint,</span><br><span class="line">        endpoint:    endpoint,</span><br><span class="line">        body:        request,</span><br><span class="line">        contentType: contentType,</span><br><span class="line">        opts:        opts,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法返回一个rpcRequest里面包含了详细的调用信息，servicec：服务名，method和endpoint目前是一样的是方法名这里是Say.Hello，contentType是protobuf，body   是具体的信息，也要要进行编码的内容，使用protobuf进行编码，然后会把这些信息放到一个http.Request里，再从Register或者从缓存获取服务器信息，连接服务器，发送数据。 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *httpTransportClient)</span> <span class="title">Send</span><span class="params">(m *Message)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	header := <span class="built_in">make</span>(http.Header)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> m.Header &#123;</span><br><span class="line">		header.Set(k, v)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reqB := bytes.NewBuffer(m.Body)</span><br><span class="line">	<span class="keyword">defer</span> reqB.Reset()</span><br><span class="line">	buf := &amp;buffer&#123;</span><br><span class="line">		reqB,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	req := &amp;http.Request&#123;</span><br><span class="line">		Method: <span class="string">"POST"</span>,</span><br><span class="line">		URL: &amp;url.URL&#123;</span><br><span class="line">			Scheme: <span class="string">"http"</span>,</span><br><span class="line">			Host:   h.addr,</span><br><span class="line">		&#125;,</span><br><span class="line">		Header:        header,</span><br><span class="line">		Body:          buf,</span><br><span class="line">		ContentLength: <span class="keyword">int64</span>(reqB.Len()),</span><br><span class="line">		Host:          h.addr,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	h.Lock()</span><br><span class="line">	h.bl = <span class="built_in">append</span>(h.bl, req)</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> h.r &lt;- h.bl[<span class="number">0</span>]:</span><br><span class="line">		h.bl = h.bl[<span class="number">1</span>:]</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	&#125;</span><br><span class="line">	h.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set timeout if its greater than 0</span></span><br><span class="line">	<span class="keyword">if</span> h.ht.opts.Timeout &gt; time.Duration(<span class="number">0</span>) &#123;</span><br><span class="line">		h.conn.SetDeadline(time.Now().Add(h.ht.opts.Timeout))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> req.Write(h.conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单流程图如下</p>
<p>client：封装参数-&gt; 编码数据-&gt;连接服务-&gt;发送数据-&gt;接收返回数据，并解码。</p>
<p>service: 接收数据-&gt;解码数据，找到相应的实例和方法，利用反射调用具体方法-&gt;编码返数据-&gt;发送给客户端。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-12.png"></p>
<h3 id="服务端处理请求"><a href="#服务端处理请求" class="headerlink" title="服务端处理请求"></a>服务端处理请求</h3><p>当服务端监接收到数据后，从http的Request里的Header中读取到相应的信息：编码方式，endpoint，请求的数据，由路由器进行对比和匹配找到保存的反射信息，利用反射把请求的数据根据相应的编码方式进行解码，再利用反射调用具体的方法，处理完把返回数据进行编码，组织一个http.Response传输给用户，客户端接收到数据后进行解码读取数据。  rpc_router.go里的call方法就是具体的调用过程方法，有时间大家可以读一下。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span> <span class="title">call</span><span class="params">(ctx context.Context, router *router, sending *sync.Mutex, mtype *methodType, req *request, argv, replyv reflect.Value, cc codec.Writer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> router.freeRequest(req)</span><br><span class="line"></span><br><span class="line">	function := mtype.method.Func</span><br><span class="line">	<span class="keyword">var</span> returnValues []reflect.Value</span><br><span class="line"></span><br><span class="line">	r := &amp;rpcRequest&#123;</span><br><span class="line">		service:     req.msg.Target,</span><br><span class="line">		contentType: req.msg.Header[<span class="string">"Content-Type"</span>],</span><br><span class="line">		method:      req.msg.Method,</span><br><span class="line">		endpoint:    req.msg.Endpoint,</span><br><span class="line">		body:        req.msg.Body,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// only set if not nil</span></span><br><span class="line">	<span class="keyword">if</span> argv.IsValid() &#123;</span><br><span class="line">		r.rawBody = argv.Interface()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !mtype.stream &#123;</span><br><span class="line">		fn := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req Request, rsp <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			returnValues = function.Call([]reflect.Value&#123;s.rcvr, mtype.prepareContext(ctx), reflect.ValueOf(argv.Interface()), reflect.ValueOf(rsp)&#125;)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// The return value for the method is an error.</span></span><br><span class="line">			<span class="keyword">if</span> err := returnValues[<span class="number">0</span>].Interface(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err.(error)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// wrap the handler</span></span><br><span class="line">		<span class="keyword">for</span> i := <span class="built_in">len</span>(router.hdlrWrappers); i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">			fn = router.hdlrWrappers[i<span class="number">-1</span>](fn)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// execute handler</span></span><br><span class="line">		<span class="keyword">if</span> err := fn(ctx, r, replyv.Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// send response</span></span><br><span class="line">		<span class="keyword">return</span> router.sendResponse(sending, req, replyv.Interface(), cc, <span class="literal">true</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// declare a local error to see if we errored out already</span></span><br><span class="line">	<span class="comment">// keep track of the type, to make sure we return</span></span><br><span class="line">	<span class="comment">// the same one consistently</span></span><br><span class="line">	rawStream := &amp;rpcStream&#123;</span><br><span class="line">		context: ctx,</span><br><span class="line">		codec:   cc.(codec.Codec),</span><br><span class="line">		request: r,</span><br><span class="line">		id:      req.msg.Id,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Invoke the method, providing a new value for the reply.</span></span><br><span class="line">	fn := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req Request, stream <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		returnValues = function.Call([]reflect.Value&#123;s.rcvr, mtype.prepareContext(ctx), reflect.ValueOf(stream)&#125;)</span><br><span class="line">		<span class="keyword">if</span> err := returnValues[<span class="number">0</span>].Interface(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// the function returned an error, we use that</span></span><br><span class="line">			<span class="keyword">return</span> err.(error)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> serr := rawStream.Error(); serr == io.EOF || serr == io.ErrUnexpectedEOF &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// no error, we send the special EOS error</span></span><br><span class="line">			<span class="keyword">return</span> lastStreamResponseError</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wrap the handler</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(router.hdlrWrappers); i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">		fn = router.hdlrWrappers[i<span class="number">-1</span>](fn)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// client.Stream request</span></span><br><span class="line">	r.stream = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// execute handler</span></span><br><span class="line">	<span class="keyword">return</span> fn(ctx, r, rawStream)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-stream-调用过程详解"><a href="#5-stream-调用过程详解" class="headerlink" title="5.stream 调用过程详解"></a>5.stream 调用过程详解</h2><p><a href="https://www.cnblogs.com/li-peng/p/10365251.html" target="_blank" rel="noopener">上一篇写了一下rpc调用过程的实现方式</a>，简单来说就是服务端把实现了接口的结构体对象进行反射，抽取方法，签名，保存，客户端调用的时候go-micro封请求数据，服务端接收到请求时，找到需要调用调用的对象和对应的方法，利用反射进行调用，返回数据。   但是没有说stream的实现方式，感觉单独写一篇帖子来说这个更好一些。上一篇帖子是基础，理解了上一篇，stream实现原理一点即破。先说一下使用方式，再说原理。<br>当前go-micro对 rpc 调用的方式大概如下：<br>普通的rpc调用 是这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.连接服务器或者从缓存池得到连接</span><br><span class="line">2.客户端 -&gt;发送数据 -&gt; 服务端接收</span><br><span class="line">3.服务端 -&gt;返回数据 -&gt; 客户端处理数据</span><br><span class="line">4.关闭连接或者把连接返回到缓存池</span><br></pre></td></tr></table></figure>

<p>当前 rps stream的实现方式 是这样子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 连接服务器</span><br><span class="line">2. 客户端多次发送请求-&gt; 服务端接收</span><br><span class="line">3. 服务端多次返回数据-&gt; 客户端处理数据</span><br><span class="line">4. 关闭连接</span><br></pre></td></tr></table></figure>

<p>当数据量比较大的时候我们可以用stream方式分批次传输数据。对于客户端还是服务端没有限制，我们可以根据自己的需要使用stream方式，使用方式也非常的简单，在定义接口的时候在参数或者返回值前面加上stream然后就可以多次进行传输了，使用的代码还是之前写的例子,代码都在github上：<br>比如我的例子中定义了两个使用stream的接口，一个只在返回值使用stream，另一个是在参数和返回值前都加上了stream，最终的使用方式没有区别</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">rpc</span> Stream(model.SRequest) <span class="keyword">returns</span> (stream model.SResponse) &#123;&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">rpc</span> BidirectionalStream(stream model.SRequest) <span class="keyword">returns</span> (stream model.SResponse) &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>看一下go-micro为我们生成的代码rpcapi.micro.go里，不要被吓到，生成了很多代码，但是没啥理解不了的<br>Server端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server API for Say service</span></span><br><span class="line"><span class="keyword">type</span> SayHandler <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// .... others  </span></span><br><span class="line">    Stream(context.Context, *model.SRequest, Say_StreamStream) error</span><br><span class="line">    BidirectionalStream(context.Context, Say_BidirectionalStreamStream) error</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Say_StreamStream <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    Close() error</span><br><span class="line">    Send(*model.SResponse) error</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Say_BidirectionalStreamStream <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    Close() error</span><br><span class="line">    Send(*model.SResponse) error</span><br><span class="line">    Recv() (*model.SRequest, error)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// .... others</span></span><br></pre></td></tr></table></figure>

<p>Client端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Client API for Say service</span></span><br><span class="line"><span class="keyword">type</span> SayService <span class="keyword">interface</span> &#123; </span><br><span class="line">    <span class="comment">//... others</span></span><br><span class="line">    Stream(ctx context.Context, in *model.SRequest, opts ...client.CallOption) (Say_StreamService, error)</span><br><span class="line">    BidirectionalStream(ctx context.Context, opts ...client.CallOption) (Say_BidirectionalStreamService, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Say_StreamService <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    Close() error</span><br><span class="line">    Recv() (*model.SResponse, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Say_BidirectionalStreamService <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">    Close() error</span><br><span class="line">    Send(*model.SRequest) error</span><br><span class="line">    Recv() (*model.SResponse, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    你会发现参数前面加了 Stream后，生成的代码会把你的参数变成一个接口，这个接口主要要的方法是</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SendMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">RecvMsg(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">Close() error</span><br></pre></td></tr></table></figure>

<p>剩下的两个接口方法是根据你是发送还是接收生成的，如果有发送就会有Send(你的参数)，如果有接收会生成Rev() (你的参数，  error),但这两个方法只是为了让你使用时方便，里面调用的还是SendMsg(interface)和RecvMsg(interface)方法，但是他们是怎么工作的，如何多次发送和接收传输的数据，是不是感觉很神奇。</p>
<p>我就以<code>TsBidirectionalStream</code> 方法为例开始分析，上一篇和再早之前的帖子已经说了服务端启动的时候都做了哪些操作，这里就不再赘述，<br>服务端的实现,很简单，不断的获取客户端发过来的数据，再给客户端一次一次的返回一些数据。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 模拟数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Say)</span> <span class="title">BidirectionalStream</span><span class="params">(ctx context.Context, stream rpcapi.Say_BidirectionalStreamStream)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        req, err := stream.Recv()</span><br><span class="line">        <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="keyword">int64</span>(<span class="number">0</span>); i &lt; req.Count; i++ &#123;</span><br><span class="line">            <span class="keyword">if</span> err := stream.Send(&amp;model.SResponse&#123;Value: []<span class="keyword">string</span> &#123;lib.RandomStr(lib.Random(<span class="number">3</span>, <span class="number">6</span>))&#125;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务，服务开始监听客户端传过来的数据…..<br>客户端调用服务端方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用 </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TsBidirectionalStream</span><span class="params">(client rpcapi.SayService)</span></span> &#123;</span><br><span class="line">    rspStream, err := client.BidirectionalStream(context.Background())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// send</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        rspStream.Send(&amp;model.SRequest&#123;Count: <span class="number">2</span>&#125;)</span><br><span class="line">        rspStream.Send(&amp;model.SRequest&#123;Count: <span class="number">5</span>&#125;)</span><br><span class="line">        <span class="comment">// close the stream</span></span><br><span class="line">        <span class="keyword">if</span> err := rspStream.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"stream close err:"</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">     <span class="comment">// recv</span></span><br><span class="line">    idx := <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span>  &#123;</span><br><span class="line">        rsp, err := rspStream.Recv()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">"test stream get idx %d  data  %v\n"</span>, idx, rsp)</span><br><span class="line">        idx++</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">"Read Value End"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当客户端在调用rpc的stream方法是要很得到stream</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rspStream, err := client.BidirectionalStream(context.Background())</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *sayService)</span> <span class="title">BidirectionalStream</span><span class="params">(ctx context.Context, opts ...client.CallOption)</span> <span class="params">(Say_BidirectionalStreamService, error)</span></span> &#123;</span><br><span class="line">    req := c.c.NewRequest(c.name, <span class="string">"Say.BidirectionalStream"</span>, &amp;model.SRequest&#123;&#125;)</span><br><span class="line">    stream, err := c.c.Stream(ctx, req, opts...)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;sayServiceBidirectionalStream&#123;stream&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个调用<code>c.c.Stream(ctx, req, opts...)</code>是关键，他的内部实现就是和服务器进行连接，然后返回一个stream，进行操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">客户端：和服务端建立连接，返回Stream，进行接收和发送数据</span><br><span class="line">服务端：接收客户端连接请求，利用反射找到相应的方法，组织Strem，传给方法，进行数据的发送和接收</span><br></pre></td></tr></table></figure>

<p>建立连接的时候就是一次rpc调用，服务端接受连接，然后客户端发送一次调用，但是传输的是空数据，服务端利用反射找到具体的方法，组织stream，调用具体方法，利用这个连接，客户端和服务端进行多次通信。</p>
<p><img src="/" alt="img" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/blog/microserive/2019-go-micro-13.jpg"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:null">Wang YangYang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://wangyangyangisme.github.io/2019/09/27/microservice-gomicro%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">http://wangyangyangisme.github.io/2019/09/27/microservice-gomicro%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://wangyangyangisme.github.io" target="_blank">WangYangYang</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/76bc52296bcf2e0b7a1d628106ffcd52.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/fab2285fdcd13ead0a8b4a853c659d03.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/09/27/microservice-go%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%93/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/0962a1f2d74318fba76ea47b22c6edda.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">go微服务库</div></div></a></div><div class="next-post pull_right"><a href="/2019/09/27/microservice-etcd%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/microservice/791c1e6fcd278681840f1a9a88278d34.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">etcd集群配置</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: true,
  verify: false,
  appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
  appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
  placeholder: '请留下你的脚印',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-cn',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Wang YangYang</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyangyangisme.github.io/">blog</a>!</div><div class="icp"><a><img class="icp-icon" src="/img/icp.png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/click_heart.js"></script><script src="/js/search/algolia.js"></script></body></html>