<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Nats管理服务器 | WangYangYang</title><meta name="description" content="Nats管理服务器"><meta name="author" content="Wang YangYang"><meta name="copyright" content="Wang YangYang"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nats管理服务器"><meta name="twitter:description" content="Nats管理服务器"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/nats/285494672816019cfb027039031cb3ca.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Nats管理服务器"><meta property="og:url" content="http://wangyangyangisme.github.io/2019/09/27/nats-NATS-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/"><meta property="og:site_name" content="WangYangYang"><meta property="og:description" content="Nats管理服务器"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/nats/285494672816019cfb027039031cb3ca.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      now = new Date();
      hour = now.getHours();
      isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://wangyangyangisme.github.io/2019/09/27/nats-NATS-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/"><link rel="prev" title="NATS Streaming" href="http://wangyangyangisme.github.io/2019/09/27/nats-NATS-Streaming/"><link rel="next" title="MySql查询不区分大小写解决方案" href="http://wangyangyangisme.github.io/2019/09/27/mysql-MySql%E6%9F%A5%E8%AF%A2%E4%B8%8D%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"C4QN4OTLJM","apiKey":"c2c026ba64eeb77abd2164975fa41f34","indexName":"wyy","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://wangyangyangisme.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: false,
  isFontAwesomeV5: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false
}</script></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">187</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">36</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nats管理服务器"><span class="toc-text">Nats管理服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装NATS服务器"><span class="toc-text">安装NATS服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#从二进制安装"><span class="toc-text">从二进制安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#平台特定方法"><span class="toc-text">平台特定方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试您的安装"><span class="toc-text">测试您的安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行NATS服务器"><span class="toc-text">运行NATS服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启用带监控的NATS服务器（可选）"><span class="toc-text">启用带监控的NATS服务器（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行选项"><span class="toc-text">命令行选项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS服务器身份验证"><span class="toc-text">NATS服务器身份验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行选项-1"><span class="toc-text">命令行选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#单用户配置选项"><span class="toc-text">单用户配置选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多用户身份验证"><span class="toc-text">多用户身份验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户连接字符串"><span class="toc-text">客户连接字符串</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#群集升级"><span class="toc-text">群集升级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#种子服务器"><span class="toc-text">种子服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS服务器安全性"><span class="toc-text">NATS服务器安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS密码"><span class="toc-text">TLS密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端TLS相互身份验证"><span class="toc-text">客户端TLS相互身份验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#群集TLS相互身份验证"><span class="toc-text">群集TLS相互身份验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用bcrypt保护密码"><span class="toc-text">使用bcrypt保护密码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS服务器授权"><span class="toc-text">NATS服务器授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#例子"><span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS服务器配置"><span class="toc-text">NATS服务器配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置文件格式"><span class="toc-text">配置文件格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#示例服务器配置文件"><span class="toc-text">示例服务器配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#变量"><span class="toc-text">变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建NATS服务器群集"><span class="toc-text">构建NATS服务器群集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#群集URL"><span class="toc-text">群集URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行选项-2"><span class="toc-text">命令行选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三个服务器群集示例"><span class="toc-text">三个服务器群集示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#容器化NATS服务器"><span class="toc-text">容器化NATS服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Docker进行群集"><span class="toc-text">使用Docker进行群集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#教程"><span class="toc-text">教程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS服务器日志记录"><span class="toc-text">NATS服务器日志记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置日志记录"><span class="toc-text">配置日志记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用logrotate记录旋转"><span class="toc-text">使用logrotate记录旋转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些记录笔记"><span class="toc-text">一些记录笔记</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#监控NATS服务器"><span class="toc-text">监控NATS服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启用监控"><span class="toc-text">启用监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#监控端点"><span class="toc-text">监控端点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建监控应用程序"><span class="toc-text">创建监控应用程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#跟踪NATS统计信息"><span class="toc-text">跟踪NATS统计信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用法"><span class="toc-text">用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#选项"><span class="toc-text">选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令"><span class="toc-text">命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#消费者缓慢"><span class="toc-text">消费者缓慢</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#消费者缓慢-1"><span class="toc-text">消费者缓慢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#什么是慢消费者？"><span class="toc-text">什么是慢消费者？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#慢消费者会怎么样？"><span class="toc-text">慢消费者会怎么样？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#客户中发现的消费者缓慢"><span class="toc-text">客户中发现的消费者缓慢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务器识别的消费者缓慢"><span class="toc-text">服务器识别的消费者缓慢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#处理慢消费者"><span class="toc-text">处理慢消费者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#衡量发布者"><span class="toc-text">衡量发布者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过配置调整NATS"><span class="toc-text">通过配置调整NATS</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务器配置"><span class="toc-text">服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端配置"><span class="toc-text">客户端配置</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/nats/285494672816019cfb027039031cb3ca.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">WangYangYang</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Nats管理服务器</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-09-27<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-11-06</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/nats/">nats</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">13k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 52 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2019/09/27/nats-NATS-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/09/27/nats-NATS-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="Nats管理服务器"><a href="#Nats管理服务器" class="headerlink" title="Nats管理服务器"></a>Nats管理服务器</h1><h2 id="安装NATS服务器"><a href="#安装NATS服务器" class="headerlink" title="安装NATS服务器"></a>安装NATS服务器</h2><p>有许多方法可以安装NATS服务器。</p>
<h3 id="从二进制安装"><a href="#从二进制安装" class="headerlink" title="从二进制安装"></a>从二进制安装</h3><p>GitHub版本页面上始终提供最新的官方发行版二进制文件。可以使用以下平台：</p>
<ul>
<li>Linux (x86, x86_64, ARM)</li>
<li>Windows (x86, x86_64)</li>
<li>macOS</li>
</ul>
<h3 id="平台特定方法"><a href="#平台特定方法" class="headerlink" title="平台特定方法"></a>平台特定方法</h3><blockquote>
<p>以下方法可能并非全部安装最新发布的版本</p>
</blockquote>
<p><strong>GO</strong></p>
<p>确保设置了Go环境，然后使用go get进行安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/nats-io/nats-server</span><br></pre></td></tr></table></figure>

<p><strong>Docker Hub</strong></p>
<p>Docker Hub上提供了最新的官方Docker镜像。<br><strong>Windows</strong></p>
<p>在Windows上，可以通过<a href="https://hub.docker.com/nats/" target="_blank" rel="noopener">Chocolatey</a>安装NATS服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">choco install nats-server</span><br></pre></td></tr></table></figure>

<p><strong>macOS</strong></p>
<p>在macOS上，可以通过Homebrew安装NATS服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nats-server</span><br></pre></td></tr></table></figure>

<h3 id="测试您的安装"><a href="#测试您的安装" class="headerlink" title="测试您的安装"></a>测试您的安装</h3><p>要测试您的安装，您可以调用NATS服务器二进制文件，没有选项，也没有配置文件（没有身份验证，没有群集）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server</span><br></pre></td></tr></table></figure>

<p>当服务器成功启动时，您将看到NATS服务器在TCP端口4222上侦听客户端连接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[18141] 2016/10/31 13:13:40.732616 [INF] Starting nats-server version 0.9.4</span><br><span class="line">[18141] 2016/10/31 13:13:40.732704 [INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[18141] 2016/10/31 13:13:40.732967 [INF] Server is ready</span><br></pre></td></tr></table></figure>

<h2 id="运行NATS服务器"><a href="#运行NATS服务器" class="headerlink" title="运行NATS服务器"></a>运行NATS服务器</h2><p>开箱即用，您可以在没有任何自定义设置的情况下运行NATS服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server</span><br></pre></td></tr></table></figure>

<h3 id="启用带监控的NATS服务器（可选）"><a href="#启用带监控的NATS服务器（可选）" class="headerlink" title="启用带监控的NATS服务器（可选）"></a>启用带监控的NATS服务器（可选）</h3><p>NATS服务器在端口8222上公开监控接口。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -m 8222</span><br></pre></td></tr></table></figure>

<p>如果在启用监控的情况下运行NATS服务器，则会看到以下消息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[18159] 2016/10/31 13:14:03.055572 [INF] Starting nats-server version 0.9.4</span><br><span class="line">[18159] 2016/10/31 13:14:03.055692 [INF] Starting http monitor on 0.0.0.0:8222</span><br><span class="line">[18159] 2016/10/31 13:14:03.055762 [INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[18159] 2016/10/31 13:14:03.055796 [INF] Server is ready</span><br></pre></td></tr></table></figure>



<h3 id="命令行选项"><a href="#命令行选项" class="headerlink" title="命令行选项"></a>命令行选项</h3><p>有两种配置服务器的方法。您可以包含一个或多个命令行参数，如下所述，也可以使用配置文件。<br><strong>常见选项</strong></p>
<ul>
<li>-h， - help          显示帮助消息</li>
<li>-v， - version      显示版本信息</li>
</ul>
<p><strong>服务器选项</strong></p>
<ul>
<li>-a， –addr HOST 绑定主机IP地址（默认是0.0.0.0）</li>
<li>-p， –port PORT 客户端连接NATS服务器使用的端口（默认是4222）</li>
<li>-P， –pid FILE 存储PID的文件</li>
<li>-m， –http_port PORT 使用HTTP端口作为监听端口</li>
<li>-ms， –https_port PORT 使用HTTPS端口作为监听端口</li>
<li>-c， –config FILE 指定配置文件</li>
<li>-client_advertise HOST：PORT配置INFO消息中返回的HOST和PORT</li>
</ul>
<p><strong>日志选项</strong></p>
<ul>
<li>-l， –log FILE 指定日志输出的文件</li>
<li>-T， –logtime 是否开启日志的时间戳（默认为true）</li>
<li>-s， –syslog 启用syslog作为日志方法</li>
<li>-r， –remote_syslog 远程日志服务器的地址（默认为udp://localhost:514）</li>
<li>-D， –debug 开启调试输出</li>
<li>-V, –trace 跟踪原始的协议</li>
<li>-DV 调试并跟踪</li>
</ul>
<p><strong>授权认证选项</strong></p>
<ul>
<li><p>–user user         连接需要的用户名</p>
</li>
<li><p>–pass password     连接需要的密码</p>
</li>
<li><p>–auth token    连接所需的令牌</p>
</li>
</ul>
<p><strong>TLS安全选项</strong></p>
<ul>
<li><p>–help_tls      TLS 帮助</p>
</li>
<li><p>–tls 启用TLS，不验证客户端（默认为false）</p>
</li>
<li><p>–tlscert FILE 服务器证书文件</p>
</li>
<li><p>–tlskey FILE 服务器证书私钥</p>
</li>
<li><p>–tlsverify 启用TLS，每一个客户端都要认证</p>
</li>
<li><p>–tlscacert FILE 客户端证书CA用于认证</p>
</li>
</ul>
<p><strong>群集选项</strong></p>
<ul>
<li>–routes [rurl-1，rurl-2]路线征求和连接</li>
<li>–cluster [cluster url]请求路由的群集URL</li>
</ul>
<p>如果启用了路由，则路由（服务器）连接将侦听端口6222。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[18159] 2016/10/31 13:14:03.055572 [INF] Starting nats-server version 0.9.4</span><br><span class="line">[18159] 2016/10/31 13:14:03.055692 [INF] Starting http monitor on 0.0.0.0:8222</span><br><span class="line">[18159] 2016/10/31 13:14:03.055707 [INF] Listening for route connections on 0.0.0.0:6222</span><br><span class="line">[18159] 2016/10/31 13:14:03.055762 [INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[18159] 2016/10/31 13:14:03.055796 [INF] Server is ready</span><br></pre></td></tr></table></figure>

<h2 id="NATS服务器身份验证"><a href="#NATS服务器身份验证" class="headerlink" title="NATS服务器身份验证"></a>NATS服务器身份验证</h2><p>您可以在NATS服务器上启用身份验证，以便客户端在连接时必须验证其身份。 NATS服务器通过命令行或使用配置文件支持单用户身份验证，并通过配置文件支持多用户身份验证。单用户身份验证是真正的单用户。服务器将接受一组设置好的凭据而不接受其他凭据。</p>
<h3 id="命令行选项-1"><a href="#命令行选项-1" class="headerlink" title="命令行选项"></a>命令行选项</h3><p>您可以通过在命令行上传递所需的凭据来启用启用了单用户身份验证的NATS服务器。命令行支持以下服务器身份验证选项：</p>
<ul>
<li>–user user连接所需的用户</li>
<li>–pass password连接所需的密码</li>
<li>–auth令牌连接所需的授权令牌</li>
</ul>
<p>令牌与用户和密码互斥，因此只能使用其中一个。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -DV --user foo --pass bar</span><br></pre></td></tr></table></figure>

<p>将允许用户foo使用密码登录。</p>
<p>使用带有授权令牌的命令行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -DV -auth'S3Cr3T0k3n!'</span><br></pre></td></tr></table></figure>

<p>将允许具有该令牌的客户端连接，而不允许其他客户端。</p>
<h3 id="单用户配置选项"><a href="#单用户配置选项" class="headerlink" title="单用户配置选项"></a>单用户配置选项</h3><p>可以在配置文件中配置单用户身份验证：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  user:     derek</span><br><span class="line">  password: T0pS3cr3t</span><br><span class="line">  timeout:  1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果服务器是群集的一部分，您还可以为路由连接设置单用户身份验证：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  user:     derek</span><br><span class="line">  password: T0pS3cr3t</span><br><span class="line">  timeout:  1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两种配置都设置用户和密码以及连接超时。 auth选项也可以设置为使用令牌而不是用户/密码。</p>
<h3 id="多用户身份验证"><a href="#多用户身份验证" class="headerlink" title="多用户身份验证"></a>多用户身份验证</h3><p>多用户身份验证只能在配置文件中设置。用户在具有用户/密码对的列表中定义。</p>
<p>例如，要定义两个用户alice和bob：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  users = [</span><br><span class="line">    &#123;user: alice, password: foo&#125;</span><br><span class="line">    &#123;user: bob,   password: bar&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您还可以使用变量来设置用户和密码值。例如，这里将密码声明为名为PASS的变量并分配给Joe。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  PASS: abcdefghijklmnopqrstuvwxyz0123456789</span><br><span class="line">  users = [</span><br><span class="line">    &#123;user: alice, password: foo&#125;</span><br><span class="line">    &#123;user: bob,   password: bar&#125;</span><br><span class="line">    &#123;user: joe,   password: $PASS&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nats-server源代码包含一个可用于加密配置文件密码的工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> go run mkpasswd.go -p</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> password: password</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> bcrypt <span class="built_in">hash</span>: <span class="variable">$2a</span><span class="variable">$11</span><span class="variable">$1oJy</span>/wZYNTxr9jNwMNwS3eUGhBpHT3On8CL9o7ey89mpgo88VG6ba</span></span><br></pre></td></tr></table></figure>

<p>这允许您存储散列密码而不是纯文本密码。</p>
<h3 id="客户连接字符串"><a href="#客户连接字符串" class="headerlink" title="客户连接字符串"></a>客户连接字符串</h3><p>要作为经过身份验证的客户端连接到服务器，您可以在连接字符串中传入凭据。</p>
<p>例如，用户’foo’，密码为’bar’：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats://foo:bar@localhost:4222</span><br></pre></td></tr></table></figure>

<p>使用令牌’S3Cr3T0k3n！’</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats://foo:bar@localhost:4222</span><br></pre></td></tr></table></figure>

<p>服务器还支持“安全/加密”部分中记录的TLS相互身份验证。开发人员文档中还讨论了其他方法。</p>
<h2 id="群集升级"><a href="#群集升级" class="headerlink" title="群集升级"></a>群集升级</h2><p>升级群集的基本策略是围绕服务器将群集配置闲置到客户端和其他服务器的能力。当群集配置更改时，客户端会自动了解新服务器。在断开连接的情况下，除了从其连接设置知道的服务器之外，客户端还具有加入群集的服务器列表。</p>
<p>请注意，由于每个服务器都存储自己的权限和身份验证配置，因此添加到群集的新服务器应提供相同的用户和授权，以防止客户端被拒绝或获得意外权限。</p>
<p>为了描述场景，让我们在键盘上获取一些手指，并完成动作。让我们考虑两个服务器的集群：’A’和’B’，以及 - 集群应该是三到五个服务器，但为了描述行为和集群升级过程，两个服务器的集群就足够了。</p>
<p>让我们构建这个集群：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4222 -cluster nats://localhost:6222 -routes nats://localhost:6222,nats://localhost:6333</span><br></pre></td></tr></table></figure>

<p>上面的命令启动启用了调试输出的<code>nats-server</code>，在端口4222上侦听客户端，以及在端口6222上接受集群连接。<code>-routes</code>选项指定服务器将尝试连接到其他服务器的nats URL列表。这些URL定义在群集对等方上启用的群集端口。</p>
<p>敏锐的读者会注意到自我路线。 Gnatsd将忽略自我路由，但它为所有服务器提供单一一致的配置。</p>
<p>您将看到服务器已启动，我们注意到它会发出一些警告，因为它无法连接到“localhost：6333”。消息更准确地读取：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error trying to connect to route: dial tcp localhost:6333: connect: connection refused</span><br></pre></td></tr></table></figure>

<p>让我们通过启动第二台服务器来解决这个问题：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4333 -cluster nats://localhost:6333 -routes nats://localhost:6222,nats://localhost:6333</span><br></pre></td></tr></table></figure>

<p>第二台服务器在端口4333上启动，其集群端口在6333上。否则与“A”相同。</p>
<p>让我们得到一个客户端，这样我们可以观察它在服务器被移除后在服务器之间移动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-sub -s nats://localhost:4222 "&gt;"</span><br></pre></td></tr></table></figure>

<p>Nats-sub是所有NATS客户端都包含的订户样本。 Nats-sub订阅主题并打印出收到的任何消息。您可以在nats-sub [here]（<a href="https://github.com/nats-io/go-nats/tree/master/examples）的go版本中找到源代码。启动订阅者后，您应该在“A”上看到新客户端连接的消息。" target="_blank" rel="noopener">https://github.com/nats-io/go-nats/tree/master/examples）的go版本中找到源代码。启动订阅者后，您应该在“A”上看到新客户端连接的消息。</a></p>
<p>我们有两台服务器和一台客户端。是时候模拟我们的滚动升级了。但等等，在我们升级’A’之前，让我们介绍一个新的服务器’T.’服务’T’将在我们执行升级时加入现有的集群。它的唯一目的是为客户提供一个额外的地方，除了’A’之外，确保我们不会在升级过程之后为所有客户提供服务。客户端将在连接时随机选择服务器，除非提供禁用该功能的特殊选项（通常称为“DontRandomize”或“noRandomize”）。您可以阅读更多关于“避免雷鸣群”的信息。可以说客户端在集群中的所有服务器之间均匀地重新分配。在我们的案例中，’A’的1/2客户将跳转到’B’，剩下的一半将转为’T’。</p>
<p>让我们开始我们的临时服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4444 -cluster nats://localhost:6444 -routes nats://localhost:6222,nats://localhost:6333</span><br></pre></td></tr></table></figure>

<p>大约一瞬间，’A’上的客户了解加入的新集群成员。在我们的动手教程中，nats-sub现在知道3个可能的服务器，’A’（在我们启动工具时指定）和从群集八卦中学习的’B’和’T’。</p>
<p>我们通过向’A’上的终端发出CTRL + C来调用我们的管理员权限并关闭’A’，并观察’B’或’T’报告新客户端已连接。那是我们的nats-sub客户端。</p>
<p>我们执行升级过程，更新“A”的二进制文件，然后重新启动“A”：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4222 -cluster nats://localhost:6222 -routes nats://localhost:6222,nats://localhost:6333</span><br></pre></td></tr></table></figure>

<p>我们继续升级’B’。请注意，来自“B”的客户端重新连接到“A”和“T”。我们升级并重新启动’B’：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4333 -cluster nats://localhost:6333 -routes nats://localhost:6222,nats://localhost:6333</span><br></pre></td></tr></table></figure>

<p>如果我们有更多服务器，我们将继续停止，更新，重新启动旋转，就像我们对’A’和’B’所做的那样。重新启动最后一台服务器之后，我们可以继续关闭’T’’’T’上的任何客户端’将重新分配给我们的永久集群成员。</p>
<h3 id="种子服务器"><a href="#种子服务器" class="headerlink" title="种子服务器"></a>种子服务器</h3><p>在上面的例子中，我们启动了nats-server指定两个聚类路由。可以允许服务器协议驱动它并减少配置量。例如，您可以按如下方式启动A，B和C：<br>A - 种子服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4222 -cluster nats：// localhost：6222</span><br></pre></td></tr></table></figure>

<p>B</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4333 -cluster nats://localhost:6333 -routes nats://localhost:6222</span><br></pre></td></tr></table></figure>

<p>C</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -D -p 4444 -cluster nats://localhost:6444 -routes nats://localhost:6222</span><br></pre></td></tr></table></figure>

<p>一旦它们连接到“种子服务器”，它将了解所有其他服务器并相互连接形成完整网格。</p>
<h2 id="NATS服务器安全性"><a href="#NATS服务器安全性" class="headerlink" title="NATS服务器安全性"></a>NATS服务器安全性</h2><p>从版本0.7.0开始，服务器可以使用现代TLS语义进行客户端连接，路由连接和HTTPS监控端口。要在客户端端口上启用TLS，请按如下所示添加TLS配置部分：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Simple TLS config file</span></span><br><span class="line"></span><br><span class="line">listen: 127.0.0.1:4443</span><br><span class="line"></span><br><span class="line">tls &#123;</span><br><span class="line">  cert_file:  "./configs/certs/server-cert.pem"</span><br><span class="line">  key_file:   "./configs/certs/server-key.pem"</span><br><span class="line">  timeout:    2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">authorization &#123;</span><br><span class="line">  user:     derek</span><br><span class="line">  password: $2a$11$W2zko751KUvVy59mUTWmpOdWjpEm5qhcCZRd05GjI/sSOT.xtiHyG</span><br><span class="line">  timeout:  1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：如果使用https_port选项启用，则此TLS配置也用于监控端口。</p>
<p>服务器需要证书和私钥。生成自签名证书和中间证书颁发机构超出了此范围，但除了Google搜索之外，此文档也很有帮助：https：//docs.docker.com/engine/articles/https/</p>
<p>可以使用命令行参数运行服务器以启用TLS功能。</p>
<ul>
<li><p>–help_tls      TLS 帮助</p>
</li>
<li><p>–tls 启用TLS，不验证客户端（默认为false）</p>
</li>
<li><p>–tlscert FILE 服务器证书文件</p>
</li>
<li><p>–tlskey FILE 服务器证书私钥</p>
</li>
<li><p>–tlsverify 启用TLS，每一个客户端都要认证</p>
</li>
<li><p>–tlscacert FILE 客户端证书CA用于认证</p>
</li>
</ul>
<p>使用为localhost和127.0.0.1自签名的测试证书的示例。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ./nats-server --tls --tlscert=./<span class="built_in">test</span>/configs/certs/server-cert.pem --tlskey=./<span class="built_in">test</span>/configs/certs/server-key.pem</span></span><br><span class="line"></span><br><span class="line">[2935] 2016/04/26 13:34:30.685413 [INF] Starting nats-server version 0.8.0.beta</span><br><span class="line">[2935] 2016/04/26 13:34:30.685509 [INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[2935] 2016/04/26 13:34:30.685656 [INF] TLS required for client connections</span><br><span class="line">[2935] 2016/04/26 13:34:30.685660 [INF] Server is ready</span><br></pre></td></tr></table></figure>

<p>请注意，日志表明客户端连接将需要使用TLS。如果使用-D或-DV在调试模式下运行服务器，则日志将显示每个连接的客户端的密码套件选择。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[15146] 2015/12/03 12:38:37.733139 [DBG] ::1:63330 - cid:1 - Starting TLS client connection handshake</span><br><span class="line">[15146] 2015/12/03 12:38:37.751948 [DBG] ::1:63330 - cid:1 - TLS handshake complete</span><br><span class="line">[15146] 2015/12/03 12:38:37.751959 [DBG] ::1:63330 - cid:1 - TLS version 1.2, cipher suite TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><br></pre></td></tr></table></figure>

<h3 id="TLS密码"><a href="#TLS密码" class="headerlink" title="TLS密码"></a>TLS密码</h3><p>服务器需要TLS 1.2版，并设置现代密码套件的首选项，以避免已知的漏洞。使用Go1.5构建时，服务器的默认首选项如下所示。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">defaultCipherSuites</span><span class="params">()</span> []<span class="title">uint16</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> []<span class="keyword">uint16</span>&#123;</span><br><span class="line">    <span class="comment">// The SHA384 versions are only in Go1.5+</span></span><br><span class="line">    tls.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,</span><br><span class="line">    tls.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,</span><br><span class="line">    tls.TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,</span><br><span class="line">    tls.TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,</span><br><span class="line">    tls.TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,</span><br><span class="line">    tls.TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可选地，如果您的组织需要特定密码或密码列表，则可以使用cipher_suites选项对其进行配置，如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tls &#123;</span><br><span class="line">  cert_file:  "./configs/certs/server.pem"</span><br><span class="line">  key_file:   "./configs/certs/key.pem"</span><br><span class="line">  timeout: 2</span><br><span class="line">  cipher_suites: [</span><br><span class="line">    "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",</span><br><span class="line">    "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>支持的密码套件列表位于cipherMap变量中。</p>
<h3 id="客户端TLS相互身份验证"><a href="#客户端TLS相互身份验证" class="headerlink" title="客户端TLS相互身份验证"></a>客户端TLS相互身份验证</h3><p>可选地，服务器可以要求客户端需要提供证书，并且可以使用CA权限配置服务器以验证客户端证书。只需添加选项验证TLS配置部分，如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tls &#123;</span><br><span class="line">  cert_file: "./configs/certs/server-cert.pem"</span><br><span class="line">  key_file:  "./configs/certs/server-key.pem"</span><br><span class="line">  ca_file:   "./configs/certs/ca.pem"</span><br><span class="line">  verify:    true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您希望服务器通过命令行强制执行并需要客户端证书，请使用此示例。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ./nats-server --tlsverify --tlscert=./<span class="built_in">test</span>/configs/certs/server-cert.pem --tlskey=./<span class="built_in">test</span>/configs/certs/server-key.pem --tlscacert=./<span class="built_in">test</span>/configs/certs/ca.pem</span></span><br></pre></td></tr></table></figure>

<p>此选项仅验证客户端的证书是否已由ca_file选项中指定的CA签名。但是，它不会将客户端证书的任何属性映射到用户的身份。</p>
<p><code>要使TLS相互身份验证将证书属性映射到用户身份，请将选项</code>verify<code>替换为verify_and_map</code>，如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tls &#123;</span><br><span class="line">  cert_file: "./configs/certs/server-cert.pem"</span><br><span class="line">  key_file:  "./configs/certs/server-key.pem"</span><br><span class="line">  ca_file:   "./configs/certs/ca.pem"</span><br><span class="line">  # Require a client certificate and map user id from certificate</span><br><span class="line">  verify_and_map: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>证书属性有两个选项可以映射到用户名。第一个是证书的主题备用名称（SAN）字段中的电子邮件地址。虽然使用此属性生成证书超出了本文档的范围，但我们将使用OpenSSL查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -noout -text -<span class="keyword">in</span>  <span class="built_in">test</span>/configs/certs/client-id-auth-cert.pem</span></span><br><span class="line">Certificate:</span><br><span class="line">  -------------&lt;truncated&gt;-------------</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:localhost, IP Address:127.0.0.1, email:derek@nats.io</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Client Authentication</span><br><span class="line">  -------------&lt;truncated&gt;-------------</span><br></pre></td></tr></table></figure>

<p>授权此用户的配置如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  users = [</span><br><span class="line">    &#123;user: "derek@nats.io", permissions: &#123; publish: "foo" &#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：如果SAN字段中有多封电子邮件，则此配置仅适用于第一个电子邮件地址。</p>
<p>第二个选项是使用证书主题中的RFC 2253可分辨名称语法，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openssl x509 -noout -text -<span class="keyword">in</span>  <span class="built_in">test</span>/configs/certs/tlsauth/client2.pem</span></span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">  -------------&lt;truncated&gt;-------------</span><br><span class="line">        Subject: OU=CNCF, CN=example.com</span><br><span class="line">  -------------&lt;truncated&gt;-------------</span><br></pre></td></tr></table></figure>

<p>授权此用户的配置如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  users = [</span><br><span class="line">    &#123;user: "CN=example.com,OU=CNCF", permissions: &#123; publish: "foo" &#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="群集TLS相互身份验证"><a href="#群集TLS相互身份验证" class="headerlink" title="群集TLS相互身份验证"></a>群集TLS相互身份验证</h3><p>设置群集时，群集中的所有服务器（如果使用TLS）都将验证连接端点和服务器响应。因此，双向检查证书。只能为服务器的群集标识配置证书，从而使客户端和服务器证书与群集形成分开。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cluster &#123;</span><br><span class="line">  listen: 127.0.0.1:4244</span><br><span class="line"></span><br><span class="line">  tls &#123;</span><br><span class="line">    # Route cert</span><br><span class="line">    cert_file: "./configs/certs/srva-cert.pem"</span><br><span class="line">    # Private key</span><br><span class="line">    key_file:  "./configs/certs/srva-key.pem"</span><br><span class="line">    # Optional certificate authority verifying connected routes</span><br><span class="line">    # Required when we have self-signed CA, etc.</span><br><span class="line">    ca_file:   "./configs/certs/ca.pem"</span><br><span class="line">  &#125;</span><br><span class="line">  # Routes are actively solicited and connected to from this server.</span><br><span class="line">  # Other servers can connect to us if they supply the correct credentials</span><br><span class="line">  # in their routes definitions from above.</span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://127.0.0.1:4246</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用bcrypt保护密码"><a href="#使用bcrypt保护密码" class="headerlink" title="使用bcrypt保护密码"></a>使用bcrypt保护密码</h3><p>除了TLS功能外，服务器现在还支持使用<code>bcrypt</code>散列密码和身份验证令牌。要利用这一点，只需使用其bcrypt哈希替换配置中的明文密码，服务器将根据需要自动使用<code>bcrypt</code>。</p>
<p><code>nats-server</code>发行版包含一个用于创建<code>bcrypt</code>哈希的实用程序（<code>util / mkpasswd.go</code>）。不带参数运行它将生成新的安全密码以及相关的哈希。这可用于配置中的密码或令牌。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/go/src/github.com/nats-io/nats-server/util&gt; go get golang.org/x/crypto/ssh/terminal</span><br><span class="line">~/go/src/github.com/nats-io/nats-server/util&gt; go build mkpasswd.go</span><br><span class="line">~/go/src/github.com/nats-io/nats-server/util&gt; ./mkpasswd</span><br><span class="line">pass: #IclkRPHUpsTmACWzmIGXr</span><br><span class="line">bcrypt hash: $2a$11$3kIDaCxw.Glsl1.u5nKa6eUnNDLV5HV9tIuUp7EHhMt6Nm9myW1aS</span><br></pre></td></tr></table></figure>

<p>如果您已经选择了密码，则可以在命令行上提供-p标志，输入所需的密码，并为其生成bcrypt哈希：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/go/src/github.com/nats-io/nats-server/util&gt; ./mkpasswd -p</span><br><span class="line">Enter Password: *******</span><br><span class="line">Reenter Password: ******</span><br><span class="line">bcrypt hash: $2a$11$3kIDaCxw.Glsl1.u5nKa6eUnNDLV5HV9tIuUp7EHhMt6Nm9myW1aS</span><br></pre></td></tr></table></figure>

<p>将哈希添加到服务器配置文件的授权部分。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  user: derek</span><br><span class="line">  password: $2a$11$3kIDaCxw.Glsl1.u5nKa6eUnNDLV5HV9tIuUp7EHhMt6Nm9myW1aS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NATS服务器授权"><a href="#NATS服务器授权" class="headerlink" title="NATS服务器授权"></a>NATS服务器授权</h2><p>NATS服务器支持基于每个用户使用主题级权限的授权。基于权限的授权可用于多用户身份验证。</p>
<p>每个权限授予都是一个具有两个字段的对象：经过身份验证的用户可以发布到哪些主题，以及经过身份验证的用户可以订阅哪些主题。解析器慷慨解释意图是什么，因此处理数组和单例。主题本身可以包含通配符。权限可以使用变量。</p>
<p>您可以通过在授权配置块内创建符合以下语法的条目来设置权限：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  PERMISSION_NAME = &#123;</span><br><span class="line">    publish = "singleton" or ["array", ...]</span><br><span class="line">    subscribe = "singleton" or ["array", ...]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重要说明NATS授权仅为白名单，这意味着为了不破坏请求/回复模式，您需要使用Alice和Bob为_INBOX。&gt;模式添加上述规则。如果未经授权的客户端发布或尝试订阅尚未列入白名单的主题，则操作将失败并记录在服务器上，并向客户端返回错误消息。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>以下是一个示例授权配置，它定义了四个用户，其中三个用户被分配了显式权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  ADMIN = &#123;</span><br><span class="line">    publish = "&gt;"</span><br><span class="line">    subscribe = "&gt;"</span><br><span class="line">  &#125;</span><br><span class="line">  REQUESTOR = &#123;</span><br><span class="line">    publish = ["req.foo", "req.bar"]</span><br><span class="line">    subscribe = "_INBOX.&gt;"</span><br><span class="line">  &#125;</span><br><span class="line">  RESPONDER = &#123;</span><br><span class="line">    subscribe = ["req.foo", "req.bar"]</span><br><span class="line">    publish = "_INBOX.&gt;"</span><br><span class="line">  &#125;</span><br><span class="line">  DEFAULT_PERMISSIONS = &#123;</span><br><span class="line">    publish = "SANDBOX.*"</span><br><span class="line">    subscribe = ["PUBLIC.&gt;", "_INBOX.&gt;"]</span><br><span class="line">  &#125;</span><br><span class="line">  PASS: abcdefghijklmnopqrstuvwxwz0123456789</span><br><span class="line">  users = [</span><br><span class="line">    &#123;user: joe,     password: foo,   permissions: $ADMIN&#125;</span><br><span class="line">    &#123;user: alice,   password: bar,   permissions: $REQUESTOR&#125;</span><br><span class="line">    &#123;user: bob,     password: $PASS, permissions: $RESPONDER&#125;</span><br><span class="line">    &#123;user: charlie, password: bar&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于Joe是ADMIN，他可以发布/订阅任何主题。我们使用通配符&gt;来匹配任何主题。</p>
<p>Alice是一个请求者，可以在主题<code>req.foo</code>或<code>req.bar</code>上发布请求，并订阅任何响应（<code>_INBOX.&gt;</code>）。</p>
<p>Charlie没有授予权限，因此继承了默认权限集。您可以通过将继承的默认权限分配给授权配置块内的default_permissions条目来设置它们。</p>
<p>Bob是Alice的任何请求的响应者，因此Bob需要能够订阅请求主题并回复Alice的回复主题，这将是一个<code>_INBOX.&gt;</code>。</p>
<h2 id="NATS服务器配置"><a href="#NATS服务器配置" class="headerlink" title="NATS服务器配置"></a>NATS服务器配置</h2><p>您可以使用服务器配置文件来配置NATS服务器，包括：</p>
<ul>
<li>客户端侦听端口</li>
<li>HTTP监控端口</li>
<li>客户端认证</li>
<li>群集定义</li>
<li>集群路线</li>
<li>日志</li>
<li>最大客户端连接</li>
<li>最大有效载荷</li>
</ul>
<p>此外，服务器配置语言支持用于自动化的块范围变量。</p>
<h3 id="配置文件格式"><a href="#配置文件格式" class="headerlink" title="配置文件格式"></a>配置文件格式</h3><p>服务器配置文件格式是一种灵活的格式，它结合了传统配置格式中的最佳格式以及JSON和YAML等较新的样式。</p>
<p>配置文件格式支持以下语法：</p>
<ul>
<li>Mixed Arrays: <code>[...]</code></li>
<li>Nested Maps: <code>{...}</code></li>
<li>Multiple comment types: <code>#</code> and <code>//</code></li>
<li>Key value assignments using:<ul>
<li>Equals sign (<code>foo = 2</code>)</li>
<li>Colon (<code>foo: 2</code>)</li>
<li>Whitespace (<code>foo 2</code>)</li>
</ul>
</li>
<li>Maps can be assigned with no key separator</li>
<li>Semicolons as value terminators in key/value assignments are optional</li>
</ul>
<p>通常，配置参数与命令行参数相同。但请注意以下差异：</p>
<ul>
<li>The listen option is host:port for connections, on the server command line it is -a and -p, no hostport is supported.</li>
<li>http/https  is only a port on the command line, on the config it is host:port  (there’s no config flag for the interface for the monitoring)</li>
<li>The  -cluster flag is used for defining the host:port where routes can be  solicited, on the config file this is called ‘listen’ as part property  of a ‘cluster’ object.</li>
</ul>
<h3 id="示例服务器配置文件"><a href="#示例服务器配置文件" class="headerlink" title="示例服务器配置文件"></a>示例服务器配置文件</h3><p>以下演示了NATS服务器配置文件的示例。另请参见NATS服务器自述文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">port: 4242      # port to listen for client connections</span><br><span class="line">net: localhost # optional listen interface, default is 0.0.0.0 (all)</span><br><span class="line"></span><br><span class="line">http_port: 8222 # HTTP monitoring port</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Authorization <span class="keyword">for</span> client connections</span></span><br><span class="line">authorization &#123;</span><br><span class="line">  user:     derek</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ./util/mkpasswd -p T0pS3cr3t</span></span><br><span class="line">    password: $2a$11$W2zko751KUvVy59mUTWmpOdWjpEm5qhcCZRd05GjI/sSOT.xtiHyG</span><br><span class="line">  timeout:  1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Cluster definition</span></span><br><span class="line">cluster &#123;</span><br><span class="line"></span><br><span class="line">  listen: localhost:4244 # host/port for inbound route connections</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Authorization <span class="keyword">for</span> route connections</span></span><br><span class="line">  authorization &#123;</span><br><span class="line">    user: route_user</span><br><span class="line">    # ./util/mkpasswd -p T0pS3cr3tT00!</span><br><span class="line">        password: $2a$11$xH8dkGrty1cBNtZjhPeWJewu/YPbSU.rXJWmS6SFilOBXzmZoMk9m</span><br><span class="line">    timeout: 0.5</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Routes are actively solicited and connected to from this server.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Other servers can connect to us <span class="keyword">if</span> they supply the correct credentials</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">in</span> their routes definitions from above.</span></span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://user1:pass1@127.0.0.1:4245</span><br><span class="line">    nats-route://user2:pass2@127.0.0.1:4246</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging options</span></span><br><span class="line">debug:   false</span><br><span class="line">trace:   true</span><br><span class="line">logtime: false</span><br><span class="line">log_file: "/tmp/nats-server.log"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> pid file</span></span><br><span class="line">pid_file: "/tmp/nats-server.pid"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Some system overides</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> max_connections</span></span><br><span class="line">max_connections: 100</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> maximum protocol control line</span></span><br><span class="line">max_control_line: 512</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> maximum payload</span></span><br><span class="line">max_payload: 65536</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Duration the server can block on a socket write to a client.  Exceeding the </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> deadline will designate a client as a slow consumer.</span></span><br><span class="line"> write_deadline: "2s"</span><br></pre></td></tr></table></figure>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>NATS服务器配置文件格式支持使用块范围的变量，这些变量可用于配置文件中的模板，特别是可以轻松设置权限字段的组值。</p>
<p>变量可以通过前缀$引用，例如$ PASSWORD。 变量可以在配置文件本身或参考环境变量中定义。</p>
<p>例如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">authorization &#123;</span><br><span class="line">  PASS: abcdefghijklmnopqrstuvwxyz0123456789</span><br><span class="line">  users = [</span><br><span class="line">    &#123;user: alice, password: foo&#125;</span><br><span class="line">    &#123;user: bob,   password: bar&#125;</span><br><span class="line">    &#123;user: joe,   password: $PASS&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构建NATS服务器群集"><a href="#构建NATS服务器群集" class="headerlink" title="构建NATS服务器群集"></a>构建NATS服务器群集</h2><p>NATS支持以群集模式运行每个服务器。您可以将服务器集群在一起，以实现高容量邮件系统以及弹性和高可用性。客户端是群集感知的。</p>
<p>请注意，NATS群集服务器的转发限制为一跳。这意味着每个nats-server实例只会将从客户端收到的消息转发到它有路由的紧邻的nats-server实例。从路由接收的消息将仅分发给本地客户端。因此，建议使用全网状集群或完整图表，以使NATS按预期运行，并在整个文档中进行描述。</p>
<h3 id="群集URL"><a href="#群集URL" class="headerlink" title="群集URL"></a>群集URL</h3><p>除了用于侦听客户端的端口之外，nats-server还可以侦听“集群”URL（-cluster选项）。然后，其他nats-server服务器可以将该URL添加到其-routes参数以加入群集。这些选项也可以在配置文件中指定，但为简单起见，本概述中仅显示命令行版本。<br><strong>没有群集运行</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -p 4222</span><br></pre></td></tr></table></figure>

<p><strong>运行简单群集</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Server A on 10.10.0.1</span></span><br><span class="line">nats-server -p 4222 -cluster nats://10.10.0.1:5222</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Server B on 10.10.0.2</span></span><br><span class="line">nats-server -p 4222 -cluster nats://10.10.0.2:5222 -routes nats://10.10.0.1:5222</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Server A on 10.10.0.1</span></span><br><span class="line">nats-server -p 4222 -cluster nats://10.10.0.1:5222 -routes nats://10.10.0.2:5222</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Server B on 10.10.0.2</span></span><br><span class="line">nats-server -p 4222 -cluster nats://10.10.0.2:5222 -routes nats://10.10.0.1:5222</span><br></pre></td></tr></table></figure>

<p>连接到群集中任何服务器的客户端将保持连接到群集，即使它最初连接到的服务器已关闭，只要至少保留一个服务器即可。</p>
<h3 id="命令行选项-2"><a href="#命令行选项-2" class="headerlink" title="命令行选项"></a>命令行选项</h3><p>支持以下群集选项：</p>
<ul>
<li>–routes [rurl-1，rurl-2]路线征求和连接</li>
<li>–cluster nats://host:port请求路由的集群URL</li>
</ul>
<p>当NATS服务器路由到指定的URL时，它会将自己的集群URL通告给路由路由中的所有其他服务器，从而有效地为所有其他服务器创建路由网格。</p>
<p>注意：使用-routes选项时，还必须指定-cluster选项。</p>
<p>也可以使用服务器配置文件配置群集。</p>
<h3 id="三个服务器群集示例"><a href="#三个服务器群集示例" class="headerlink" title="三个服务器群集示例"></a>三个服务器群集示例</h3><p>以下示例演示如何在同一主机上运行3个服务器的集群。我们将从种子服务器开始，并使用-D命令行参数来生成调试信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -p 4222 -cluster nats://localhost:4248 -D</span><br></pre></td></tr></table></figure>

<p>或者，您可以使用配置文件，我们称之为seed.conf，其内容类似于：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Cluster Seed Node</span><br><span class="line"></span><br><span class="line">listen: 127.0.0.1:4222</span><br><span class="line">http: 8222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  listen: 127.0.0.1:4248</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并像这样启动服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -config ./seed.conf -D</span><br></pre></td></tr></table></figure>

<p>这将产生类似于的输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[75653] 2016/04/26 15:14:47.339321 [INF] Listening for route connections on 127.0.0.1:4248</span><br><span class="line">[75653] 2016/04/26 15:14:47.340787 [INF] Listening for client connections on 127.0.0.1:4222</span><br><span class="line">[75653] 2016/04/26 15:14:47.340822 [DBG] server id is xZfu3u7usAPWkuThomoGzM</span><br><span class="line">[75653] 2016/04/26 15:14:47.340825 [INF] server is ready</span><br></pre></td></tr></table></figure>

<p>也可以单独指定主机名和端口。至少需要端口。如果您保留主机名，它将绑定到所有接口（’0.0.0.0’）。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cluster &#123;</span><br><span class="line">  host: 127.0.0.1</span><br><span class="line">  port: 4248</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在让我们再启动两台服务器，每台服务器都连接到种子服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -p 5222 -cluster nats://localhost:5248 -routes nats://localhost:4248 -D</span><br></pre></td></tr></table></figure>

<p>当在同一主机上运行时，我们需要为客户端连接选择不同的端口<code>-p</code>，并为用于接受其他路由的端口选择<code>-cluster</code>。请注意，<code>-routes</code>指向种子服务器的<code>-cluster</code>地址（<code>localhost:4248</code>）。</p>
<p>这是生成的日志。了解它如何连接并注册到种子服务器的路由（… GzM）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[75665] 2016/04/26 15:14:59.970014 [INF] Listening for route connections on localhost:5248</span><br><span class="line">[75665] 2016/04/26 15:14:59.971150 [INF] Listening for client connections on 0.0.0.0:5222</span><br><span class="line">[75665] 2016/04/26 15:14:59.971176 [DBG] server id is 53Yi78q96t52QdyyWLKIyE</span><br><span class="line">[75665] 2016/04/26 15:14:59.971179 [INF] server is ready</span><br><span class="line">[75665] 2016/04/26 15:14:59.971199 [DBG] Trying to connect to route on localhost:4248</span><br><span class="line">[75665] 2016/04/26 15:14:59.971551 [DBG] 127.0.0.1:4248 - rid:1 - Route connection created</span><br><span class="line">[75665] 2016/04/26 15:14:59.971559 [DBG] 127.0.0.1:4248 - rid:1 - Route connect msg sent</span><br><span class="line">[75665] 2016/04/26 15:14:59.971720 [DBG] 127.0.0.1:4248 - rid:1 - Registering remote route "xZfu3u7usAPWkuThomoGzM"</span><br><span class="line">[75665] 2016/04/26 15:14:59.971731 [DBG] 127.0.0.1:4248 - rid:1 - Route sent local subscriptions</span><br></pre></td></tr></table></figure>

<p>从种子的服务器日志中，我们看到路由确实被接受：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[75653] 2016/04/26 15:14:59.971602 [DBG] 127.0.0.1:52679 - rid:1 - Route connection created</span><br><span class="line">[75653] 2016/04/26 15:14:59.971733 [DBG] 127.0.0.1:52679 - rid:1 - Registering remote route "53Yi78q96t52QdyyWLKIyE"</span><br><span class="line">[75653] 2016/04/26 15:14:59.971739 [DBG] 127.0.0.1:52679 - rid:1 - Route sent local subscriptions</span><br></pre></td></tr></table></figure>

<p>最后，让我们启动第三台服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -p 6222 -cluster nats://localhost:6248 -routes nats://localhost:4248 -D</span><br></pre></td></tr></table></figure>

<p>再次注意，我们使用不同的客户端端口和集群地址，但仍指向地址为<code>nats:// localhost:4248</code>的相同种子服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[75764] 2016/04/26 15:19:11.528185 [INF] Listening for route connections on localhost:6248</span><br><span class="line">[75764] 2016/04/26 15:19:11.529787 [INF] Listening for client connections on 0.0.0.0:6222</span><br><span class="line">[75764] 2016/04/26 15:19:11.529829 [DBG] server id is IRepas80TBwJByULX1ulAp</span><br><span class="line">[75764] 2016/04/26 15:19:11.529842 [INF] server is ready</span><br><span class="line">[75764] 2016/04/26 15:19:11.529872 [DBG] Trying to connect to route on localhost:4248</span><br><span class="line">[75764] 2016/04/26 15:19:11.530272 [DBG] 127.0.0.1:4248 - rid:1 - Route connection created</span><br><span class="line">[75764] 2016/04/26 15:19:11.530281 [DBG] 127.0.0.1:4248 - rid:1 - Route connect msg sent</span><br><span class="line">[75764] 2016/04/26 15:19:11.530408 [DBG] 127.0.0.1:4248 - rid:1 - Registering remote route "xZfu3u7usAPWkuThomoGzM"</span><br><span class="line">[75764] 2016/04/26 15:19:11.530414 [DBG] 127.0.0.1:4248 - rid:1 - Route sent local subscriptions</span><br><span class="line">[75764] 2016/04/26 15:19:11.530595 [DBG] 127.0.0.1:52727 - rid:2 - Route connection created</span><br><span class="line">[75764] 2016/04/26 15:19:11.530659 [DBG] 127.0.0.1:52727 - rid:2 - Registering remote route "53Yi78q96t52QdyyWLKIyE"</span><br><span class="line">[75764] 2016/04/26 15:19:11.530664 [DBG] 127.0.0.1:52727 - rid:2 - Route sent local subscriptions</span><br></pre></td></tr></table></figure>

<p>首先，为种子服务器（… GzM）创建一个路由，然后，接受来自… IyE的路由 - 这是第二个服务器的ID。</p>
<p>种子服务器的日志显示它接受了来自第三台服务器的路由：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[75653] 2016/04/26 15:19:11.530308 [DBG] 127.0.0.1:52726 - rid:2 - Route connection created</span><br><span class="line">[75653] 2016/04/26 15:19:11.530384 [DBG] 127.0.0.1:52726 - rid:2 - Registering remote route "IRepas80TBwJByULX1ulAp"</span><br><span class="line">[75653] 2016/04/26 15:19:11.530389 [DBG] 127.0.0.1:52726 - rid:2 - Route sent local subscriptions</span><br></pre></td></tr></table></figure>

<p>并且来自第二台服务器的日志显示它连接到第三台服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[75665] 2016/04/26 15:19:11.530469 [DBG] Trying to connect to route on 127.0.0.1:6248</span><br><span class="line">[75665] 2016/04/26 15:19:11.530565 [DBG] 127.0.0.1:6248 - rid:2 - Route connection created</span><br><span class="line">[75665] 2016/04/26 15:19:11.530570 [DBG] 127.0.0.1:6248 - rid:2 - Route connect msg sent</span><br><span class="line">[75665] 2016/04/26 15:19:11.530644 [DBG] 127.0.0.1:6248 - rid:2 - Registering remote route "IRepas80TBwJByULX1ulAp"</span><br><span class="line">[75665] 2016/04/26 15:19:11.530650 [DBG] 127.0.0.1:6248 - rid:2 - Route sent local subscriptions</span><br></pre></td></tr></table></figure>

<p>此时，有一个完整的网状NATS服务器集群。<br><strong>测试群集</strong></p>
<p>现在，以下应该工作：订阅节点A然后发布到节点C.您应该能够毫无问题地接收消息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nats-sub -s "nats://192.168.59.103:7222" hello &amp;</span><br><span class="line"></span><br><span class="line">nats-pub -s "nats://192.168.59.105:7222" hello world</span><br><span class="line"></span><br><span class="line"><span class="meta">[#</span><span class="bash">1] Received on [hello] : <span class="string">'world'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GNATSD on Node C logs:</span></span><br><span class="line">[1] 2015/06/23 05:20:31.100032 [TRC] 192.168.59.103:7244 - rid:2 - &lt;&lt;- [MSG hello RSID:8:2 5]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GNATSD on Node A logs:</span></span><br><span class="line">[1] 2015/06/23 05:20:31.100600 [TRC] 10.0.2.2:51007 - cid:8 - &lt;&lt;- [MSG hello 2 5]</span><br></pre></td></tr></table></figure>

<h2 id="容器化NATS服务器"><a href="#容器化NATS服务器" class="headerlink" title="容器化NATS服务器"></a>容器化NATS服务器</h2><p>NATS服务器作为Docker Hub上的Docker镜像提供，您可以使用Docker守护程序运行。 NATS服务器Docker镜像非常轻巧，大小不到10 MB。</p>
<p>Synadia积极维护和支持NATS服务器Docker镜像。<br>用法</p>
<p>要使用Docker容器映像，请安装Docker并拉出公共映像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nats</span><br></pre></td></tr></table></figure>

<p>运行NATS服务器镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nats-main nats</span><br></pre></td></tr></table></figure>

<p>默认情况下，NATS服务器公开多个端口：</p>
<ul>
<li>4222 is for clients.</li>
<li>8222 is an HTTP management port for information reporting.</li>
<li>6222 is a routing port for clustering.</li>
<li>Use -p or -P to customize.</li>
</ul>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -d --name nats-main nats</span></span><br><span class="line">[INF] Starting nats-server version 0.6.6</span><br><span class="line">[INF] Starting http monitor on port 8222</span><br><span class="line">[INF] Listening for route connections on 0.0.0.0:6222</span><br><span class="line">[INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[INF] nats-server is ready</span><br></pre></td></tr></table></figure>

<p>要与主机上公开的端口一起运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 4222：4222 -p 6222：6222 -p 8222：8222 --name nats-main nats</span><br></pre></td></tr></table></figure>

<p>要运行第二台服务器并将它们聚集在一起：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name = nats-2 --link nats-main nats --routes = nats-route：// ruser：T0pS3cr3t @ nats-main：6222</span><br></pre></td></tr></table></figure>

<p>注意由于Docker镜像使用凭据保护路由，我们需要在上面提供它们。从<a href="https://github.com/nats-io/nats-docker/blob/master/amd64/nats-server.conf#L16-L20" target="_blank" rel="noopener">Docker镜像配置中提取</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Routes are protected, so need to use them with --routes flag</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> e.g. --routes=nats-route://ruser:T0pS3cr3t@otherdockerhost:6222</span></span><br><span class="line">authorization &#123;</span><br><span class="line">  user: ruser</span><br><span class="line">  password: T0pS3cr3t</span><br><span class="line">  timeout: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要验证路由是否已连接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -d --name=nats-2 --link nats-main nats --routes=nats-route://ruser:T0pS3cr3t@nats-main:6222 -DV</span></span><br><span class="line">[INF] Starting nats-server version 0.6.6</span><br><span class="line">[INF] Starting http monitor on port 8222</span><br><span class="line">[INF] Listening for route connections on :6222</span><br><span class="line">[INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[INF] nats-server is ready</span><br><span class="line">[DBG] Trying to connect to route on nats-main:6222</span><br><span class="line">[DBG] 172.17.0.52:6222 - rid:1 - Route connection created</span><br><span class="line">[DBG] 172.17.0.52:6222 - rid:1 - Route connect msg sent</span><br><span class="line">[DBG] 172.17.0.52:6222 - rid:1 - Registering remote route "ee35d227433a738c729f9422a59667bb"</span><br><span class="line">[DBG] 172.17.0.52:6222 - rid:1 - Route sent local subscriptions</span><br></pre></td></tr></table></figure>

<h3 id="使用Docker进行群集"><a href="#使用Docker进行群集" class="headerlink" title="使用Docker进行群集"></a>使用Docker进行群集</h3><p>下面是一些如何使用Docker设置nats-server集群的示例。我们在名为conf的文件夹下放置了3种不同的配置（每个nats-server服务器一个），如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|-- conf</span><br><span class="line">    |-- nats-server-A.conf</span><br><span class="line">    |-- nats-server-B.conf</span><br><span class="line">    |-- nats-server-C.conf</span><br></pre></td></tr></table></figure>

<p>这些文件中的每一个都具有以下内容:(这里我使用ip 192.168.59.103作为示例，所以只需用服务器中的正确ip替换）<br><strong>示例1：在预先配置的3个不同服务器上设置集群</strong></p>
<p>在此示例中，三个服务器使用了解其他服务器的配置文件启动。<br><strong>NATS服务器-A</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Cluster Server A</span></span><br><span class="line"></span><br><span class="line">port: 7222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  host: '0.0.0.0'</span><br><span class="line">  port: 7244</span><br><span class="line"></span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://192.168.59.103:7246</span><br><span class="line">    nats-route://192.168.59.103:7248</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>NATS服务器-B</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Cluster Server B</span></span><br><span class="line"></span><br><span class="line">port: 8222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  host: '0.0.0.0'</span><br><span class="line">  port: 7246</span><br><span class="line"></span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://192.168.59.103:7244</span><br><span class="line">    nats-route://192.168.59.103:7248</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>NATS服务器-C</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Cluster Server C</span></span><br><span class="line"></span><br><span class="line">port: 9222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  host: '0.0.0.0'</span><br><span class="line">  port: 7248</span><br><span class="line"></span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://192.168.59.103:7244</span><br><span class="line">    nats-route://192.168.59.103:7246</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要启动容器，在每台服务器上，您应该能够按如下方式启动nats-server映像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 0.0.0.0:7222:7222 -p 0.0.0.0:7244:7244 --rm -v $(pwd)/conf/nats-server-A.conf:/tmp/cluster.conf nats -c /tmp/cluster.conf -p 7222 -D -V</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 0.0.0.0:8222:8222 -p 0.0.0.0:7246:7246 --rm -v $（pwd）/conf/nats-server-B.conf:/tmp/cluster.conf nats - c /tmp/cluster.conf -p 8222 -D -V</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 0.0.0.0:9222:9222 -p 0.0.0.0:7248:7248 --rm -v $（pwd）/conf/nats-server-C.conf:/tmp/cluster.conf nats - c /tmp/cluster.conf -p 9222 -D -V</span><br></pre></td></tr></table></figure>

<p><strong>示例2：逐个设置nats-server集群</strong></p>
<p>在这种情况下：</p>
<ul>
<li>We bring up A and get its ip (nats-route://192.168.59.103:7244)</li>
<li>Then create B and then use address of A in its configuration.</li>
<li>Get the address of B nats-route://192.168.59.104:7246 and create C and use the addresses of A and B.</li>
</ul>
<p>首先，我们创建节点A并使用以下配置启动nats-server服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Cluster Server A</span></span><br><span class="line"></span><br><span class="line">port: 4222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  host: '0.0.0.0'</span><br><span class="line">  port: 7244</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 0.0.0.0:4222:4222 -p 0.0.0.0:7244:7244 --rm -v $(pwd)/conf/nats-server-A.conf:/tmp/cluster.conf nats -c /tmp/cluster.conf -p 4222 -D -V</span><br></pre></td></tr></table></figure>

<p>然后我们继续创建下一个节点。我们意识到第一个节点的ip：port为192.168.59.103:7244，所以我们将它添加到routes配置中，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Cluster Server B</span></span><br><span class="line"></span><br><span class="line">port: 4222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  host: '0.0.0.0'</span><br><span class="line">  port: 7244</span><br><span class="line"></span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://192.168.59.103:7244</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后启动服务器B：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 0.0.0.0:4222:4222 -p 0.0.0.0:7244:7244 --rm -v $(pwd)/conf/nats-server-B.conf:/tmp/cluster.conf nats -c /tmp/cluster.conf -p 4222 -D -V</span><br></pre></td></tr></table></figure>

<p>最后，我们创建另一个Node C.我们现在知道A和B的路由，以便我们可以将其添加到其配置中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Cluster Server C</span></span><br><span class="line"></span><br><span class="line">port: 4222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  host: '0.0.0.0'</span><br><span class="line">  port: 7244</span><br><span class="line"></span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://192.168.59.103:7244</span><br><span class="line">    nats-route://192.168.59.104:7244</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>港口：4222</p>
<p>集群{<br>  主持人：’0.0.0.0’<br>  港口：7244</p>
<p>  路线= [<br>    NATS路线：//192.168.59.103：7244<br>    NATS路线：//192.168.59.104：7244<br>  ]<br>}</p>
<p>然后开始吧：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 0.0.0.0:4222:4222 -p 0.0.0.0:7244:7244 --rm -v $(pwd)/conf/nats-server-C.conf:/tmp/cluster.conf nats -c /tmp/cluster.conf -p 9222 -D -V</span><br></pre></td></tr></table></figure>

<p><strong>测试集群</strong></p>
<p>现在，以下应该工作：订阅节点A然后发布到节点C.您应该能够毫无问题地接收消息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nats-sub -s "nats://192.168.59.103:7222" hello &amp;</span><br><span class="line"></span><br><span class="line">nats-pub -s "nats://192.168.59.105:7222" hello world</span><br><span class="line"></span><br><span class="line"><span class="meta">[#</span><span class="bash">1] Received on [hello] : <span class="string">'world'</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GNATSD on Node C logs:</span></span><br><span class="line">[1] 2015/06/23 05:20:31.100032 [TRC] 192.168.59.103:7244 - rid:2 - &lt;&lt;- [MSG hello RSID:8:2 5]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GNATSD on Node A logs:</span></span><br><span class="line">[1] 2015/06/23 05:20:31.100600 [TRC] 10.0.2.2:51007 - cid:8 - &lt;&lt;- [MSG hello 2 5]</span><br></pre></td></tr></table></figure>

<p>nats-pub -s“nats：//192.168.59.105：7222”你好世界</p>
<p>[＃1]收到[你好]：’世界’</p>
<p>节点C日志上的#GNATSD：<br>[1] 2015/06/23 05：20：31.100032 [TRC] 192.168.59.103:7244 - rid：2 - &lt;&lt; - [MSG hello RSID：8：2 5]</p>
<p>节点A日志上的#GNATSD：<br>[1] 2015/06/23 05：20：31.100600 [TRC] 10.0.2.2:51007 - cid：8 - &lt;&lt; - [MSG你好2 5]</p>
<h3 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h3><p>有关使用NATS服务器Docker镜像的更多说明，请参阅<a href="https://www.nats.io/documentation/additional_documentation/nats-server-docker/" target="_blank" rel="noopener">NATS Docker教程</a>。</p>
<h2 id="NATS服务器日志记录"><a href="#NATS服务器日志记录" class="headerlink" title="NATS服务器日志记录"></a>NATS服务器日志记录</h2><p>NATS服务器提供各种日志记录选项，您可以通过命令行或配置文件设置这些选项。</p>
<h3 id="配置日志记录"><a href="#配置日志记录" class="headerlink" title="配置日志记录"></a>配置日志记录</h3><p><strong>命令行选项</strong></p>
<p>支持以下日志记录操作：</p>
<ul>
<li>-l， –log FILE 指定日志输出的文件</li>
<li>-T， –logtime 是否开启日志的时间戳（默认为true）</li>
<li>-s， –syslog 启用syslog作为日志方法</li>
<li>-r， –remote_syslog 远程日志服务器的地址（默认为udp://localhost:514）</li>
<li>-D， –debug 开启调试输出</li>
<li>-V, –trace 跟踪原始的协议</li>
<li>-DV 调试并跟踪</li>
</ul>
<p><strong>调试和跟踪</strong></p>
<p>-DV标志启用服务器的跟踪和调试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -DV -m 8222 -user foo -pass bar</span><br></pre></td></tr></table></figure>

<p><strong>日志文件重定向</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -DV -m 8222 -l nats.log</span><br></pre></td></tr></table></figure>

<p><strong>时间戳</strong></p>
<p>如果<code>-T false</code>，则日志条目不带时间戳。默认为true。<br><strong>系统日志</strong></p>
<p>您可以使用UDP配置syslog：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -s udp://localhost:514</span><br></pre></td></tr></table></figure>

<p>或者系统日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-server -r syslog://&lt;hostname&gt;:&lt;port&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syslog://logs.papertrailapp.com:26900</span><br></pre></td></tr></table></figure>

<p><strong>使用配置文件</strong></p>
<p>所有这些设置也可在配置文件中使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">debug:   false</span><br><span class="line">trace:   true</span><br><span class="line">logtime: false</span><br><span class="line">log_file: "/tmp/nats-server.log"</span><br></pre></td></tr></table></figure>

<h3 id="使用logrotate记录旋转"><a href="#使用logrotate记录旋转" class="headerlink" title="使用logrotate记录旋转"></a>使用logrotate记录旋转</h3><p>NATS服务器不提供管理日志文件的工具，但它确实包含使日志轮换简单的机制。我们可以使用logrotate这个机制;一个简单的标准Linux实用程序，用于旋转大多数发行版上可用的日志，如Debian，Ubuntu，RedHat（CentOS）等。</p>
<p>例如，您可以使用以下命令配置<code>logrotate</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/path/to/nats-server.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 30</span><br><span class="line">    compress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    postrotate</span><br><span class="line">        kill -SIGUSR1 `cat /var/run/nats-server.pid`</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行指定后续行将应用于的位置。</p>
<p>文件的其余部分指定日志将每天轮换（“每日”选项），并保留30个旧版本（“旋转”选项）。其他选项在logrorate文档中描述。</p>
<p>“<code>postrotate</code>”部分告诉NATS服务器在轮换完成后重新加载日志文件。命令kill -SIGUSR1<code>cat / var / run / nats-server.pid</code>不会终止NATS服务器进程，而是向其发送一个信号，使其重新加载其日志文件。这将导致将新请求记录到刷新的日志文件中。</p>
<p><code>/var/run/nats-server.pid</code>文件是NATS服务器存储主进程的pid的位置。</p>
<h3 id="一些记录笔记"><a href="#一些记录笔记" class="headerlink" title="一些记录笔记"></a>一些记录笔记</h3><ul>
<li>详细模式下的NATS服务器将记录UNSUB消息的接收，但这并不表示订阅已消失，仅表示已收到消息。日志中的DELSUB消息可用于确定何时删除实际的订阅。</li>
</ul>
<h2 id="监控NATS服务器"><a href="#监控NATS服务器" class="headerlink" title="监控NATS服务器"></a>监控NATS服务器</h2><p>为了监视NATS消息传递系统，gnatsd在专用监视端口上提供轻量级HTTP服务器。监视服务器提供多个端点，包括varz，connz，routez和subsz。所有端点都返回一个JSON对象。</p>
<p>NATS监控端点支持JSONP和CORS，可以轻松创建单页面监控Web应用程序。</p>
<h3 id="启用监控"><a href="#启用监控" class="headerlink" title="启用监控"></a>启用监控</h3><p>要启用监视服务器，请使用监视标志-m和监视端口启动NATS服务器，或在配置文件中将其打开。</p>
<ul>
<li>-m， - http_port PORT HTTP PORT用于监视</li>
<li>-ms， - https_port PORT使用HTTPS PORT进行监控</li>
</ul>
<p>例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gnatsd -m 8222</span></span><br><span class="line">[4528] 2015/08/19 20:09:58.572939 [INF] Starting gnatsd version 0.8.0</span><br><span class="line">[4528] 2015/08/19 20:09:58.573007 [INF] Starting http monitor on port 8222</span><br><span class="line">[4528] 2015/08/19 20:09:58.573071 [INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[4528] 2015/08/19 20:09:58.573090 [INF] gnatsd is ready&lt;/td&gt;</span><br></pre></td></tr></table></figure>

<p>要测试，请运行<code>gnatsd -m 8222</code>，然后转到<code>http://localhost:8222/</code></p>
<h3 id="监控端点"><a href="#监控端点" class="headerlink" title="监控端点"></a>监控端点</h3><p>以下部分描述了每个受支持的监控端点：varz，connz，routez和subsz。<br><strong>/varz</strong></p>
<p>端点<code>http://localhost:8222/varz</code>报告各种常规统计信息。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"server_id"</span>: <span class="string">"ec933edcd2bd86bcf71d555fc8b4fb2c"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.6.6"</span>,</span><br><span class="line">  <span class="attr">"go"</span>: <span class="string">"go1.5.0"</span>,</span><br><span class="line">  <span class="attr">"host"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">  <span class="attr">"port"</span>: <span class="number">4222</span>,</span><br><span class="line">  <span class="attr">"auth_required"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"ssl_required"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"max_payload"</span>: <span class="number">1048576</span>,</span><br><span class="line">  <span class="attr">"max_connections"</span>: <span class="number">65536</span>,</span><br><span class="line">  <span class="attr">"ping_interval"</span>: <span class="number">120000000000</span>,</span><br><span class="line">  <span class="attr">"ping_max"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"http_port"</span>: <span class="number">8222</span>,</span><br><span class="line">  <span class="attr">"ssl_timeout"</span>: <span class="number">0.5</span>,</span><br><span class="line">  <span class="attr">"max_control_line"</span>: <span class="number">1024</span>,</span><br><span class="line">  <span class="attr">"start"</span>: <span class="string">"2015-07-14T13:29:26.426805508-07:00"</span>,</span><br><span class="line">  <span class="attr">"now"</span>: <span class="string">"2015-07-14T13:30:59.349179963-07:00"</span>,</span><br><span class="line">  <span class="attr">"uptime"</span>: <span class="string">"1m33s"</span>,</span><br><span class="line">  <span class="attr">"mem"</span>: <span class="number">8445952</span>,</span><br><span class="line">  <span class="attr">"cores"</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">"cpu"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"connections"</span>: <span class="number">39</span>,</span><br><span class="line">  <span class="attr">"routes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"remotes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"in_msgs"</span>: <span class="number">100000</span>,</span><br><span class="line">  <span class="attr">"out_msgs"</span>: <span class="number">100000</span>,</span><br><span class="line">  <span class="attr">"in_bytes"</span>: <span class="number">1600000</span>,</span><br><span class="line">  <span class="attr">"out_bytes"</span>: <span class="number">1600000</span>,</span><br><span class="line">  <span class="attr">"slow_consumers"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>/connz</strong></p>
<p>端点<code>http://localhost:8222/connz</code>报告有关当前连接的更多详细信息。它使用分页机制，默认为1024个连接。</p>
<p>您可以通过URL参数（限制和偏移）控制这些。例如：<code>http://localhost：8222/connzlimit=1＆offset=1</code>。</p>
<p>您还可以使用subs = 1报告基于每个连接的详细订阅信息。例如：<code>http:// localhost:8222/connz?limit=1＆offset=1＆subs=1</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "now": "2015-07-14T13:30:59.349179963-07:00",</span><br><span class="line">  "num_connections": 2,</span><br><span class="line">  "offset": 0,</span><br><span class="line">  "limit": 1024,</span><br><span class="line">  "connections": [</span><br><span class="line">    &#123;</span><br><span class="line">      "cid": 571,</span><br><span class="line">      "ip": "127.0.0.1",</span><br><span class="line">      "port": 61572,</span><br><span class="line">      "pending_size": 0,</span><br><span class="line">      "in_msgs": 0,</span><br><span class="line">      "out_msgs": 0,</span><br><span class="line">      "in_bytes": 0,</span><br><span class="line">      "out_bytes": 0,</span><br><span class="line">      "subscriptions": 1,</span><br><span class="line">      "lang": "go",</span><br><span class="line">      "version": "1.0.9",</span><br><span class="line">      "subscriptions_list": [</span><br><span class="line">        "hello.world"</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "cid": 574,</span><br><span class="line">      "ip": "127.0.0.1",</span><br><span class="line">      "port": 61577,</span><br><span class="line">      "pending_size": 0,</span><br><span class="line">      "in_msgs": 0,</span><br><span class="line">      "out_msgs": 0,</span><br><span class="line">      "in_bytes": 0,</span><br><span class="line">      "out_bytes": 0,</span><br><span class="line">      "subscriptions": 1,</span><br><span class="line">      "lang": "ruby",</span><br><span class="line">      "version": "0.5.0",</span><br><span class="line">      "subscriptions_list": [</span><br><span class="line">        "hello.world"</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>/routez</strong></p>
<p>端点<code>http://localhost:8222/routez</code>报告有关群集的活动路由的信息。路由预计很低，因此该端点没有分页机制。</p>
<p>routez端点确实支持/ connz端点的subs参数。例如：<code>http://localhost:8222/routez?subs=1</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"now"</span>: <span class="string">"2015-07-14T13:30:59.349179963-07:00"</span>,</span><br><span class="line">  <span class="attr">"num_routes"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"routes"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"rid"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"remote_id"</span>: <span class="string">"de475c0041418afc799bccf0fdd61b47"</span>,</span><br><span class="line">      <span class="attr">"did_solicit"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"ip"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="attr">"port"</span>: <span class="number">61791</span>,</span><br><span class="line">      <span class="attr">"pending_size"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"in_msgs"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"out_msgs"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"in_bytes"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"out_bytes"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"subscriptions"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>/subsz</strong></p>
<p>端点<code>http://localhost:8222/subz</code>报告有关当前订阅和路由数据结构的详细信息。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"num_subscriptions"</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">"num_cache"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"num_inserts"</span>: <span class="number">572</span>,</span><br><span class="line">  <span class="attr">"num_removes"</span>: <span class="number">569</span>,</span><br><span class="line">  <span class="attr">"num_matches"</span>: <span class="number">200000</span>,</span><br><span class="line">  <span class="attr">"cache_hit_rate"</span>: <span class="number">0.99999</span>,</span><br><span class="line">  <span class="attr">"max_fanout"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"avg_fanout"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"stats_time"</span>: <span class="string">"2015-07-14T12:55:25.564818051-07:00"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="创建监控应用程序"><a href="#创建监控应用程序" class="headerlink" title="创建监控应用程序"></a>创建监控应用程序</h3><p>NATS监控端点支持JSONP和CORS。您可以轻松创建单页Web应用程序以进行监视。为此，您只需将回调查询参数传递给任何端点。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8222/connz?callback=cb</span><br></pre></td></tr></table></figure>

<p>这是一个JQuery示例实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$.getJSON(<span class="string">'http://localhost:8222/connz?callback=?'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="跟踪NATS统计信息"><a href="#跟踪NATS统计信息" class="headerlink" title="跟踪NATS统计信息"></a>跟踪NATS统计信息</h2><p>nats-top是一种用于监控nats-server服务器的顶级工具。</p>
<p>nats-top工具提供NATS服务器的动态实时视图。 nats-top可以实时显示有关NATS服务器的各种系统摘要信息，例如订阅，待处理字节，消息数等。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nats-top</span><br><span class="line"></span><br><span class="line">nats-server version 0.6.4 (uptime: 31m42s)</span><br><span class="line">Server:</span><br><span class="line">  Load: CPU: 0.8%   Memory: 5.9M  Slow Consumers: 0</span><br><span class="line">  In:   Msgs: 34.2K  Bytes: 3.0M  Msgs/Sec: 37.9  Bytes/Sec: 3389.7</span><br><span class="line">  Out:  Msgs: 68.3K  Bytes: 6.0M  Msgs/Sec: 75.8  Bytes/Sec: 6779.4</span><br><span class="line"></span><br><span class="line">Connections: 4</span><br><span class="line">  HOST                 CID      SUBS    PENDING     MSGS_TO     MSGS_FROM   BYTES_TO    BYTES_FROM  LANG     VERSION SUBSCRIPTIONS</span><br><span class="line">  127.0.0.1:56134      2        5       0           11.6K       11.6K       1.1M        905.1K      go       1.1.0   foo, hello</span><br><span class="line">  127.0.1.1:56138      3        1       0           34.2K       0           3.0M        0           go       1.1.0    _INBOX.a96f3f6853616154d23d1b5072</span><br><span class="line">  127.0.0.1:56144      4        5       0           11.2K       11.1K       873.5K      1.1M        go       1.1.0   foo, hello</span><br><span class="line">  127.0.0.1:56151      5        8       0           11.4K       11.5K       1014.6K     1.0M        go       1.1.0   foo, hello</span><br></pre></td></tr></table></figure>



<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>可以使用go get安装nats-top。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/nats-io/nats-top</span><br></pre></td></tr></table></figure>

<p>注意：您可能必须以用户sudo身份运行上述命令，具体取决于您的设置。如果你收到一个你无法安装nats-top的错误，因为你的$ GOPATH没有设置，实际上已经设置了，请使用命令<code>sudo -E go get github.com/nats-io/nats-top</code>来安装nats-top 。 -E标志告诉sudo保留当前用户的环境。</p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>安装完成后，可以使用命令nats-top和optional参数运行nats-top。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nats-top [-s server] [-m monitor] [-n num_connections] [-d delay_in_secs] [-sort by]</span><br></pre></td></tr></table></figure>

<h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><p>可选参数包括以下内容：</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>-m monitor</code></td>
<td>监视nats-server的http端口</td>
</tr>
<tr>
<td><code>-n num_connections</code></td>
<td>限制请求与服务器的连接（默认为1024）</td>
</tr>
<tr>
<td><code>-d delay_in_secs</code></td>
<td>屏幕刷新间隔（默认为1秒）</td>
</tr>
<tr>
<td><code>-sort by</code></td>
<td>Field用于排序连接</td>
</tr>
</tbody></table>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><p>在nats-top视图中，您可以使用以下命令。<br><strong>选项</strong></p>
<p>使用o <option>命令将主排序键设置为<option>值。选项值可以是以下之一：cid，subs，pending，msgs_to，msgs_from，bytes_to，bytes_from，lang，version。</p>
<p>您还可以使用-sort标志在命令行上设置排序选项。例如：nats-top -sort bytes_to。<br><strong>limit</strong></p>
<p>使用<code>n &lt;limit&gt;</code>命令设置要从服务器请求的连接的样本大小。</p>
<p>您也可以使用<code>-n num_connections</code>标志在命令行上设置它。例如：<code>nats-top -n 1</code>。</p>
<p>请注意，如果<code>n &lt;limit&gt;</code>与<code>-sort</code>一起使用，则服务器将遵循允许查询的两个选项，例如：查询具有最大订阅数的连接：<code>nats-top -n 1 -sort subs</code>。<br><strong>s，？和q命令</strong></p>
<p>使用<code>s</code>命令切换显示连接订阅。</p>
<p>使用<code>?</code>命令显示带有选项的帮助消息。</p>
<p>使用<code>q</code>命令退出<code>nats-top</code>。<br><strong>教程</strong></p>
<p>有关nats-top的演练，请查看<a href="https://www.nats.io/documentation/additional_documentation/nats-top" target="_blank" rel="noopener">教程</a>。</p>
<h2 id="消费者缓慢"><a href="#消费者缓慢" class="headerlink" title="消费者缓慢"></a>消费者缓慢</h2><p>为了支持弹性和高可用性，NATS提供了内置机制来自动修剪用于跟踪订阅者的注册侦听器兴趣图，包括缓慢的消费者和懒惰的侦听器。 NATS自动处理缓慢的消费者。如果客户端没有足够快地处理消息，则NATS服务器会将其关闭。为了支持扩展，NATS提供了对客户端连接的自动修剪。如果订户在乒乓间隔内没有响应来自服务器的ping请求，则客户端被切断（断开连接）。客户端需要重新连接逻辑才能与服务器重新连接。</p>
<h3 id="消费者缓慢-1"><a href="#消费者缓慢-1" class="headerlink" title="消费者缓慢"></a>消费者缓慢</h3><p>在核心NATS中，无法跟上的消费者与许多其他消息系统的处理方式不同：NATS倾向于保护整个系统而不是容纳特定消费者以确保消息传递。</p>
<h4 id="什么是慢消费者？"><a href="#什么是慢消费者？" class="headerlink" title="什么是慢消费者？"></a>什么是慢消费者？</h4><p>慢速消费者是无法跟上从NATS服务器传递的消息流的订户。这是分布式系统中的常见情况，因为生成数据通常比处理数据更容易。当消费者无法足够快地处理数据时，背压将应用于系统的其余部分。 NATS有减少这种背压的机制。</p>
<p>NATS识别客户端或服务器中的慢速消费者，通过服务器监控端点中的已注册回调，日志消息和统计信息提供通知。</p>
<h4 id="慢消费者会怎么样？"><a href="#慢消费者会怎么样？" class="headerlink" title="慢消费者会怎么样？"></a>慢消费者会怎么样？</h4><p>当在客户端检测到时，通知应用程序并丢弃消息以允许消费者继续并减少潜在的背压。在服务器中检测到时，服务器将断开与慢速消费者的连接以保护自身和消息传递系统的完整性。</p>
<h4 id="客户中发现的消费者缓慢"><a href="#客户中发现的消费者缓慢" class="headerlink" title="客户中发现的消费者缓慢"></a>客户中发现的消费者缓慢</h4><p>客户端可以检测到它是本地连接上的慢使用者，并通过使用异步错误回调通知应用程序。最好在客户端本地捕获慢速消费者，而不是让服务器检测到这种情况。此示例演示如何定义和注册将处理缓慢的使用者错误的异步错误处理程序。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">natsErrHandler</span><span class="params">(nc *nats.Conn, sub *nats.Subscription, natsErr error)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"error: %v\n"</span>, natsErr)</span><br><span class="line">	<span class="keyword">if</span> natsErr == nats.ErrSlowConsumer &#123;</span><br><span class="line">		pendingMsgs, _, err := sub.Pending()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"couldn't get pending messages: %v"</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Printf(<span class="string">"Falling behind with %d pending messages on subject %q.\n"</span>,</span><br><span class="line">			pendingMsgs, sub.Subject)</span><br><span class="line">		<span class="comment">// Log error, notify operations...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check for other errors</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the error handler when creating a connection.</span></span><br><span class="line">nc, err := nats.Connect(<span class="string">"nats://localhost:4222"</span>,</span><br><span class="line">  nats.ErrorHandler(natsErrHandler))</span><br></pre></td></tr></table></figure>

<p>//在创建连接时设置错误处理程序。<br>nc，err：= nats.Connect（“nats：// localhost：4222”，<br>  nats.ErrorHandler（natsErrHandler））</p>
<p>使用此示例代码和默认设置，缓慢的使用者错误将生成如下输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">error: nats: slow consumer, messages dropped</span><br><span class="line">Falling behind with 65536 pending messages on subject "foo".</span><br></pre></td></tr></table></figure>

<p>请注意，如果您使用的是同步订阅者，则Subscription.NextMsg（timeout time.Duration）也将返回错误，指示消费者速度较慢且消息已被删除。</p>
<h4 id="服务器识别的消费者缓慢"><a href="#服务器识别的消费者缓慢" class="headerlink" title="服务器识别的消费者缓慢"></a>服务器识别的消费者缓慢</h4><p>当客户端没有足够快地处理消息时，服务器将缓冲出站连接中的消息到客户端。当发生这种情况并且服务器无法足够快地向客户端写入数据时，为了保护自身，它会将订户指定为“慢速消费者”并且可能丢弃关联的连接。</p>
<p>当服务器启动缓慢的使用者错误时，您将在服务器输出中看到以下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[54083] 2017/09/28 14:45:18.001357 [INF] ::1:63283 - cid:7 - Slow Consumer Detected</span><br></pre></td></tr></table></figure>

<p>服务器还将记录遇到的慢速消费者错误的数量，可通过slow_consumers字段中的监控varz端点获得。</p>
<h4 id="处理慢消费者"><a href="#处理慢消费者" class="headerlink" title="处理慢消费者"></a>处理慢消费者</h4><p>除了使用NATS流媒体或优化您的消费应用程序外，还有一些选项可用：缩放，计量或调整NATS到您的环境。</p>
<p><strong>扩展队列订阅者</strong></p>
<p>如果您不依赖于消息顺序，这是理想的选择。确保您的NATS订阅属于队列组，然后根据需要通过创建更多服务或应用程序实例进行扩展。对于微服务来说，这是一种很好的方法 - 微服务的每个实例都会收到一部分要处理的消息，只需添加更多服务实例即可。无需更改代码，配置更改或停机时间。</p>
<p><strong>创建可以扩展的主题名称空间</strong></p>
<p>您可以通过主题名称空间进一步分发工作，并在设计中进行一些预见。如果您需要保留消息顺序，此方法很有用。一般的想法是发布到一个深度主题命名空间，并使用通配符订阅，同时为将来自己扩展和分发工作留出空间。</p>
<p>举一个简单的例子，如果您有一个服务从位于整个城市的物联网设备接收遥测数据，您可以发布到主题名称空间，如Sensors.North，Sensors.South，Sensors.East和Sensors.West。最初，您将订阅Sensors。&gt;处理一个消费者中的所有内容。随着企业的发展和数据速率超过消费者可以处理的数量，您可以用四个消费应用程序替换单个消费者，以订阅代表较小数据段的每个主题。请注意，您的发布应用程序保持不变。</p>
<h4 id="衡量发布者"><a href="#衡量发布者" class="headerlink" title="衡量发布者"></a>衡量发布者</h4><p>不太有利的选择可能是计量发布者。有几种方法可以实现这一点，从简单地减慢发布者速度到定期发布阻止请求/回复以匹配订阅者费率的更复杂方法。</p>
<h4 id="通过配置调整NATS"><a href="#通过配置调整NATS" class="headerlink" title="通过配置调整NATS"></a>通过配置调整NATS</h4><p>可以调整NATS服务器以确定在消费者被认为是慢速之前可以缓冲多少数据，并且一些官方支持的客户端允许调整缓冲区大小。减小缓冲区大小可以让您更快地识别缓慢的消费者。除非您正在处理临时的数据突发，否则通常不建议增加缓冲区大小。通常，增加缓冲容量只会推迟缓慢的消费者问题。</p>
<h3 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h3><p>NATS服务器具有写入连接的写入期限。当超过此写入截止日期时，客户端被视为具有较慢的消费者。如果您在服务器中遇到缓慢的使用者错误，则可以增加写入期限以缓冲更多数据。</p>
<p>NATS服务器配置文件中的write_deadline配置选项将对此进行调整：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write_deadline：2s</span><br></pre></td></tr></table></figure>

<p>当您有数据突发可以容纳时，调整此参数是理想的选择。确保您不仅仅是推迟了一个缓慢的消费者错误。</p>
<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>大多数官方支持的客户端都有一个待处理消息的内部缓冲区，如果本地订阅没有赶上，它将通过异步错误回调通知您的应用程序。在本地接收错误并不一定意味着服务器已将订阅标识为慢速消费者。</p>
<p>可以通过在创建订阅后设置挂起限制来配置此缓冲区：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if err := sub.SetPendingLimits(1024*500, 1024*5000); err != nil &#123;</span><br><span class="line">  log.Fatalf("Unable to set pending limits: %v", err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认订阅者暂挂消息限制为65536，默认订阅者暂挂字节限制为65536 * 1024</p>
<p>如果客户端达到此内部限制，它将丢弃邮件并继续处理新邮件。这与NATS最多一次交付时一致。应用程序可以检测丢失的消息并从此状态恢复。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Wang YangYang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://wangyangyangisme.github.io/2019/09/27/nats-NATS-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/">http://wangyangyangisme.github.io/2019/09/27/nats-NATS-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://wangyangyangisme.github.io" target="_blank">WangYangYang</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/76bc52296bcf2e0b7a1d628106ffcd52.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/donat/fab2285fdcd13ead0a8b4a853c659d03.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/09/27/nats-NATS-Streaming/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/nats/95994a9aea31be452e66c89e68ba4a27.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">NATS Streaming</div></div></a></div><div class="next-post pull_right"><a href="/2019/09/27/mysql-MySql%E6%9F%A5%E8%AF%A2%E4%B8%8D%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/wangyangyangisme/CDN@latest/cover/mysql/9607ad2cb25982d37fccf7443bf654b4.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySql查询不区分大小写解决方案</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: true,
  verify: false,
  appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
  appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
  placeholder: '请留下你的脚印',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-cn',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Wang YangYang</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyangyangisme.github.io/">blog</a>!</div><div class="icp"><a><img class="icp-icon" src="/img/icp.png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/click_heart.js"></script><script src="/js/search/algolia.js"></script></body></html>